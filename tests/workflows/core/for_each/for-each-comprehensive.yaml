name: for-each-comprehensive
description: |
  Comprehensive test of all for_each features.

  Tests:
  - List iteration (parallel with max_parallel)
  - Dict iteration (sequential)
  - Dynamic key interpolation in bracket notation
  - continue_on_error: true/false
  - each.key, each.value, each.index access
  - Bracket notation (static and dynamic)
  - Parent metadata (count, count_failed, count_skipped, succeeded, mode)
  - Individual iteration metadata (succeeded, failed)
  - Mixed success/failure scenarios

tags: [test, for_each, comprehensive]

inputs:
  files:
    description: List input for parallel processing
    type: list
    default: ["file1.txt", "file2.txt", "missing.txt"]

  services:
    description: Dict input for sequential processing
    type: dict
    default:
      api:
        port: 8000
        enabled: true
      worker:
        port: 8001
        enabled: true
      admin:
        port: 8002
        enabled: false

  target_service:
    description: Dynamic key for testing bracket interpolation
    type: str
    default: "api"

  target_file_index:
    description: File index for dynamic access
    type: str
    default: "0"

blocks:
  # Test 1: List iteration with parallel mode, max_parallel, continue_on_error
  - id: process_files
    type: Shell
    for_each: "{{inputs.files}}"
    for_each_mode: parallel
    max_parallel: 2
    continue_on_error: true
    inputs:
      command: |
        # Simulate failure for missing.txt
        [ "{{each.value}}" = "missing.txt" ] && exit 1
        exit 0

  # Test 2: Dict iteration with sequential mode
  - id: configure_services
    type: Shell
    for_each: "{{inputs.services}}"
    for_each_mode: sequential
    continue_on_error: false
    depends_on:
      - block: process_files
        required: false
    inputs:
      command: |
        # Test each.* access and boolean evaluation
        {{each.value.enabled | lower}} || true
        exit 0

  # Test 3: Static bracket notation access
  - id: verify_static_access
    type: Shell
    depends_on:
      - block: process_files
        required: false
      - block: configure_services
        required: false
    inputs:
      command: |
        # Verify static bracket access
        {{blocks.process_files['0'].metadata.succeeded | lower}} || exit 1
        {{blocks.process_files['2'].metadata.failed | lower}} || exit 1
        {{blocks.configure_services['api'].metadata.succeeded | lower}} || exit 1

  # Test 4: Dynamic bracket notation with variable reference (no nested {{...}})
  - id: verify_dynamic_access
    type: Shell
    depends_on:
      - block: verify_static_access
        required: true
    inputs:
      command: |
        # Verify dynamic bracket access
        {{blocks.configure_services[inputs.target_service].metadata.succeeded | lower}} || exit 1
        {{blocks.process_files[inputs.target_file_index].metadata.succeeded | lower}} || exit 1

  # Test 5: Parent metadata access
  - id: verify_metadata
    type: Shell
    depends_on: [process_files, configure_services]
    inputs:
      command: |
        # Verify parent metadata is accessible
        [ {{blocks.process_files.metadata.count}} -eq 3 ] || exit 1
        [ {{blocks.configure_services.metadata.count}} -eq 3 ] || exit 1

outputs:
  files_mode:
    value: "{{blocks.process_files.metadata.mode}}"
    type: str

  files_total:
    value: "{{blocks.process_files.metadata.count}}"
    type: num

  files_failed:
    value: "{{blocks.process_files.metadata.count_failed}}"
    type: num
  
  file_0_succeeded:
    value: "{{blocks.process_files['0'].metadata.succeeded}}"
    type: bool
  
  file_1_succeeded:
    value: "{{blocks.process_files['1'].metadata.succeeded}}"
    type: bool

  file_2_failed:
    value: "{{blocks.process_files['2'].metadata.failed}}"
    type: bool

  files_count_skipped:
    value: "{{blocks.process_files.metadata.count_skipped}}"
    type: num

  files_all_succeeded:
    value: "{{blocks.process_files.metadata.succeeded}}"
    type: bool

  # Parent metadata - dict iteration
  services_total:
    value: "{{blocks.configure_services.metadata.count}}"
    type: num

  services_all_succeeded:
    value: "{{blocks.configure_services.metadata.succeeded}}"
    type: bool

  services_mode:
    value: "{{blocks.configure_services.metadata.mode}}"
    type: str

  # Verification blocks (validate static and dynamic bracket access)
  verify_static_access_succeeded:
    value: "{{blocks.verify_static_access.succeeded}}"
    type: bool

  verify_dynamic_access_succeeded:
    value: "{{blocks.verify_dynamic_access.succeeded}}"
    type: bool
