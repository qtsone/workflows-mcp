name: core-secrets-management-test
description: Comprehensive test for secrets management features
tags: [test, core, secrets]

inputs:
  base_url:
    type: str
    default: "http://127.0.0.1:55200"
    description: "Base URL for HTTP mock server"

blocks:
  # 1. Basic secret resolution in Shell
  - id: shell_basic
    type: Shell
    inputs:
      env:
        MY_SECRET: "{{secrets.TEST_SECRET}}"
      command: |
        if [ -n "$MY_SECRET" ]; then
          echo "Secret resolved"
          exit 0
        else
          echo "Secret not resolved"
          exit 1
        fi

  # 2. Secret in HTTP header
  - id: http_with_secret
    type: HttpCall
    inputs:
      url: "{{inputs.base_url}}/headers"
      method: "GET"
      headers:
        Authorization: "Bearer {{secrets.HTTP_TOKEN}}"

  # 3. Multiple secrets in one block
  - id: multiple_secrets
    type: Shell
    inputs:
      env:
        SECRET_1: "{{secrets.TEST_SECRET}}"
        SECRET_2: "{{secrets.API_KEY}}"
        SECRET_3: "{{secrets.DB_CONNECTION_STRING}}"
      command: |
        if [ -n "$SECRET_1" ] && [ -n "$SECRET_2" ] && [ -n "$SECRET_3" ]; then
          echo "Secret resolved"
          exit 0
        else
          echo "Secret not resolved"
          exit 1
        fi

  # 4. Missing secret error handling (will fail due to missing secret)
  - id: missing_secret
    type: Shell
    continue_on_error: true
    inputs:
      env:
        MISSING: "{{secrets.NONEXISTENT_SECRET}}"
      command: echo "Should fail"

  # 5. Secret in file content
  - id: create_file_with_secret
    type: CreateFile
    inputs:
      path: "{{tmp}}/secret.txt"
      content: "api_key={{secrets.API_KEY}}"
      overwrite: true

  # 6. Read file back (content will be redacted)
  - id: read_file
    type: ReadFiles
    inputs:
      base_path: "{{tmp}}"
      patterns: ["secret.txt"]
    depends_on:
      - block: create_file_with_secret
        required: false

  # 7. Verify redaction in output
  - id: verify_redaction
    type: Shell
    inputs:
      command: |
        # Check that file content contains REDACTED marker
        CONTENT="{{blocks.read_file.content}}"
        if echo "$CONTENT" | grep -q "REDACTED"; then
          echo "Redaction verified"
        else
          echo "Warning: Redaction check inconclusive"
        fi
    depends_on:
      - block: read_file
        required: false

outputs:
  # Basic resolution
  shell_basic_succeeded:
    value: "{{blocks.shell_basic.succeeded}}"
    type: bool

  # HTTP with secrets
  http_succeeded:
    value: "{{blocks.http_with_secret.succeeded}}"
    type: bool

  # Multiple secrets - detailed status
  multiple_secrets_succeeded:
    value: "{{blocks.multiple_secrets.succeeded}}"
    type: bool

  # Missing secret error
  missing_secret_failed:
    value: "{{blocks.missing_secret.failed}}"
    type: bool

  # File operations
  file_created:
    value: "{{blocks.create_file_with_secret.succeeded}}"
    type: bool

  file_read:
    value: "{{blocks.read_file.succeeded}}"
    type: bool

  # Redaction verification
  redaction_verified:
    value: "{{blocks.verify_redaction.succeeded}}"
    type: bool
