name: core-secrets-management-test
description: Comprehensive test for secrets management features
tags: [test, core, secrets]

inputs:
  base_url:
    type: str
    default: "http://127.0.0.1:55200"
    description: Base URL for HTTP mock server

blocks:
  - id: shell_basic
    description: Basic secret resolution in Shell environment variables
    type: Shell
    inputs:
      env:
        MY_SECRET: "{{secrets.TEST_SECRET}}"
      command: |
        if [ -n "$MY_SECRET" ]; then
          echo "Secret resolved successfully"
          exit 0
        else
          echo "Secret not resolved"
          exit 1
        fi

  - id: http_with_secret
    description: Secret in HTTP Authorization header
    type: HttpCall
    inputs:
      url: "{{inputs.base_url}}/headers"
      method: "GET"
      headers:
        Authorization: "Bearer {{secrets.HTTP_TOKEN}}"

  - id: multiple_secrets
    description: Multiple secrets in a single block
    type: Shell
    inputs:
      env:
        SECRET_1: "{{secrets.TEST_SECRET}}"
        SECRET_2: "{{secrets.API_KEY}}"
        SECRET_3: "{{secrets.DB_CONNECTION_STRING}}"
      command: |
        # Verify all three secrets are present
        if [ -n "$SECRET_1" ] && [ -n "$SECRET_2" ] && [ -n "$SECRET_3" ]; then
          echo "All secrets resolved"
          exit 0
        else
          echo "One or more secrets missing"
          exit 1
        fi

  - id: create_file_with_secret
    description: Secret embedded in file content
    type: CreateFile
    inputs:
      path: "{{tmp}}/config.txt"
      content: |
        # Configuration file with embedded secret
        api_key={{secrets.API_KEY}}
        db_connection={{secrets.DB_CONNECTION_STRING}}
      overwrite: true

  - id: verify_file_created
    description: Verify file was created (content contains actual secret values)
    type: ReadFiles
    inputs:
      base_path: "{{tmp}}"
      patterns: ["config.txt"]
    depends_on: [create_file_with_secret]

  - id: verify_outputs_exist
    description: Verify workflow outputs contain redacted secrets
    # Note: Redaction happens in workflow outputs, not file contents.
    # The actual file contains real secret values, but when workflow
    # outputs are returned to the client, secrets are automatically
    # replaced with ***REDACTED***
    type: Shell
    inputs:
      command: |
        # This block just confirms previous blocks succeeded
        # Redaction verification happens by examining workflow outputs
        echo "File and HTTP operations completed"
    depends_on:
      - verify_file_created
      - http_with_secret

outputs:
  shell_basic_succeeded:
    description: Basic secret resolution in Shell environment variables
    value: "{{blocks.shell_basic.succeeded}}"
    type: bool

  http_succeeded:
    description: Secret in HTTP Authorization header
    value: "{{blocks.http_with_secret.succeeded}}"
    type: bool
  multiple_secrets_succeeded:
    description: Multiple secrets in a single block
    value: "{{blocks.multiple_secrets.succeeded}}"
    type: bool
  file_created:
    description: Secret embedded in file content
    value: "{{blocks.create_file_with_secret.succeeded}}"
    type: bool

  file_verified:
    description: Verify file was created (content contains actual secret values)
    value: "{{blocks.verify_file_created.succeeded}}"
    type: bool

  outputs_verified:
    description: Verify workflow outputs contain redacted secrets
    value: "{{blocks.verify_outputs_exist.succeeded}}"
    type: bool

  http_response_body:
    description: Expose HTTP response for redaction testing
    value: "{{blocks.http_with_secret.response_body}}"
    type: str

  file_content:
    description: Expose file content for redaction testing
    value: "{{blocks.verify_file_created.files[0].content}}"
    type: str
