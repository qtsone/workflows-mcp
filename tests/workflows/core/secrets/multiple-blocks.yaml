name: secrets-multiple-blocks
description: |
  Test secret resolution across multiple block types in one workflow
  Comprehensive test of Shell, HttpCall, CreateFile, and RenderTemplate
tags: [test, core, secrets, integration]

inputs:
  path:
    type: str
    default: "/tmp/test-secrets-multiple"
    description: "Temporary workspace"

  base_url:
    type: str
    default: "https://httpbin.org"
    description: "Base URL for HTTP endpoints (no trailing slash)"

blocks:
  # Test 1: Shell block with secret
  - id: shell_with_secret
    type: Shell
    inputs:
      command: echo "Shell secret test"
      env:
        SECRET_VALUE: "{{secrets.MULTI_SECRET}}"

  # Test 2: HttpCall with secret in header (local mock echoes headers back)
  - id: http_with_secret
    type: HttpCall
    inputs:
      url: "{{inputs.base_url}}/headers"
      method: "GET"
      headers:
        X-Secret-Header: "{{secrets.MULTI_SECRET}}"
        User-Agent: "workflows-mcp-test"
      timeout: 10
    depends_on: [shell_with_secret]

  # Test 3: CreateFile with secret in content
  - id: file_with_secret
    type: CreateFile
    inputs:
      path: "{{inputs.path}}/secret.txt"
      content: |
        This file contains a secret: {{secrets.MULTI_SECRET}}
        Created by workflow
      create_parents: true
    depends_on: [http_with_secret]

  # Test 4: CreateFile with direct interpolation and secret
  - id: template_with_secret
    type: CreateFile
    inputs:
      path: "{{inputs.path}}/config.txt"
      create_parents: true
      content: |
        Configuration:
        secret = {{secrets.MULTI_SECRET}}
        timestamp = {{metadata.started_at}}
    depends_on: [file_with_secret]

  - id: cleanup
    type: Shell
    inputs:
      command: |
        # Safe cleanup with validation
        DIR="{{inputs.path}}"
        if [[ "$DIR" == /tmp/* ]] && [ -d "$DIR" ]; then
          rm -rf "$DIR"
        fi
    depends_on:
      - block: template_with_secret
        required: false

outputs:
  shell_success:
    value: "{{blocks.shell_with_secret.succeeded}}"
    type: bool
  http_success:
    value: "{{blocks.http_with_secret.succeeded}}"
    type: bool
  http_status:
    value: "{{blocks.http_with_secret.outputs.status_code}}"
    type: str
  file_success:
    value: "{{blocks.file_with_secret.succeeded}}"
    type: bool
  template_success:
    value: "{{blocks.template_with_secret.succeeded}}"
    type: bool
  all_verified:
    value: >
      {{blocks.shell_with_secret.succeeded and
      blocks.http_with_secret.succeeded and
      blocks.file_with_secret.succeeded and
      blocks.template_with_secret.succeeded}}
    type: bool
  cleanup_done:
    value: "{{blocks.cleanup.succeeded}}"
    type: bool
