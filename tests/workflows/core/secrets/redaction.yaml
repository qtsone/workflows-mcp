name: secrets-redaction
description: |
  Test comprehensive output redaction of secret values
  Verifies secrets are redacted in stdout, stderr, and file content
tags: [test, core, secrets, redaction, security]

inputs:
  path:
    type: str
    default: "/tmp/test-secrets-redaction"
    description: "Temporary workspace"

  expected_hash:
    type: str
    description: "Expected SHA256 hash of the REDACTION_TEST secret"

blocks:
  # Verify the secret value is correct by hashing it
  - id: verify_secret_value
    type: Shell
    inputs:
      command: |
        python3 -c "
        import hashlib, os
        secret = '{{secrets.REDACTION_TEST}}'
        computed_hash = hashlib.sha256(secret.encode()).hexdigest()
        expected_hash = '{{inputs.expected_hash}}'
        if computed_hash == expected_hash:
          print('Secret value verified.')
          exit(0)
        else:
          print('Secret value verification failed.')
          print(f'Expected: {expected_hash}')
          print(f'Got: {computed_hash}')
          exit(1)
        "

  # Echo secret in multiple formats (all should be redacted)
  - id: echo_secret_variations
    type: Shell
    inputs:
      command: |
        # Direct echo (should be redacted)
        echo "Direct: {{secrets.REDACTION_TEST}}"

        # In a variable (should be redacted)
        SECRET_VAR="{{secrets.REDACTION_TEST}}"
        echo "Variable: $SECRET_VAR"

        # In JSON-like output (should be redacted)
        echo '{"secret": "{{secrets.REDACTION_TEST}}"}'

        # Mixed with other text (should be redacted)
        echo "Token is: prefix-{{secrets.REDACTION_TEST}}-suffix"
    depends_on: [verify_secret_value]

  # Verify all outputs are redacted
  - id: verify_redaction
    type: Shell
    inputs:
      command: |
        # Check that stdout contains REDACTED marker
        OUTPUT="{{blocks.echo_secret_variations.outputs.stdout | trim}}"
        if echo "$OUTPUT" | grep -q "REDACTED"; then
          echo "Redaction verified"
        else
          echo "Redaction failed - secret may be exposed!"
          exit 1
        fi
    depends_on: [echo_secret_variations]

  # Test redaction in file content
  - id: create_file_with_secret
    type: CreateFile
    inputs:
      path: "{{inputs.path}}/test-redaction-secret.txt"
      content: |
        Secret value: {{secrets.REDACTION_TEST}}
        Another line
      overwrite: true
    depends_on: [verify_redaction]

  # Read file back (should be redacted)
  - id: read_secret_file
    type: ReadFiles
    inputs:
      base_path: "{{inputs.path}}"
      patterns: ["test-redaction-secret.txt"]
    depends_on: [create_file_with_secret]

  - id: cleanup
    type: Shell
    inputs:
      command: |
        # Safe cleanup with validation
        DIR="{{inputs.path}}"
        if [[ "$DIR" == /tmp/* ]] && [ -d "$DIR" ]; then
          rm -rf "$DIR"
        fi
    depends_on:
      - block: read_secret_file
        required: false

outputs:
  value_verified:
    value: "{{blocks.verify_secret_value.succeeded}}"
    type: bool
  echo_succeeded:
    value: "{{blocks.echo_secret_variations.succeeded}}"
    type: bool
  stdout_output:
    value: "{{blocks.echo_secret_variations.outputs.stdout}}"
    type: str
  file_content:
    value: "{{get(blocks.read_secret_file.outputs.files, 0, {}).content | default('Error: Failed to read file contents')}}"
    type: str
  redaction_verified:
    value: "{{blocks.verify_redaction.succeeded}}"
    type: bool
  cleanup_done:
    value: "{{blocks.cleanup.succeeded}}"
    type: bool
