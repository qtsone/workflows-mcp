name: secrets-redaction
description: |
  Test comprehensive output redaction of secret values
  Verifies secrets are redacted in stdout, stderr, and file content
tags: [test, core, secrets, redaction, security]
blocks:
  # Echo secret in multiple formats (all should be redacted)
  - id: echo_secret_variations
    type: Shell
    inputs:
      command: |
        # Direct echo (should be redacted)
        echo "Direct: {{secrets.REDACTION_TEST}}"

        # In a variable (should be redacted)
        SECRET_VAR="{{secrets.REDACTION_TEST}}"
        echo "Variable: $SECRET_VAR"

        # In JSON-like output (should be redacted)
        echo '{"secret": "{{secrets.REDACTION_TEST}}"}'

        # Mixed with other text (should be redacted)
        echo "Token is: prefix-{{secrets.REDACTION_TEST}}-suffix"
  # Verify all outputs are redacted
  - id: verify_redaction
    type: Shell
    inputs:
      command: |
        # Check that stdout contains REDACTED marker
        OUTPUT="{{blocks.echo_secret_variations.outputs.stdout}}"
        if echo "$OUTPUT" | grep -q "REDACTED"; then
          echo "Redaction verified"
        else
          echo "Redaction failed - secret may be exposed!"
          exit 1
        fi
    depends_on: [echo_secret_variations]
  # Test redaction in file content
  - id: create_file_with_secret
    type: CreateFile
    inputs:
      path: "/tmp/test-redaction-secret.txt"
      content: |
        Secret value: {{secrets.REDACTION_TEST}}
        Another line
      overwrite: true
    depends_on: [verify_redaction]
  # Read file back (should be redacted)
  - id: read_secret_file
    type: ReadFile
    inputs:
      path: "/tmp/test-redaction-secret.txt"
    depends_on: [create_file_with_secret]
  # Cleanup
  - id: cleanup
    type: Shell
    inputs:
      command: rm -f /tmp/test-redaction-secret.txt
    depends_on: [read_secret_file]
outputs:
  echo_succeeded:
    value: "{{blocks.echo_secret_variations.succeeded}}"
    type: bool
  # These outputs should all contain REDACTED markers instead of actual secret
  stdout_output:
    value: "{{blocks.echo_secret_variations.outputs.stdout}}"
    type: str
  file_content:
    value: "{{blocks.read_secret_file.outputs.content}}"
    type: str
  redaction_verified:
    value: "{{blocks.verify_redaction.succeeded}}"
    type: bool
  cleanup_done:
    value: "{{blocks.cleanup.succeeded}}"
    type: bool
