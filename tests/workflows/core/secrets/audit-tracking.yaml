name: secrets-audit-tracking
description: |
  Test secret access audit logging
  Verifies that secret access events are tracked in metadata
tags: [test, core, secrets, audit, compliance]
blocks:
  # Access multiple secrets in different blocks
  - id: access_secret_1
    type: Shell
    inputs:
      command: echo "Accessing first secret"
      env:
        SECRET_1: "{{secrets.AUDIT_SECRET_1}}"
  - id: access_secret_2
    type: Shell
    inputs:
      command: echo "Accessing second secret"
      env:
        SECRET_2: "{{secrets.AUDIT_SECRET_2}}"
    depends_on: [access_secret_1]
  - id: access_both_secrets
    type: Shell
    inputs:
      command: echo "Accessing both secrets"
      env:
        SECRET_1: "{{secrets.AUDIT_SECRET_1}}"
        SECRET_2: "{{secrets.AUDIT_SECRET_2}}"
    depends_on: [access_secret_2]
  # Verify all blocks succeeded
  - id: verify_audit_blocks
    type: Shell
    inputs:
      command: |
        # Check that all secret access blocks succeeded
        if [ "{{blocks.access_secret_1.succeeded}}" = "true" ] && \
           [ "{{blocks.access_secret_2.succeeded}}" = "true" ] && \
           [ "{{blocks.access_both_secrets.succeeded}}" = "true" ]; then
          echo "All audit blocks succeeded"
        else
          echo "Some blocks failed"
          exit 1
        fi
    depends_on: [access_both_secrets]
outputs:
  secret_1_accessed:
    value: "{{blocks.access_secret_1.succeeded}}"
    type: bool
  secret_2_accessed:
    value: "{{blocks.access_secret_2.succeeded}}"
    type: bool
  both_accessed:
    value: "{{blocks.access_both_secrets.succeeded}}"
    type: bool
  audit_verified:
    value: "{{blocks.verify_audit_blocks.succeeded}}"
    type: bool
  # Metadata should contain secret_access_count
  # (This will be visible in detailed response format)
