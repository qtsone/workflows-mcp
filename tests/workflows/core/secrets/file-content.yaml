name: secrets-file-content
description: |
  Test secret resolution in CreateFile content
  Verifies secrets are resolved when creating files
tags: [test, core, secrets, files]

inputs:
  test_dir:
    type: str
    default: "/tmp/test-secrets-file"
    description: "Directory for test files"

blocks:
  # Create file with secret in content
  - id: create_config_file
    type: CreateFile
    inputs:
      path: "{{inputs.test_dir}}/config.ini"
      content: |
        [api]
        endpoint = https://api.example.com
        api_key = {{secrets.API_KEY}}
        timeout = 30

        [database]
        connection = {{secrets.DB_CONNECTION_STRING}}
      create_parents: true
      overwrite: true

  # Read the file back (content will be redacted)
  - id: read_config_file
    type: ReadFile
    inputs:
      path: "{{inputs.test_dir}}/config.ini"
    depends_on: [create_config_file]

  # Verify file was created
  - id: verify_file_exists
    type: Shell
    inputs:
      command: test -f "{{inputs.test_dir}}/config.ini" && echo "exists"
    depends_on: [read_config_file]

  # Cleanup
  - id: cleanup
    type: Shell
    inputs:
      command: rm -rf "{{inputs.test_dir}}"
    depends_on: [verify_file_exists]

outputs:
  file_created: "{{blocks.create_config_file.succeeded}}"
  file_exists: "{{blocks.verify_file_exists.outputs.stdout}}"
  # File content will have secrets redacted
  file_content: "{{blocks.read_config_file.outputs.content}}"
  cleanup_done: "{{blocks.cleanup.succeeded}}"
