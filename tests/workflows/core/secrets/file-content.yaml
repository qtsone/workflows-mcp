name: secrets-file-content
description: |
  Test secret resolution in CreateFile content
  Verifies secrets are resolved when creating files
tags: [test, core, secrets, files]

inputs:
  path:
    type: str
    default: "/tmp/test-secrets-file"
    description: "Temporary workspace"

blocks:
  # Create file with secret in content
  - id: create_config_file
    type: CreateFile
    inputs:
      path: "{{inputs.path}}/config.ini"
      create_parents: true
      overwrite: true
      content: |
        [api]
        endpoint = https://api.example.com
        api_key = {{secrets.API_KEY}}
        timeout = 30

        [database]
        connection = {{secrets.DB_CONNECTION_STRING}}

  # Read the file back (content will be redacted)
  - id: read_config_file
    type: ReadFiles
    inputs:
      base_path: "{{inputs.path}}"
      patterns: ["config.ini"]
    depends_on: [create_config_file]

  # Verify file was created
  - id: verify_file_exists
    type: Shell
    inputs:
      working_dir: "{{inputs.path}}"
      command: test -f "config.ini" && echo "exists"
    depends_on: [read_config_file]

  - id: cleanup
    type: Shell
    inputs:
      command: |
        # Safe cleanup with validation
        DIR="{{inputs.path}}"
        if [[ "$DIR" == /tmp/* ]] && [ -d "$DIR" ]; then
          rm -rf "$DIR"
        fi
    depends_on:
      - block: verify_file_exists
        required: false

outputs:
  file_created:
    value: "{{blocks.create_config_file.succeeded}}"
    type: bool
  file_exists:
    value: "{{blocks.verify_file_exists.succeeded}}"
    type: bool
  file_content:
    value: "{{blocks.read_config_file.outputs.content}}"
    type: str
  cleanup_done:
    value: "{{blocks.cleanup.succeeded}}"
    type: bool
