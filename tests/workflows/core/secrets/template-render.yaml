name: secrets-template-render
description: |
  Test secret resolution in RenderTemplate blocks
  Verifies secrets work in Jinja2 template variables
tags: [test, core, secrets, templates]
inputs:
  test_dir:
    type: str
    default: "/tmp/test-secrets-template"
    description: "Directory for template output"
blocks:
  # Render template with secrets
  - id: render_env_template
    type: RenderTemplate
    inputs:
      template: |
        # Environment Configuration

        ## Production Settings
        API_ENDPOINT={{ api_endpoint }}
        API_KEY={{ api_key }}
        DB_HOST={{ db_host }}
        DB_PASSWORD={{ db_password }}

        ## Generated
        Timestamp: {{ timestamp }}
      variables:
        api_endpoint: "https://api.example.com"
        api_key: "{{secrets.API_KEY}}"
        db_host: "db.example.com"
        db_password: "{{secrets.DB_PASSWORD}}"
        timestamp: "{{metadata.started_at}}"
      output_path: "{{inputs.test_dir}}/.env"
      create_parents: true
  # Read the rendered file (secrets will be redacted)
  - id: read_env_file
    type: ReadFile
    inputs:
      path: "{{inputs.test_dir}}/.env"
    depends_on: [render_env_template]
  # Verify template was rendered
  - id: verify_template_rendered
    type: Shell
    inputs:
      command: |
        if [ -f "{{inputs.test_dir}}/.env" ]; then
          echo "Template rendered successfully"
        else
          echo "Template rendering failed"
          exit 1
        fi
    depends_on: [read_env_file]
  # Cleanup
  - id: cleanup
    type: Shell
    inputs:
      command: rm -rf "{{inputs.test_dir}}"
    depends_on: [verify_template_rendered]
outputs:
  template_rendered:
    value: "{{blocks.render_env_template.succeeded}}"
    type: bool
  verification_passed:
    value: "{{blocks.verify_template_rendered.succeeded}}"
    type: bool
  # File content will have secrets redacted
  env_content:
    value: "{{blocks.read_env_file.outputs.content}}"
    type: str
  cleanup_done:
    value: "{{blocks.cleanup.succeeded}}"
    type: bool
