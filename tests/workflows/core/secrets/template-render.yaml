name: secrets-template-render
description: |
  Test secret resolution in RenderTemplate blocks
  Verifies secrets work in Jinja2 template variables
tags: [test, core, secrets, templates]
inputs:
  test_dir:
    type: str
    default: "/tmp/test-secrets-template"
    description: "Directory for template output"
blocks:
  # Render template with secrets using direct interpolation
  - id: render_env_template
    type: CreateFile
    inputs:
      path: "{{inputs.test_dir}}/.env"
      create_parents: true
      content: |
        # Environment Configuration

        ## Production Settings
        API_ENDPOINT=https://api.example.com
        API_KEY={{secrets.API_KEY}}
        DB_HOST=db.example.com
        DB_PASSWORD={{secrets.DB_PASSWORD}}

        ## Generated
        Timestamp: {{metadata.started_at}}
  # Read the rendered file (secrets will be redacted)
  - id: read_env_file
    type: ReadFiles
    inputs:
      patterns: [".env"]
      base_path: "{{inputs.test_dir}}"
      mode: full
    depends_on: [render_env_template]
  # Verify template was rendered
  - id: verify_template_rendered
    type: Shell
    inputs:
      command: |
        if [ -f "{{inputs.test_dir}}/.env" ]; then
          echo "Template rendered successfully"
        else
          echo "Template rendering failed"
          exit 1
        fi
    depends_on: [read_env_file]
  # Cleanup
  - id: cleanup
    type: Shell
    inputs:
      command: rm -rf "{{inputs.test_dir}}"
    depends_on: [verify_template_rendered]
outputs:
  template_rendered:
    value: "{{blocks.render_env_template.succeeded}}"
    type: bool
  verification_passed:
    value: "{{blocks.verify_template_rendered.succeeded}}"
    type: bool
  # File content will have secrets redacted
  env_content:
    value: "{{get(blocks.read_env_file.outputs.files, 0, {}).content | default('None')}}"
    type: str
  cleanup_done:
    value: "{{blocks.cleanup.succeeded}}"
    type: bool
