name: test-git-repo-management-short-urls
description: Test git-pr-setup support for short PR URLs and GitLab logic.
tags: [test, templates]

blocks:
  - id: test_github_short
    type: Workflow
    inputs:
      workflow: git-pr-setup
      inputs:
        url: "qtsone/workflows-mcp/pull/123"
        dry_run: true

  - id: verify_github_short
    type: Shell
    depends_on: [test_github_short]
    inputs:
      command: |
        PLATFORM="{{ blocks.test_github_short.outputs.platform }}"
        REPO="{{ blocks.test_github_short.outputs.repo }}"
        PR="{{ blocks.test_github_short.outputs.pr_number }}"
        REF="{{ blocks.test_github_short.outputs.ref }}"
        REFSPEC="{{ blocks.test_github_short.outputs.fetch_refspec }}"

        echo "GH Short Results:"
        echo "Platform: $PLATFORM"
        echo "Repo: $REPO"
        echo "PR: $PR"
        echo "Ref: $REF"
        echo "Refspec: $REFSPEC"

        if [ "$PLATFORM" != "github" ]; then echo "Fail: Platform"; exit 1; fi
        if [ "$REPO" != "qtsone/workflows-mcp" ]; then echo "Fail: Repo"; exit 1; fi
        if [ "$PR" != "123" ]; then echo "Fail: PR"; exit 1; fi
        if [ "$REF" != "pr-123" ]; then echo "Fail: Ref"; exit 1; fi
        if [ "$REFSPEC" != "pull/123/head:pr-123" ]; then echo "Fail: Refspec"; exit 1; fi
        echo "GH Short OK"

  - id: test_gitlab_full
    type: Workflow
    inputs:
      workflow: git-pr-setup
      inputs:
        url: "https://gitlab.com/owner/repo/-/merge_requests/456"
        dry_run: true

  - id: verify_gitlab_full
    type: Shell
    depends_on: [test_gitlab_full]
    inputs:
      command: |
        PLATFORM="{{ blocks.test_gitlab_full.outputs.platform }}"
        REPO="{{ blocks.test_gitlab_full.outputs.repo }}"
        PR="{{ blocks.test_gitlab_full.outputs.pr_number }}"
        REF="{{ blocks.test_gitlab_full.outputs.ref }}"
        REFSPEC="{{ blocks.test_gitlab_full.outputs.fetch_refspec }}"

        echo "GL Full Results:"
        echo "Platform: $PLATFORM"
        echo "Repo: $REPO"
        echo "PR: $PR"
        echo "Ref: $REF"
        echo "Refspec: $REFSPEC"

        if [ "$PLATFORM" != "gitlab" ]; then echo "Fail: Platform"; exit 1; fi
        if [ "$REPO" != "owner/repo" ]; then echo "Fail: Repo"; exit 1; fi
        if [ "$PR" != "456" ]; then echo "Fail: PR"; exit 1; fi
        if [ "$REF" != "mr-456" ]; then echo "Fail: Ref"; exit 1; fi
        if [ "$REFSPEC" != "refs/merge-requests/456/head:mr-456" ]; then echo "Fail: Refspec"; exit 1; fi
        echo "GL Full OK"

outputs:
  github:
    type: str
    value: "{{ blocks.verify_github_short.outputs.stdout }}"

  gitlab:
    type: str
    value: "{{ blocks.verify_gitlab_full.outputs.stdout }}"
