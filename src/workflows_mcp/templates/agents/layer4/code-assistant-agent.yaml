name: code-assistant-agent
description: |
  Complete coding assistant agent with autonomous task routing.

  Layer 4 agent that:
  - Analyzes user requests
  - Routes to appropriate Layer 3 workflows
  - Coordinates multi-step tasks
  - Provides unified interface to all agent capabilities

  Supported tasks:
  - Bug investigation and fixing
  - Code review
  - Deep code investigation
  - General Q&A

  This demonstrates the full agent architecture:
  Layer 4 (this) → Layer 3 (domain) → Layer 2 (patterns) → Layer 1 (primitives) → Layer 0 (blocks)
tags:
  - agent
  - layer4
  - assistant
  - autonomous
  - complete
inputs:
  task_description:
    type: str
    description: "Natural language description of task"
    required: true
  workspace:
    type: str
    description: "Project workspace directory"
    required: false
    default: "."
  llm_profile:
    type: str
    description: "LLM profile from ~/.workflows/llm-config.yml (e.g., 'quick', 'standard', 'deep')"
    required: false
    default: "standard"
outputs:
  task_type:
    value: '{{blocks.classify_task.outputs.response_json.task_type}}'
  execution_result:
    value: '{{blocks.execute_task.succeeded ? "completed" : "failed"}}'
  summary:
    value: '{{blocks.final_summary.outputs.stdout}}'
blocks:
  # Phase 1: Classify Task - Determine what the user wants (using quick profile for classification)
  - id: classify_task
    type: LLMCall
    inputs:
      profile: quick
      prompt: |
        Analyze the following user request and classify it into a task type.

        User Request: {{inputs.task_description}}

        Available task types:
        1. "bug_investigation" - User reports a bug and wants it investigated/fixed
        2. "code_review" - User wants code review for changes (git diff, PR, etc.)
        3. "investigation" - User wants to understand how something works in the codebase
        4. "feature_implementation" - User wants to implement a new feature (requires planning)
        5. "general" - General questions or tasks that don't fit above categories

        Provide:
        - task_type: One of the above
        - confidence: How confident you are (0-1)
        - reasoning: Why you classified it this way
        - parameters: Extracted parameters for the task (if any)
      system_instructions: |
        You are a task classification expert for a coding assistant.
        Analyze user intent and route to appropriate workflows.
        Respond ONLY with valid JSON matching the schema - no markdown, no extra text.
      response_schema:
        type: object
        required: [task_type, confidence, reasoning, parameters]
        properties:
          task_type:
            type: string
            enum: [bug_investigation, code_review, investigation, feature_implementation, general]
          confidence:
            type: number
            minimum: 0
            maximum: 1
          reasoning:
            type: string
          parameters:
            type: object
            description: "Extracted parameters (e.g., file patterns, focus areas)"
            properties:
              focus_areas:
                type: string
              file_pattern:
                type: string
              bug_description:
                type: string
              investigation_topic:
                type: string
      max_retries: 3
      timeout: 30

  # Phase 2: Execute Task - Route to appropriate workflow

  # Route 2a: Bug Investigation
  - id: execute_bug_investigation
    type: Workflow
    inputs:
      workflow: bug-investigation-and-fix
      inputs:
        bug_description: '{{blocks.classify_task.outputs.response_json.parameters.bug_description ?? inputs.task_description}}'
        file_pattern: '{{blocks.classify_task.outputs.response_json.parameters.file_pattern ?? "*.py"}}'
        workspace: '{{inputs.workspace}}'
        llm_profile: '{{inputs.llm_profile}}'
        auto_fix: false
    condition: '{{blocks.classify_task.outputs.response_json.task_type}} == "bug_investigation"'
    depends_on: [classify_task]

  # Route 2b: Code Review
  - id: execute_code_review
    type: Workflow
    inputs:
      workflow: code-review-assistant
      inputs:
        diff_source: git
        git_base_branch: main
        focus_areas: '{{blocks.classify_task.outputs.response_json.parameters.focus_areas ?? "general code quality, potential bugs, and best practices"}}'
        workspace: '{{inputs.workspace}}'
        llm_profile: '{{inputs.llm_profile}}'
        run_validation: true
    condition: '{{blocks.classify_task.outputs.response_json.task_type}} == "code_review"'
    depends_on: [classify_task]

  # Route 2c: Deep Investigation
  - id: execute_investigation
    type: Workflow
    inputs:
      workflow: investigate-deeply
      inputs:
        investigation_id: 'agent-{{metadata.start_time}}'
        topic: '{{blocks.classify_task.outputs.response_json.parameters.investigation_topic ?? inputs.task_description}}'
        file_pattern: '{{blocks.classify_task.outputs.response_json.parameters.file_pattern ?? "*.py"}}'
        max_files: 10
        depth: moderate
        llm_profile: '{{inputs.llm_profile}}'
    condition: '{{blocks.classify_task.outputs.response_json.task_type}} == "investigation"'
    depends_on: [classify_task]

  # Route 2d: Feature Implementation (NEW - uses Layer 3 implementation-planner)
  - id: execute_feature_implementation
    type: Workflow
    inputs:
      workflow: implementation-planner
      inputs:
        task:
          title: '{{blocks.classify_task.outputs.response_json.parameters.feature_title ?? "Feature Implementation"}}'
          description: '{{inputs.task_description}}'
          requirements: '{{blocks.classify_task.outputs.response_json.parameters.requirements ?? "See description"}}'
          constraints: '{{blocks.classify_task.outputs.response_json.parameters.constraints ?? "None specified"}}'
        codebase_context: 'Project workspace: {{inputs.workspace}}'
        llm_profile: '{{inputs.llm_profile}}'
    condition: '{{blocks.classify_task.outputs.response_json.task_type}} == "feature_implementation"'
    depends_on: [classify_task]

  # Route 2e: General Query (using user's profile)
  - id: execute_general
    type: LLMCall
    inputs:
      profile: '{{inputs.llm_profile}}'
      prompt: '{{inputs.task_description}}'
      system_instructions: |
        You are a helpful coding assistant.
        Provide clear, concise, and accurate responses.
      timeout: 60
    condition: '{{blocks.classify_task.outputs.response_json.task_type}} == "general"'
    depends_on: [classify_task]

  # Combine execution results (at least one will have executed)
  - id: execute_task
    type: Shell
    inputs:
      command: |
        set -euo pipefail

        TASK_TYPE="{{blocks.classify_task.outputs.response_json.task_type}}"

        echo "Task type: $TASK_TYPE"

        case "$TASK_TYPE" in
          bug_investigation)
            RESULT="{{blocks.execute_bug_investigation.succeeded}}"
            ;;
          code_review)
            RESULT="{{blocks.execute_code_review.succeeded}}"
            ;;
          investigation)
            RESULT="{{blocks.execute_investigation.succeeded}}"
            ;;
          feature_implementation)
            RESULT="{{blocks.execute_feature_implementation.succeeded}}"
            ;;
          general)
            RESULT="{{blocks.execute_general.succeeded}}"
            ;;
        esac

        echo "Execution result: $RESULT"
    depends_on:
      - block: execute_bug_investigation
        required: false
      - block: execute_code_review
        required: false
      - block: execute_investigation
        required: false
      - block: execute_feature_implementation
        required: false
      - block: execute_general
        required: false

  # Phase 3: Final Summary
  - id: final_summary
    type: Shell
    inputs:
      command: |
        set -euo pipefail

        echo "========================================"
        echo "Code Assistant Agent - Complete"
        echo "========================================"
        echo ""
        echo "User Request: {{inputs.task_description}}"
        echo ""
        echo "Task Classification:"
        echo "  Type: {{blocks.classify_task.outputs.response_json.task_type}}"
        echo "  Confidence: {{blocks.classify_task.outputs.response_json.confidence}}"
        echo "  Reasoning: {{blocks.classify_task.outputs.response_json.reasoning}}"
        echo ""
        echo "Execution:"
        echo "  Status: {{blocks.execute_task.succeeded ? '✅ Completed' : '❌ Failed'}}"
        echo ""

        case "{{blocks.classify_task.outputs.response_json.task_type}}" in
          bug_investigation)
            if [ "{{blocks.execute_bug_investigation.succeeded}}" = "true" ]; then
              echo "Bug Investigation Results:"
              echo "  Investigation Path: {{blocks.execute_bug_investigation.outputs.investigation_path}}"
              echo "  Bug Identified: {{blocks.execute_bug_investigation.outputs.bug_identified}}"
              echo "  Validation: {{blocks.execute_bug_investigation.outputs.validation_passed}}"
            fi
            ;;
          code_review)
            if [ "{{blocks.execute_code_review.succeeded}}" = "true" ]; then
              echo "Code Review Results:"
              echo "  Risk Level: {{blocks.execute_code_review.outputs.risk_level}}"
              echo "  Breaking Changes: {{blocks.execute_code_review.outputs.breaking_changes_count}}"
              echo "  Approval: {{blocks.execute_code_review.outputs.approval_recommended ? '✅ Recommended' : '⚠️  Not Recommended'}}"
              echo "  Validation: {{blocks.execute_code_review.outputs.validation_passed ? '✅ Passed' : '❌ Failed'}}"
            fi
            ;;
          investigation)
            if [ "{{blocks.execute_investigation.succeeded}}" = "true" ]; then
              echo "Investigation Results:"
              echo "  Path: {{blocks.execute_investigation.outputs.investigation_path}}"
              echo "  Status: {{blocks.execute_investigation.outputs.status}}"
              echo "  Files Analyzed: {{blocks.execute_investigation.outputs.files_analyzed}}"
              echo "  Approach: {{blocks.execute_investigation.outputs.approach_used}}"
            fi
            ;;
          feature_implementation)
            if [ "{{blocks.execute_feature_implementation.succeeded}}" = "true" ]; then
              echo "Implementation Plan Results:"
              echo "  Plan ID: {{blocks.execute_feature_implementation.outputs.plan_id}}"
              echo "  Chosen Approach: {{blocks.execute_feature_implementation.outputs.chosen_approach}}"
              echo "  Subtasks: {{blocks.execute_feature_implementation.outputs.subtasks | length}} tasks identified"
              echo "  Estimated Timeline: {{blocks.execute_feature_implementation.outputs.estimated_days.timeline.estimated_days}} days"
              echo "  Risks Identified: {{blocks.execute_feature_implementation.outputs.risks | length}}"
              echo "  Plan State: {{blocks.execute_feature_implementation.outputs.plan_state_path}}"
              echo ""
              echo "Next Steps:"
              echo "  1. Review plan at: {{blocks.execute_feature_implementation.outputs.plan_state_path}}"
              echo "  2. Validate approach with team"
              echo "  3. Begin implementation following execution order"
            fi
            ;;
          general)
            if [ "{{blocks.execute_general.succeeded}}" = "true" ]; then
              echo "Response:"
              echo "{{blocks.execute_general.outputs.response}}"
            fi
            ;;
        esac

        echo ""
        echo "Agent execution complete"
    depends_on: [execute_task]
