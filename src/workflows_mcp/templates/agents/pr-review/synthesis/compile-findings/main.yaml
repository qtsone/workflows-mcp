name: compile-findings
description: Compile findings from investigation results by severity level.
tags:
  - findings
  - compilation
  - severity
  - investigation-analysis
inputs:
  investigation_results:
    type: list
    description: Results from the investigation loop.
    required: true
blocks:
  - id: compile_by_severity
    type: LLMCall
    description: Use LLM to categorize and compile findings by severity.
    inputs:
      profile: default
      prompt: |
        Analyze the following investigation results and compile findings by severity level.
        Group findings into: critical, high, medium, low, info.

        Investigation Results:
        {{inputs.investigation_results | tojson}}

        Return a JSON object with severity levels as keys and arrays of findings as values.
        Each finding should have: details, suggestions, file, line (if applicable).
      response_schema:
        type: object
        properties:
          critical:
            type: array
            items:
              type: object
          high:
            type: array
            items:
              type: object
          medium:
            type: array
            items:
              type: object
          low:
            type: array
            items:
              type: object
          info:
            type: array
            items:
              type: object
  - id: transform_to_numeric
    type: Shell
    description: Transform severity-keyed findings to numeric keys for filtering.
    depends_on:
      - compile_by_severity
    inputs:
      command: |
        python3 << 'EOF'
        import json
        import os
        findings = json.loads(os.environ['FINDINGS_JSON'])
        severity_map = {'info': 0, 'low': 1, 'medium': 2, 'high': 3, 'critical': 4}
        result = {}
        for severity, items in findings.items():
            if items:
                result[str(severity_map.get(severity, 0))] = items
        print(json.dumps(result))
        EOF
      env:
        FINDINGS_JSON: "{{ blocks.compile_by_severity.outputs.response | tojson }}"
outputs:
  compiled_findings:
    value: "{{blocks.transform_to_numeric.outputs.stdout | fromjson}}"
    type: dict
    description: Findings compiled by severity level (numeric keys for filtering).
