name: investigation-sub-workflow
description: |
  Process a single investigation target using LLM analysis.

  This workflow reads actual file contents from the repository and
  generates the file-specific diff, enabling thorough code analysis.

tags:
  - llm
  - investigation
  - analysis
  - pr-review
  - file-reading

inputs:
  target:
    type: dict
    description: |
      Investigation target containing file path and areas to investigate.
      Expected structure: {path: string, reason: string, priority?: string}
      Can also be a simple string (file path).
    required: true

  repo_path:
    type: str
    description: |
      Local path to the repository for file reading.
      This is the normalized path from context-gathering.
    required: true

  base_branch:
    type: str
    description: Base branch for generating file diff.
    required: false
    default: main

  head_branch:
    type: str
    description: Head branch being reviewed.
    required: false

  iteration_counter:
    type: num
    description: Current iteration count.
    required: false
    default: 0

  iteration_cap:
    type: num
    description: Maximum number of iterations allowed.
    required: false
    default: 10

  focus:
    type: str
    description: |
      Area to prioritize in investigation.
      Options: security, performance, architecture, tests, general
    required: false
    default: general

  state_path:
    type: str
    description: |
      Path to state file for task tracking.
      Used by state-management workflow to persist hierarchical task state.
      When provided, enables progress tracking and audit trails.
    required: false
    default: ""

  parent_task_id:
    type: str
    description: |
      Parent task ID for creating sub-tasks in the state tree.
      Used with state_path to create hierarchical task relationships.
    required: false
    default: ""

  investigation_depth:
    type: num
    description: |
      Current recursion depth for related file investigations.
      Incremented when investigating related files.
    required: false
    default: 0

  max_investigation_depth:
    type: num
    description: |
      Maximum recursion depth for related file investigations.
      Prevents infinite loops when files reference each other.
    required: false
    default: 2

blocks:
  # ============================================================================
  # STATE TRACKING: Create sub-task for this file investigation
  # ============================================================================
  - id: track_file_start
    type: Workflow
    description: Create sub-task for individual file investigation in state tree.
    condition: "{{ inputs.state_path and inputs.state_path != '' }}"
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state_path }}"
        parent_id: "{{ inputs.parent_task_id }}"
        task: >-
          Investigate: {{ inputs.target.path | default(inputs.target, true) }}
        task_type: "file-investigation"
        status: "in-progress"
        caller: "pr-review:investigation-sub-workflow"
        data:
          path: "{{ inputs.target.path | default(inputs.target, true) }}"
          reason: "{{ inputs.target.reason | default('Investigation target', true) }}"
          priority: "{{ inputs.target.priority | default('medium', true) }}"
          iteration: "{{ inputs.iteration_counter }}"

  - id: extract_target_path
    type: Shell
    description: Extract the file path from the target (handles both dict and string).
    inputs:
      command: |
        python3 -c "
        import json
        target = {{ inputs.target | tojson }}
        if isinstance(target, dict):
            path = target.get('path', '')
            reason = target.get('reason', 'No reason specified')
            priority = target.get('priority', 'medium')
        else:
            path = str(target)
            reason = 'Investigation target'
            priority = 'medium'

        result = {'path': path, 'reason': reason, 'priority': priority}
        print(json.dumps(result))
        "

  - id: read_file_content
    type: Shell
    description: Read the actual file content from the repository.
    depends_on:
      - extract_target_path
    inputs:
      working_dir: "{{ inputs.repo_path }}"
      command: |
        FILE_PATH="{{ (blocks.extract_target_path.outputs.stdout | fromjson).path }}"

        # Handle relative and absolute paths
        if [ -f "$FILE_PATH" ]; then
          TARGET="$FILE_PATH"
        elif [ -f "{{ inputs.repo_path }}/$FILE_PATH" ]; then
          TARGET="{{ inputs.repo_path }}/$FILE_PATH"
        else
          echo "FILE_NOT_FOUND: $FILE_PATH"
          exit 0
        fi

        # Read file with line numbers (limit to 1000 lines for large files)
        echo "=== FILE: $FILE_PATH ==="
        head -n 1000 "$TARGET" | cat -n

        # If file is larger, note that it was truncated
        LINES=$(wc -l < "$TARGET" | tr -d ' ')
        if [ "$LINES" -gt 1000 ]; then
          echo ""
          echo "... [truncated, $LINES total lines] ..."
        fi

  - id: get_file_diff
    type: Shell
    description: Get the diff for this specific file between base and head branches.
    depends_on:
      - extract_target_path
    inputs:
      working_dir: "{{ inputs.repo_path }}"
      command: |
        FILE_PATH="{{ (blocks.extract_target_path.outputs.stdout | fromjson).path }}"
        BASE="{{ inputs.base_branch }}"
        HEAD="{{ inputs.head_branch | default('HEAD', true) }}"

        # Try different diff strategies
        if git diff "$BASE..$HEAD" -- "$FILE_PATH" 2>/dev/null; then
          :
        elif git diff "origin/$BASE..$HEAD" -- "$FILE_PATH" 2>/dev/null; then
          :
        elif git diff HEAD~1 -- "$FILE_PATH" 2>/dev/null; then
          :
        else
          echo "No diff available for $FILE_PATH"
        fi

  - id: get_git_blame
    type: Shell
    description: Get git blame for the file to understand authorship of changes.
    depends_on:
      - extract_target_path
    inputs:
      working_dir: "{{ inputs.repo_path }}"
      command: |
        FILE_PATH="{{ (blocks.extract_target_path.outputs.stdout | fromjson).path }}"

        # Only show blame for modified lines (if file exists)
        if [ -f "$FILE_PATH" ] || [ -f "{{ inputs.repo_path }}/$FILE_PATH" ]; then
          # Show blame with line numbers (limit output)
          git blame --line-porcelain "$FILE_PATH" 2>/dev/null | \
            grep -E '^(author |summary |[0-9a-f]{40})' | head -100 || \
            echo "Git blame not available"
        else
          echo "File not found for blame"
        fi

  - id: analyze_target
    type: LLMCall
    description: |
      Analyze the investigation target using LLM with actual file content.
    depends_on:
      - extract_target_path
      - read_file_content
      - get_file_diff
    inputs:
      profile: default
      prompt: |
        # File Investigation Analysis

        Analyze this file for potential issues based on the PR review context.

        ## Target Information
        - **File Path:** {{ (blocks.extract_target_path.outputs.stdout | fromjson).path }}
        - **Reason for Investigation:** {{ (blocks.extract_target_path.outputs.stdout | fromjson).reason }}
        - **Priority:** {{ (blocks.extract_target_path.outputs.stdout | fromjson).priority }}
        - **Iteration:** {{ inputs.iteration_counter }} of {{ inputs.iteration_cap }}
        - **Focus Area:** {{ inputs.focus }}

        ## File Content
        ```
        {{ blocks.read_file_content.outputs.stdout[:8000] }}
        {% if blocks.read_file_content.outputs.stdout | length > 8000 %}
        ... [content truncated]
        {% endif %}
        ```

        ## Diff for This File
        ```diff
        {{ blocks.get_file_diff.outputs.stdout[:4000] }}
        {% if blocks.get_file_diff.outputs.stdout | length > 4000 %}
        ... [diff truncated]
        {% endif %}
        ```

        ## Analysis Instructions

        {% if inputs.focus == 'security' %}
        **Security Focus** - Pay special attention to:
        - Authentication/authorization issues
        - Input validation and sanitization
        - SQL injection, XSS, command injection
        - Sensitive data exposure
        - Cryptographic issues
        {% elif inputs.focus == 'performance' %}
        **Performance Focus** - Pay special attention to:
        - O(nÂ²) or worse algorithms
        - Database query efficiency (N+1 queries)
        - Memory leaks or excessive allocations
        - Blocking operations in async code
        - Missing caching opportunities
        {% elif inputs.focus == 'architecture' %}
        **Architecture Focus** - Pay special attention to:
        - SOLID principle violations
        - Coupling and cohesion issues
        - Design pattern misuse
        - API contract changes
        - Dependency management
        {% elif inputs.focus == 'tests' %}
        **Test Focus** - Pay special attention to:
        - Test coverage of changed code
        - Edge case handling
        - Test quality and assertions
        - Mocking/stubbing correctness
        - Test isolation issues
        {% endif %}

        Provide:
        1. **Summary**: What does this file do and what changed?
        2. **Issues**: Specific problems found (with line numbers if possible)
        3. **Severity**: Overall severity (critical/high/medium/low/info)
        4. **Suggestions**: Concrete improvements
        5. **Further Investigation**: Do related files need checking?
        6. **Confidence**: How confident are you in this analysis (0.0-1.0)?

      response_schema:
        type: object
        properties:
          summary:
            type: string
            description: "What the file does and what changed"
          issues:
            type: array
            items:
              type: object
              properties:
                type:
                  type: string
                  enum: [security, performance, quality, logic, best_practice, test]
                description:
                  type: string
                severity:
                  type: string
                  enum: [critical, high, medium, low, info]
                line_number:
                  type: integer
                code_snippet:
                  type: string
                suggestion:
                  type: string
              required: [type, description, severity]
            description: "List of specific issues found"
          severity:
            type: string
            enum: [critical, high, medium, low, info]
            description: "Overall severity of findings for this file"
          suggestions:
            type: array
            items:
              type: string
            description: "Concrete suggestions for improvement"
          needs_further_investigation:
            type: boolean
            description: "Whether related files should be investigated"
          related_files:
            type: array
            items:
              type: string
            description: "Related files that may need investigation"
          confidence:
            type: number
            minimum: 0
            maximum: 1
            description: "Confidence level in this analysis"
        required: [summary, issues, severity, suggestions, needs_further_investigation, confidence]

  # ============================================================================
  # RECURSIVE INVESTIGATION: Process related files if needed
  # ============================================================================
  - id: investigate_related_files
    type: Workflow
    description: |
      Recursively investigate related files identified by LLM analysis.
      Only runs if: needs_further_investigation is true, depth is within limits,
      and there are related files to investigate.
    condition: >-
      {{ blocks.analyze_target.outputs.response.needs_further_investigation
         and blocks.analyze_target.outputs.response.related_files | length > 0
         and inputs.investigation_depth < inputs.max_investigation_depth }}
    depends_on:
      - analyze_target
      - track_file_start
    for_each: "{{ blocks.analyze_target.outputs.response.related_files }}"
    for_each_mode: sequential
    inputs:
      workflow: investigation-sub-workflow
      inputs:
        target:
          path: "{{ each.value }}"
          reason: "Related to {{ inputs.target.path | default(inputs.target, true) }}"
          priority: "medium"
        repo_path: "{{ inputs.repo_path }}"
        base_branch: "{{ inputs.base_branch }}"
        head_branch: "{{ inputs.head_branch }}"
        iteration_counter: "{{ inputs.iteration_counter }}"
        iteration_cap: "{{ inputs.iteration_cap }}"
        focus: "{{ inputs.focus }}"
        state_path: "{{ inputs.state_path }}"
        parent_task_id: "{{ blocks.track_file_start.outputs.task_id | default(inputs.parent_task_id, true) }}"
        investigation_depth: "{{ inputs.investigation_depth + 1 }}"
        max_investigation_depth: "{{ inputs.max_investigation_depth }}"

  # ============================================================================
  # STATE TRACKING: Mark file investigation complete with captured data
  # ============================================================================
  - id: track_file_done
    type: Workflow
    description: Mark file investigation as complete with captured data.
    condition: "{{ inputs.state_path and inputs.state_path != '' and blocks.track_file_start.succeeded }}"
    depends_on:
      - analyze_target
      - investigate_related_files
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state_path }}"
        task_id: "{{ blocks.track_file_start.outputs.task_id }}"
        status: "done"
        caller: "pr-review:investigation-sub-workflow"
        data:
          severity: "{{ blocks.analyze_target.outputs.response.severity }}"
          confidence: "{{ blocks.analyze_target.outputs.response.confidence }}"
          issues_count: "{{ blocks.analyze_target.outputs.response.issues | length }}"
          needs_further: "{{ blocks.analyze_target.outputs.response.needs_further_investigation }}"
          related_files: "{{ blocks.analyze_target.outputs.response.related_files | default([]) | tojson }}"

outputs:
  investigation_result:
    value: "{{ blocks.analyze_target.outputs.response }}"
    type: dict
    description: |
      Results of the file investigation including:
      - summary: What the file does
      - issues: List of problems found with severity
      - suggestions: Concrete improvements
      - confidence: Analysis confidence level

  target_path:
    value: "{{ (blocks.extract_target_path.outputs.stdout | fromjson).path }}"
    type: str
    description: "The file path that was investigated."

  file_found:
    value: "{{ 'FILE_NOT_FOUND' not in blocks.read_file_content.outputs.stdout }}"
    type: bool
    description: "Whether the target file was found in the repository."
