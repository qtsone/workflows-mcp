name: cortex-fact-store
description: |
  Atomic capability: Store validated fact in semantic memory.
  Used by REASON phase to persist extracted knowledge.

  Evidence types (epistemic status):
  - direct: Verified by reading specific code (0.9-1.0 confidence)
  - inferred: Derived from patterns/signals (0.7-0.9 confidence)
  - assumed: Reasonable hypothesis (0.5-0.7 confidence)

tags: [cortex, capability, atomic, facts, memory]

inputs:
  state:
    type: str
    description: Path to SQLite state database.
    required: true

  claim:
    type: str
    description: The fact statement.
    required: true

  evidence_type:
    type: str
    description: Epistemic status (direct, inferred, assumed).
    required: false
    default: "inferred"

  confidence:
    type: num
    description: Confidence score (0.0-1.0).
    required: false
    default: 0.7

  grounding:
    type: str
    description: Evidence references as JSON array (e.g., file paths, line numbers).
    required: false
    default: "[]"

  scope:
    type: str
    description: Optional scope limitation (e.g., "src/auth/").
    required: false
    default: ""

  source_cell:
    type: str
    description: Cell ID that created this fact.
    required: false
    default: ""

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Workflow
    description: Register this capability in the task tree.
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        parent_id: "{{ inputs.parent_id }}"
        kind: "capability"
        name: "cortex-fact-store"
        metadata:
          labels:
            capability_type: "fact"
            side_effects: "false"
        inputs_data:
          evidence_type: "{{ inputs.evidence_type }}"
          confidence: "{{ inputs.confidence }}"
          scope: "{{ inputs.scope }}"
        status: "running"
        caller: "cortex-fact-store"

  # ===========================================================================
  # STEP 2: Store fact
  # ===========================================================================
  - id: store
    type: Workflow
    depends_on: [register]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        op: facts
        facts_op: store
        facts_claim: "{{ inputs.claim }}"
        facts_evidence_type: "{{ inputs.evidence_type }}"
        facts_confidence: "{{ inputs.confidence }}"
        facts_grounding: "{{ inputs.grounding }}"
        facts_scope: "{{ inputs.scope }}"
        facts_source_cell: "{{ inputs.source_cell }}"
        caller: "cortex-fact-store"

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Workflow
    description: Mark capability complete in task tree.
    depends_on: [store]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ blocks.register.outputs.state }}"
        task_id: "{{ blocks.register.outputs.task.task_id }}"
        status: "done"
        outputs_data:
          fact_id: "{{ blocks.store.outputs.facts.fact_id | default('') }}"
          success: "{{ blocks.store.outputs.facts.success | default(false) }}"
        caller: "cortex-fact-store"

outputs:
  success:
    value: "{{ blocks.store.outputs.facts.success | default(false) }}"
    type: bool
    description: Whether operation succeeded.

  fact_id:
    value: "{{ blocks.store.outputs.facts.fact_id | default('') }}"
    type: str
    description: ID of the stored fact.

  claim:
    value: "{{ inputs.claim }}"
    type: str
    description: The fact statement that was stored.

  task_id:
    value: "{{ blocks.register.outputs.task.task_id | default('') }}"
    type: str
    description: Task ID of this capability invocation.
