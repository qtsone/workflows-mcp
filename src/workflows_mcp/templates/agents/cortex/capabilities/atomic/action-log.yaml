name: cortex-action-log
description: |
  Atomic capability: Log action for deduplication before execution.
  Used by ACT phase to prevent duplicate mutations.

  Deduplication uses unique constraint on (capability, inputs) to identify
  duplicate requests. If an identical action exists, returns cached result.

  Action statuses:
  - pending: Logged but not yet executed
  - completed: Successfully executed
  - failed: Execution failed
  - rolled_back: Action was reversed

tags: [cortex, capability, atomic, actions, deduplication]

inputs:
  state:
    type: str
    description: Path to SQLite state database.
    required: true

  cell_id:
    type: str
    description: Cell ID requesting the action.
    required: true

  capability:
    type: str
    description: Capability workflow name (e.g., "action-write", "action-edit").
    required: true

  inputs_json:
    type: str
    description: Action inputs as JSON string (used for deduplication hash).
    required: true

  models:
    type: dict
    description: Model definitions for CRUD operations.
    required: false
    default: {}

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Sql
    description: Register this capability in the task tree.
    condition: "{{ inputs.state | trim != '' }}"
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: insert
      data:
        parent_id: "{{ inputs.parent_id if inputs.parent_id else none }}"
        kind: capability
        name: cortex-action-log
        metadata: "{{ {'labels': {'capability_type': 'action', 'side_effects': 'false'}} }}"
        inputs: "{{ {'capability': inputs.capability, 'cell_id': inputs.cell_id} }}"
        status: running
        depth: 2

  # ===========================================================================
  # STEP 2: Log action for deduplication (upsert into actions table)
  # ===========================================================================
  - id: log
    type: Sql
    depends_on:
      - block: register
        required: false
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.action }}"
      op: upsert
      data:
        task_id: "{{ inputs.cell_id }}"
        capability: "{{ inputs.capability }}"
        inputs: "{{ inputs.inputs_json | fromjson }}"
        status: pending
      conflict: [capability, inputs]

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Sql
    description: Mark capability complete in task tree.
    condition: "{{ inputs.state | trim != '' }}"
    depends_on: [log]
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: update
      where:
        id: "{{ blocks.register.outputs.rows[0].id }}"
      data:
        status: done
        outputs: "{{ {'action_id': blocks.log.outputs.rows[0].id | default(''), 'status': blocks.log.outputs.rows[0].status | default('')} }}"

outputs:
  success:
    value: "{{ blocks.log.succeeded }}"
    type: bool
    description: Whether operation succeeded.

  action_id:
    value: "{{ blocks.log.outputs.rows[0].id | default('') }}"
    type: str
    description: ID of the logged action.

  status:
    value: "{{ blocks.log.outputs.rows[0].status | default('') }}"
    type: str
    description: Current status of the action (pending=new, completed=cached).

  cached_result:
    value: "{{ blocks.log.outputs.rows[0].result | default(none) | fromjson if blocks.log.outputs.rows[0].result else none }}"
    type: dict
    description: Cached result if action was already completed.

  task_id:
    value: "{{ blocks.register.outputs.rows[0].id | default('') }}"
    type: str
    description: Task ID of this capability invocation.
