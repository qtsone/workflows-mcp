# =============================================================================
# CORTEX Compute Surprisal Capability
# =============================================================================
#
# Calculates surprisal (information-theoretic surprise) when comparing
# predictions to actual outcomes. Implements the Free Energy Principle:
#
#   surprisal = -log2(probability)
#
# Examples:
#   - 90% prediction matched → surprisal = -log2(0.9) = 0.15 bits (expected)
#   - 90% prediction failed → surprisal = -log2(0.1) = 3.32 bits (surprising!)
#   - 50% prediction either → surprisal = -log2(0.5) = 1 bit (neutral)
#
# High surprisal (>2 bits) indicates the model's prediction was significantly
# wrong and should trigger learning (DIAGNOSE action, episode recording).
#
# =============================================================================

name: cortex-compute-surprisal
description: "Calculate surprisal between prediction and actual outcome"

tags: [cortex, capability, predictive-coding]

inputs:
  state:
    type: str
    description: Path to SQLite state database.
    required: true

  models:
    type: dict
    description: Model definitions.
    default: {}

  expectation_id:
    type: str
    description: ID of the expectation to compare against.
    required: true

  actual_outcome:
    type: dict
    description: The actual outcome observed.
    required: true

  context_hash:
    type: str
    description: Hash of the context for clustering similar situations.
    default: ""

blocks:
  - id: get_expectation
    type: Sql
    description: Get the expectation to compare against.
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.expectation }}"
      op: select
      where:
        id: "{{ inputs.expectation_id }}"

  - id: compute
    type: Shell
    description: Calculate surprisal from prediction vs actual.
    depends_on: [get_expectation]
    condition: "{{ blocks.get_expectation.succeeded and blocks.get_expectation.outputs.rows | length > 0 }}"
    inputs:
      command: |
        python3 << 'EOF'
        import json
        import math
        import os

        # Parse inputs
        expectation_json = os.environ.get('EXPECTATION', '{}')
        actual_json = os.environ.get('ACTUAL', '{}')

        try:
            expectation = json.loads(expectation_json)
        except:
            expectation = {}

        try:
            actual = json.loads(actual_json)
        except:
            actual = {}

        # Extract prediction from expectation
        prediction = expectation.get('prediction', {})
        if isinstance(prediction, str):
            try:
                prediction = json.loads(prediction)
            except:
                prediction = {}

        predicted_outcome = prediction.get('outcome', 'unknown')
        predicted_probability = float(prediction.get('probability', 0.5))

        # Clamp probability to avoid log(0) or log(1) edge cases
        predicted_probability = max(0.01, min(0.99, predicted_probability))

        # Determine if prediction matched
        actual_outcome = actual.get('outcome', 'unknown')
        matched = (predicted_outcome == actual_outcome)

        # Compute surprisal: -log2(P) where P is probability of what happened
        if matched:
            # Outcome matched prediction - use predicted probability
            probability = predicted_probability
        else:
            # Outcome didn't match - use complement probability
            probability = 1.0 - predicted_probability

        surprisal_bits = -math.log2(probability)

        # Thresholds for interpretation
        # < 1 bit: expected (happened more than 50% of the time)
        # 1-2 bits: notable (25-50% range)
        # 2-3 bits: surprising (12.5-25% range)
        # > 3 bits: very surprising (< 12.5%)

        if surprisal_bits < 1.0:
            interpretation = "expected"
            trigger_diagnose = False
        elif surprisal_bits < 2.0:
            interpretation = "notable"
            trigger_diagnose = False
        elif surprisal_bits < 3.0:
            interpretation = "surprising"
            trigger_diagnose = True
        else:
            interpretation = "very_surprising"
            trigger_diagnose = True

        result = {
            'expectation_id': expectation.get('id', ''),
            'matched_prediction': matched,
            'predicted_outcome': predicted_outcome,
            'predicted_probability': predicted_probability,
            'actual_outcome': actual_outcome,
            'probability_of_actual': probability,
            'surprisal_bits': round(surprisal_bits, 3),
            'interpretation': interpretation,
            'trigger_diagnose': trigger_diagnose
        }

        print(json.dumps(result))
        EOF
      env:
        EXPECTATION: "{{ blocks.get_expectation.outputs.rows[0] | tojson }}"
        ACTUAL: "{{ inputs.actual_outcome | tojson }}"

  - id: store_outcome
    type: Sql
    description: Store the expectation outcome.
    depends_on: [compute]
    condition: "{{ blocks.compute.succeeded }}"
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.expectation_outcome }}"
      op: insert
      data:
        expectation_id: "{{ inputs.expectation_id }}"
        actual_outcome: "{{ inputs.actual_outcome }}"
        matched_prediction: "{{ get(blocks.compute.outputs.stdout, 'matched_prediction', false) }}"
        surprisal_bits: "{{ get(blocks.compute.outputs.stdout, 'surprisal_bits', 0) }}"
        context_hash: "{{ inputs.context_hash }}"

  - id: update_expectation
    type: Sql
    description: Update the expectation with match status.
    depends_on: [store_outcome]
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.expectation }}"
      op: update
      where:
        id: "{{ inputs.expectation_id }}"
      data:
        matched: "{{ get(blocks.compute.outputs.stdout, 'matched_prediction', false) }}"

outputs:
  result:
    type: dict
    description: "Surprisal calculation result."
    value: "{{ blocks.compute.outputs.stdout if blocks.compute.succeeded else {} }}"

  surprisal_bits:
    type: num
    description: "Surprisal in bits."
    value: "{{ get(blocks.compute.outputs.stdout, 'surprisal_bits', 0) }}"

  matched:
    type: bool
    description: "Whether prediction matched actual outcome."
    value: "{{ get(blocks.compute.outputs.stdout, 'matched_prediction', false) }}"

  trigger_diagnose:
    type: bool
    description: "Whether surprisal is high enough to trigger DIAGNOSE."
    value: "{{ get(blocks.compute.outputs.stdout, 'trigger_diagnose', false) }}"

  outcome_id:
    type: str
    description: "ID of the stored expectation outcome."
    value: "{{ get(blocks.store_outcome.outputs, 'rows.0.id', '') }}"
