name: cortex-action-execute
description: |
  Atomic capability: Execute command with side effects.
  Use for running tests, builds, deployments, etc.

tags: [cortex, capability, atomic, action, execute]

inputs:
  command:
    type: str
    description: Shell command to execute.
    required: true

  working_dir:
    type: str
    description: Working directory.
    required: false
    default: "."

  timeout:
    type: num
    description: Timeout in seconds.
    required: false
    default: 120

  state:
    type: str
    description: Path to SQLite state database (for task tracking).
    required: false
    default: ""

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Workflow
    description: Register this capability in the task tree.
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        parent_id: "{{ inputs.parent_id }}"
        kind: "capability"
        name: "cortex-action-execute"
        metadata:
          labels:
            capability_type: "action"
            side_effects: "true"
        inputs_data:
          command: "{{ inputs.command[:100] }}"
          working_dir: "{{ inputs.working_dir }}"
          timeout: "{{ inputs.timeout }}"
        status: "running"
        caller: "cortex-action-execute"

  # ===========================================================================
  # STEP 2: Execute command
  # ===========================================================================
  - id: execute
    type: Shell
    depends_on: [register]
    inputs:
      command: "{{ inputs.command }}"
      working_dir: "{{ inputs.working_dir }}"
      timeout: "{{ inputs.timeout }}"

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Workflow
    description: Mark capability complete in task tree.
    depends_on: [execute]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ blocks.register.outputs.state }}"
        task_id: "{{ blocks.register.outputs.task.task_id }}"
        status: "done"
        outputs_data:
          exit_code: "{{ blocks.execute.outputs.exit_code }}"
          success: "{{ blocks.execute.outputs.exit_code == 0 }}"
        caller: "cortex-action-execute"

outputs:
  stdout:
    value: "{{ blocks.execute.outputs.stdout }}"
    type: str
    description: Command standard output.

  stderr:
    value: "{{ blocks.execute.outputs.stderr }}"
    type: str
    description: Command standard error.

  exit_code:
    value: "{{ blocks.execute.outputs.exit_code }}"
    type: num
    description: Exit code (0 = success).

  success:
    value: "{{ blocks.execute.outputs.exit_code == 0 }}"
    type: bool
    description: Whether command succeeded.

  action:
    value: |
      {{
        {
          'type': 'execute',
          'command': inputs.command[:100],
          'exit_code': blocks.execute.outputs.exit_code,
          'success': blocks.execute.outputs.exit_code == 0
        }
      }}
    type: dict
    description: Action record for audit trail.

  task_id:
    value: "{{ blocks.register.outputs.task.task_id | default('') }}"
    type: str
    description: Task ID of this capability invocation.

  state:
    value: "{{ blocks.register.outputs.state | default(inputs.state) }}"
    type: str
    description: Path to state database (passthrough).
