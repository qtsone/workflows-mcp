name: cortex-gather-files
description: |
  Atomic capability: Read files matching patterns and store as evidence.
  Wraps ReadFiles block with cortex-compatible interface.
  Automatically stores gathered content in episodic memory (evidence table).

tags: [cortex, capability, atomic, gather, evidence]

inputs:
  patterns:
    type: list
    description: Glob patterns for files to read.
    required: true

  base_path:
    type: str
    description: Base directory to search from.
    required: false
    default: "."

  mode:
    type: str
    description: Output mode (outline, full, summary).
    required: false
    default: "outline"

  max_files:
    type: num
    description: Maximum files to read.
    required: false
    default: 20

  max_file_size_kb:
    type: num
    description: Maximum file size in KB.
    required: false
    default: 100

  state:
    type: str
    description: Path to SQLite state database (for evidence storage).
    required: false
    default: ""

  source_cell:
    type: str
    description: Cell ID gathering this evidence.
    required: false
    default: ""

blocks:
  - id: read
    type: ReadFiles
    inputs:
      patterns: "{{ inputs.patterns }}"
      base_path: "{{ inputs.base_path }}"
      mode: "{{ inputs.mode }}"
      max_files: "{{ inputs.max_files }}"
      max_file_size_kb: "{{ inputs.max_file_size_kb }}"

  # Store each file as evidence in episodic memory
  - id: store_evidence
    type: Workflow
    description: Store gathered files as evidence.
    depends_on: [read]
    condition: "{{ inputs.state != '' and blocks.read.outputs.files | length > 0 }}"
    for_each: "{{ blocks.read.outputs.files }}"
    for_each_mode: parallel
    max_parallel: 10
    continue_on_error: true
    inputs:
      workflow: cortex-evidence-store
      inputs:
        state: "{{ inputs.state }}"
        key: "{{ each.value.path }}"
        value: "{{ each.value | tojson }}"
        evidence_type: "{{ 'outline' if inputs.mode == 'outline' else 'content' }}"
        source_cell: "{{ inputs.source_cell }}"
        source_operation: "cortex-gather-files"

outputs:
  files:
    value: "{{ blocks.read.outputs.files }}"
    type: list
    description: List of files with content.

  total_files:
    value: "{{ blocks.read.outputs.total_files }}"
    type: num
    description: Number of files read.

  total_size_kb:
    value: "{{ blocks.read.outputs.total_size_kb }}"
    type: num
    description: Total size in KB.

  evidence:
    value: |
      {{
        blocks.read.outputs.files | map(attribute='path') | list
      }}
    type: list
    description: Evidence references for findings (file paths).

  evidence_stored:
    value: "{{ blocks.store_evidence.metadata.count | default(0) }}"
    type: num
    description: Number of files stored as evidence.
