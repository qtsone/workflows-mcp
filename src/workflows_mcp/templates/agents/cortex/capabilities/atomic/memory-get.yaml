name: cortex-memory-get
description: |
  Atomic capability: Retrieve value from memory using composite key.
  Used to recall knowledge from specific namespaces.

tags: [cortex, capability, atomic, memory]

inputs:
  state:
    type: str
    description: Path to SQLite state database.
    required: true

  type:
    type: str
    description: Memory namespace type (e.g., "findings", "evidence").
    required: false
    default: ""

  key:
    type: str
    description: Memory key within namespace.
    required: true

  default:
    type: str
    description: Default value if key not found (JSON string).
    required: false
    default: ""

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Workflow
    description: Register this capability in the task tree.
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        parent_id: "{{ inputs.parent_id }}"
        kind: "capability"
        name: "cortex-memory-get"
        metadata:
          labels:
            capability_type: "memory"
            side_effects: "false"
        inputs_data:
          type: "{{ inputs.type }}"
          key: "{{ inputs.key }}"
        status: "running"
        caller: "cortex-memory-get"

  # ===========================================================================
  # STEP 2: Retrieve memory
  # ===========================================================================
  - id: retrieve
    type: Workflow
    depends_on: [register]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        op: memory
        memory_op: get
        memory_type: "{{ inputs.type }}"
        memory_key: "{{ inputs.key }}"
        memory_default: "{{ inputs.default }}"
        caller: "cortex-memory-get"

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Workflow
    description: Mark capability complete in task tree.
    depends_on: [retrieve]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ blocks.register.outputs.state }}"
        task_id: "{{ blocks.register.outputs.task.task_id }}"
        status: "done"
        outputs_data:
          exists: "{{ blocks.retrieve.outputs.memory.exists | default(false) }}"
          key: "{{ inputs.key }}"
        caller: "cortex-memory-get"

outputs:
  value:
    value: "{{ blocks.retrieve.outputs.memory.value }}"
    type: json
    description: Retrieved value (preserves original type - dict, list, string, etc.).

  exists:
    value: "{{ blocks.retrieve.outputs.memory.exists | default(false) }}"
    type: bool
    description: Whether key existed.

  key:
    value: "{{ inputs.key }}"
    type: str
    description: Key that was retrieved.

  task_id:
    value: "{{ blocks.register.outputs.task.task_id | default('') }}"
    type: str
    description: Task ID of this capability invocation.
