name: cortex-action-complete
description: |
  Atomic capability: Mark action as completed with result.
  Used by ACT phase after successful execution.

tags: [cortex, capability, atomic, actions, deduplication]

inputs:
  state:
    type: str
    description: Path to SQLite state database.
    required: true

  action_id:
    type: str
    description: ID of the action to complete.
    required: true

  result_json:
    type: str
    description: Action result as JSON string.
    required: false
    default: "{}"

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Workflow
    description: Register this capability in the task tree.
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        parent_id: "{{ inputs.parent_id }}"
        kind: "capability"
        name: "cortex-action-complete"
        metadata:
          labels:
            capability_type: "action"
            side_effects: "false"
        inputs_data:
          action_id: "{{ inputs.action_id }}"
        status: "running"
        caller: "cortex-action-complete"

  # ===========================================================================
  # STEP 2: Mark action as complete
  # ===========================================================================
  - id: complete
    type: Workflow
    depends_on: [register]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        op: actions
        actions_op: complete
        actions_action_id: "{{ inputs.action_id }}"
        actions_result_json: "{{ inputs.result_json }}"
        caller: "cortex-action-complete"

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Workflow
    description: Mark capability complete in task tree.
    depends_on: [complete]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ blocks.register.outputs.state }}"
        task_id: "{{ blocks.register.outputs.task.task_id }}"
        status: "done"
        outputs_data:
          action_id: "{{ inputs.action_id }}"
          status: "{{ blocks.complete.outputs.actions.status | default('') }}"
          success: "{{ blocks.complete.outputs.actions.success | default(false) }}"
        caller: "cortex-action-complete"

outputs:
  success:
    value: "{{ blocks.complete.outputs.actions.success | default(false) }}"
    type: bool
    description: Whether operation succeeded.

  action_id:
    value: "{{ inputs.action_id }}"
    type: str
    description: ID of the completed action.

  status:
    value: "{{ blocks.complete.outputs.actions.status | default('') }}"
    type: str
    description: New status of the action (should be "completed").

  task_id:
    value: "{{ blocks.register.outputs.task.task_id | default('') }}"
    type: str
    description: Task ID of this capability invocation.
