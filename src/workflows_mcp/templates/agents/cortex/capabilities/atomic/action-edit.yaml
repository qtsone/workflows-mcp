name: cortex-action-edit
description: |
  Atomic capability: Modify an existing file.
  Supports multiple edit operations with atomic rollback.

tags: [cortex, capability, atomic, action, edit, v2]

inputs:
  path:
    type: str
    description: File path to edit.
    required: true

  operations:
    type: list
    description: |
      List of edit operations. Each operation needs:
      - type: replace_text | replace_lines | insert_lines | delete_lines | patch | regex_replace

      For replace_text: {type: "replace_text", old_text: "...", new_text: "...", count: -1}
      For replace_lines: {type: "replace_lines", line_start: N, line_end: M, content: "..."}
      For insert_lines: {type: "insert_lines", line_start: N, content: "..."}
      For delete_lines: {type: "delete_lines", line_start: N, line_end: M}
      For patch: {type: "patch", patch: "unified diff string"}
      For regex_replace: {type: "regex_replace", pattern: "...", replacement: "...", flags: [...]}
    required: true

  backup:
    type: bool
    description: Create backup before editing.
    required: false
    default: true

  dry_run:
    type: bool
    description: Preview changes without applying.
    required: false
    default: false

  state:
    type: str
    description: Path to SQLite state database (for task tracking).
    required: false
    default: ""

  models:
    type: dict
    description: Model definitions for CRUD operations.
    required: false
    default: {}

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Sql
    description: Register this capability in the task tree.
    condition: "{{ inputs.state | trim != '' }}"
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: insert
      data:
        parent_id: "{{ inputs.parent_id if inputs.parent_id else none }}"
        kind: capability
        name: cortex-action-edit
        metadata: "{{ {'labels': {'capability_type': 'action', 'side_effects': 'true'}} }}"
        inputs: "{{ {'path': inputs.path, 'operation_count': inputs.operations | length, 'dry_run': inputs.dry_run} }}"
        status: running
        depth: 2

  # ===========================================================================
  # STEP 2: Execute edit
  # ===========================================================================
  - id: edit
    type: EditFile
    depends_on:
      - block: register
        required: false
    inputs:
      path: "{{ inputs.path }}"
      operations: "{{ inputs.operations }}"
      backup: "{{ inputs.backup }}"
      dry_run: "{{ inputs.dry_run }}"

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Sql
    description: Mark capability complete in task tree.
    depends_on:
      - block: register
        required: true
      - block: edit
        required: false
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: update
      where:
        id: "{{ (blocks.register.outputs.rows | default([{}]))[0].id | default('') }}"
      data:
        status: "{{ 'done' if blocks.edit.succeeded else 'failed' }}"
        outputs: "{{ {'operations_applied': blocks.edit.outputs.operations_applied | default(0), 'lines_added': blocks.edit.outputs.lines_added | default(0), 'lines_removed': blocks.edit.outputs.lines_removed | default(0), 'success': blocks.edit.succeeded, 'error': blocks.edit.metadata.message | default('')} }}"

outputs:
  operations_applied:
    value: "{{ blocks.edit.outputs.operations_applied }}"
    type: num
    description: Number of operations applied.

  lines_added:
    value: "{{ blocks.edit.outputs.lines_added }}"
    type: num
    description: Lines added.

  lines_removed:
    value: "{{ blocks.edit.outputs.lines_removed }}"
    type: num
    description: Lines removed.

  diff:
    value: "{{ blocks.edit.outputs.diff }}"
    type: str
    description: Unified diff of changes.

  success:
    value: "{{ blocks.edit.outputs.success }}"
    type: bool
    description: Whether all operations succeeded.

  action:
    value: |
      {{
        {
          'type': 'edit',
          'path': inputs.path,
          'operations_applied': blocks.edit.outputs.operations_applied,
          'lines_added': blocks.edit.outputs.lines_added,
          'lines_removed': blocks.edit.outputs.lines_removed
        }
      }}
    type: dict
    description: Action record for audit trail.

  task_id:
    value: "{{ (blocks.register.outputs.rows | default([{}]))[0].id | default('') }}"
    type: str
    description: Task ID of this capability invocation.

  state:
    value: "{{ inputs.state }}"
    type: str
    description: Path to state database (passthrough).
