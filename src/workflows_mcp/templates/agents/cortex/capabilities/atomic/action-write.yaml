name: cortex-action-write
description: |
  Atomic capability: Create a new file.
  Use for generating reports, creating new code files, etc.

tags: [cortex, capability, atomic, action, write]

inputs:
  path:
    type: str
    description: File path to create.
    required: true

  content:
    type: str
    description: File content to write.
    required: true

  overwrite:
    type: bool
    description: Whether to overwrite existing file.
    required: false
    default: false

  state:
    type: str
    description: Path to SQLite state database (for task tracking).
    required: false
    default: ""

  models:
    type: dict
    description: Model definitions for CRUD operations.
    required: false
    default: {}

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Sql
    description: Register this capability in the task tree.
    condition: "{{ inputs.state | trim != '' }}"
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: insert
      data:
        parent_id: "{{ inputs.parent_id if inputs.parent_id else none }}"
        kind: capability
        name: cortex-action-write
        metadata: "{{ {'labels': {'capability_type': 'action', 'side_effects': 'true'}} }}"
        inputs: "{{ {'path': inputs.path, 'overwrite': inputs.overwrite, 'content_length': inputs.content | length} }}"
        status: running
        depth: 2

  # ===========================================================================
  # STEP 2: Write file
  # ===========================================================================
  - id: write
    type: CreateFile
    depends_on:
      - block: register
        required: false
    inputs:
      path: "{{ inputs.path }}"
      content: "{{ inputs.content }}"
      overwrite: "{{ inputs.overwrite }}"

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Sql
    description: Mark capability complete in task tree.
    depends_on:
      - block: register
        required: true
      - block: write
        required: false
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: update
      where:
        id: "{{ (blocks.register.outputs.rows | default([{}]))[0].id | default('') }}"
      data:
        status: "{{ 'done' if blocks.write.succeeded else 'failed' }}"
        outputs: "{{ {'path': blocks.write.outputs.path | default(''), 'size_bytes': blocks.write.outputs.size_bytes | default(0), 'created': blocks.write.outputs.created | default(false), 'success': blocks.write.succeeded, 'error': blocks.write.metadata.message | default('')} }}"

outputs:
  path:
    value: "{{ blocks.write.outputs.path }}"
    type: str
    description: Absolute path to created file.

  size_bytes:
    value: "{{ blocks.write.outputs.size_bytes }}"
    type: num
    description: File size in bytes.

  created:
    value: "{{ blocks.write.outputs.created }}"
    type: bool
    description: True if file was created (vs overwritten).

  success:
    value: "{{ blocks.write.succeeded }}"
    type: bool
    description: Whether write succeeded.

  action:
    value: |
      {{
        {
          'type': 'write',
          'path': blocks.write.outputs.path,
          'size_bytes': blocks.write.outputs.size_bytes,
          'created': blocks.write.outputs.created
        }
      }}
    type: dict
    description: Action record for audit trail.

  task_id:
    value: "{{ (blocks.register.outputs.rows | default([{}]))[0].id | default('') }}"
    type: str
    description: Task ID of this capability invocation.

  state:
    value: "{{ inputs.state }}"
    type: str
    description: Path to state database (passthrough).
