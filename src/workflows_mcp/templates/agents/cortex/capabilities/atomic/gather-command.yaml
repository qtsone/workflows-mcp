name: cortex-gather-command
description: |
  Atomic capability: Execute shell command for information gathering.
  Read-only operations only - no side effects.

tags: [cortex, capability, atomic, gather, command]

inputs:
  command:
    type: str
    description: Shell command to execute.
    required: true

  working_dir:
    type: str
    description: Working directory.
    required: false
    default: "."

  timeout:
    type: num
    description: Timeout in seconds.
    required: false
    default: 30

  state:
    type: str
    description: Path to SQLite state database (for task tracking).
    required: false
    default: ""

  models:
    type: dict
    description: Model definitions for CRUD operations.
    required: false
    default: {}

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Sql
    description: Register this capability in the task tree.
    condition: "{{ inputs.state | trim != '' }}"
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: insert
      data:
        parent_id: "{{ inputs.parent_id if inputs.parent_id else none }}"
        kind: capability
        name: cortex-gather-command
        metadata: "{{ {'labels': {'capability_type': 'gather', 'side_effects': 'false'}} }}"
        inputs: "{{ {'command': inputs.command[:100], 'working_dir': inputs.working_dir, 'timeout': inputs.timeout} }}"
        status: running
        depth: 2

  # ===========================================================================
  # STEP 2: Execute command
  # ===========================================================================
  - id: execute
    type: Shell
    depends_on:
      - block: register
        required: false
    inputs:
      command: "{{ inputs.command }}"
      working_dir: "{{ inputs.working_dir }}"
      timeout: "{{ inputs.timeout }}"

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Sql
    description: Mark capability complete in task tree.
    condition: "{{ inputs.state | trim != '' }}"
    depends_on: [execute]
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: update
      where:
        id: "{{ blocks.register.outputs.rows[0].id }}"
      data:
        status: done
        outputs: "{{ {'exit_code': blocks.execute.outputs.exit_code, 'success': blocks.execute.outputs.exit_code == 0} }}"

outputs:
  stdout:
    value: "{{ blocks.execute.outputs.stdout }}"
    type: str
    description: Command standard output.

  stderr:
    value: "{{ blocks.execute.outputs.stderr }}"
    type: str
    description: Command standard error.

  exit_code:
    value: "{{ blocks.execute.outputs.exit_code }}"
    type: num
    description: Exit code (0 = success).

  success:
    value: "{{ blocks.execute.outputs.exit_code == 0 }}"
    type: bool
    description: Whether command succeeded.

  evidence:
    value: "{{ ['command:' ~ inputs.command[:50]] }}"
    type: list
    description: Evidence reference for findings.

  task_id:
    value: "{{ blocks.register.outputs.rows[0].id | default('') }}"
    type: str
    description: Task ID of this capability invocation.

  state:
    value: "{{ inputs.state }}"
    type: str
    description: Path to state database (passthrough).
