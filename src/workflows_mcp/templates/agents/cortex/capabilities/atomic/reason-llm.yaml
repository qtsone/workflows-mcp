name: cortex-reason-llm
description: |
  Atomic capability: Call LLM for reasoning, analysis, or decision-making.
  Core reasoning capability used by all cognitive phases.

tags: [cortex, capability, atomic, reason, llm]

inputs:
  prompt:
    type: str
    description: User prompt to send to the LLM.
    required: true

  system_instructions:
    type: str
    description: System instructions for the LLM.
    required: false
    default: ""

  response_schema:
    type: dict
    description: JSON Schema for structured response.
    required: false
    default: {}

  profile:
    type: str
    description: LLM profile from config.
    required: false
    default: "default"

  timeout:
    type: num
    description: Timeout in seconds.
    required: false
    default: 120

  state:
    type: str
    description: Path to SQLite state database (for task tracking).
    required: false
    default: ""

  models:
    type: dict
    description: Model definitions for CRUD operations.
    required: false
    default: {}

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Sql
    description: Register this capability in the task tree.
    condition: "{{ inputs.state | trim != '' }}"
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: insert
      data:
        parent_id: "{{ inputs.parent_id if inputs.parent_id else none }}"
        kind: capability
        name: cortex-reason-llm
        metadata: "{{ {'labels': {'capability_type': 'reason', 'side_effects': 'false'}} }}"
        inputs: "{{ {'profile': inputs.profile, 'has_schema': (inputs.response_schema != {}), 'prompt_length': inputs.prompt | length} }}"
        status: running
        depth: 2

  # ===========================================================================
  # STEP 2: Call LLM
  # ===========================================================================
  - id: call_llm
    type: LLMCall
    depends_on:
      - block: register
        required: false
    inputs:
      profile: "{{ inputs.profile }}"
      prompt: "{{ inputs.prompt }}"
      system_instructions: "{{ inputs.system_instructions if inputs.system_instructions else None }}"
      response_schema: "{{ inputs.response_schema if inputs.response_schema else None }}"
      timeout: "{{ inputs.timeout }}"

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Sql
    description: Mark capability complete in task tree.
    depends_on:
      - block: register
        required: true
      - block: call_llm
        required: false
    inputs:
      engine: sqlite
      path: "{{ inputs.state }}"
      model: "{{ inputs.models.task }}"
      op: update
      where:
        id: "{{ (blocks.register.outputs.rows | default([{}]))[0].id | default('') }}"
      data:
        status: "{{ 'done' if blocks.call_llm.succeeded else 'failed' }}"
        outputs: "{{ {'success': blocks.call_llm.succeeded, 'model': blocks.call_llm.outputs.metadata.model | default('unknown') if blocks.call_llm.succeeded else 'N/A', 'total_tokens': blocks.call_llm.outputs.metadata.total_tokens | default(0), 'error': blocks.call_llm.metadata.message | default('')} }}"

outputs:
  response:
    value: "{{ blocks.call_llm.outputs.response }}"
    type: dict
    description: LLM response (structured if schema provided).

  success:
    value: "{{ blocks.call_llm.outputs.success }}"
    type: bool
    description: Whether LLM call succeeded.

  metadata:
    value: "{{ blocks.call_llm.outputs.metadata }}"
    type: dict
    description: Call metadata (tokens, model, etc.).

  evidence:
    value: "{{ ['llm:' ~ inputs.profile ~ ':' ~ (blocks.call_llm.outputs.metadata.model | default('unknown'))] }}"
    type: list
    description: Evidence reference for findings.

  task_id:
    value: "{{ (blocks.register.outputs.rows | default([{}]))[0].id | default('') }}"
    type: str
    description: Task ID of this capability invocation.
