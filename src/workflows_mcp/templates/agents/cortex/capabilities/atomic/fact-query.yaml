name: cortex-fact-query
description: |
  Atomic capability: Query validated facts from semantic memory.
  Used by REASON phase to recall existing knowledge.

  Supports:
  - Full-text search via FTS5
  - Status filtering (active, verified, contested, superseded, refuted)

tags: [cortex, capability, atomic, facts, memory]

inputs:
  state:
    type: str
    description: Path to SQLite state database.
    required: true

  query:
    type: str
    description: FTS query string for semantic search. Leave empty for all facts.
    required: false
    default: ""

  status:
    type: str
    description: Filter by status (default "active").
    required: false
    default: "active"

  limit:
    type: num
    description: Maximum results to return.
    required: false
    default: 50

  parent_id:
    type: str
    description: Parent task ID for task tree registration.
    required: false
    default: ""

blocks:
  # ===========================================================================
  # STEP 1: Register capability in task tree
  # ===========================================================================
  - id: register
    type: Workflow
    description: Register this capability in the task tree.
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        parent_id: "{{ inputs.parent_id }}"
        kind: "capability"
        name: "cortex-fact-query"
        metadata:
          labels:
            capability_type: "fact"
            side_effects: "false"
        inputs_data:
          query: "{{ inputs.query[:100] if inputs.query else '' }}"
          status_filter: "{{ inputs.status }}"
          limit: "{{ inputs.limit }}"
        status: "running"
        caller: "cortex-fact-query"

  # ===========================================================================
  # STEP 2: Query facts
  # ===========================================================================
  - id: query
    type: Workflow
    depends_on: [register]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        op: facts
        facts_op: query
        facts_query: "{{ inputs.query }}"
        facts_status_filter: "{{ inputs.status }}"
        facts_limit: "{{ inputs.limit }}"
        caller: "cortex-fact-query"

  # ===========================================================================
  # STEP 3: Track completion
  # ===========================================================================
  - id: track_done
    type: Workflow
    description: Mark capability complete in task tree.
    depends_on: [query]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ blocks.register.outputs.state }}"
        task_id: "{{ blocks.register.outputs.task.task_id }}"
        status: "done"
        outputs_data:
          count: "{{ blocks.query.outputs.facts.count | default(0) }}"
          success: "{{ blocks.query.outputs.facts.success | default(false) }}"
        caller: "cortex-fact-query"

outputs:
  success:
    value: "{{ blocks.query.outputs.facts.success | default(false) }}"
    type: bool
    description: Whether operation succeeded.

  # Note: Use get() to avoid collision with dict.items() method
  items:
    value: "{{ get(blocks.query.outputs.facts, 'items', []) }}"
    type: list
    description: List of matching facts.

  count:
    value: "{{ blocks.query.outputs.facts.count | default(0) }}"
    type: num
    description: Number of facts returned.

  task_id:
    value: "{{ blocks.register.outputs.task.task_id | default('') }}"
    type: str
    description: Task ID of this capability invocation.
