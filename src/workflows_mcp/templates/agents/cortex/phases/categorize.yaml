name: cortex-phase-categorize
description: |
  CORTEX Categorization Phase

  Classifies the query to determine optimal processing strategy.
  This is the first phase in the cognitive cycle, determining how
  subsequent phases should approach the problem.

  Categories:
  - existence: "Does X exist?" → Quick gather, minimal analysis
  - understanding: "What is X?" → Deep exploration, multiple gathers
  - discovery: "Find all X" → Broad search, iterative refinement
  - quality: "Is X good?" → Evidence gathering, criteria evaluation
  - planning: "How to do X?" → Decomposition, step sequencing
  - debugging: "Why does X fail?" → Hypothesis testing, elimination
  - action: "Do X" → Planning, execution, verification

tags: [cortex, phase, categorize]

inputs:
  query:
    type: str
    description: The query to categorize.
    required: true

  context:
    type: dict
    description: Shared context from parent cell.
    required: true

  capabilities:
    type: dict
    description: Available capabilities registry.
    required: false
    default: {}

  state:
    type: str
    description: Path to SQLite state database.
    required: true

  parent_task_id:
    type: str
    description: Parent cell's task ID.
    required: false
    default: ""

  profile:
    type: str
    description: LLM profile to use.
    required: false
    default: "default"

blocks:
  - id: register_task
    type: Workflow
    description: Register this phase in the task tree.
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        parent_id: "{{ inputs.parent_task_id }}"
        task: "Phase: Categorize"
        task_type: "cortex-categorize"
        status: "in-progress"
        caller: "cortex-phase-categorize"

  - id: categorize
    type: LLMCall
    description: Classify the query using LLM.
    depends_on: [register_task]
    inputs:
      profile: "{{ inputs.profile }}"
      timeout: 60
      prompt: |
        # Query Categorization

        You are the categorization module of a recursive cognitive system (CORTEX).
        Your task is to classify the query to determine the optimal processing strategy.

        ## Query
        {{ inputs.query }}

        ## Context
        - Repository Path: {{ inputs.context.repo_path | default('Not specified') }}
        - Focus Area: {{ inputs.context.focus | default('general') }}
        {% if inputs.context.constraints %}
        - Constraints: {{ inputs.context.constraints | tojson }}
        {% endif %}

        ## Categories

        Classify this query into ONE of the following categories:

        | Category | Description | Examples |
        |----------|-------------|----------|
        | existence | Check if something exists | "Does file X exist?", "Is there a config for Y?" |
        | understanding | Learn about something | "What does X do?", "How does Y work?" |
        | discovery | Find all instances | "Find all security issues", "List all API endpoints" |
        | quality | Evaluate something | "Is this code good?", "Are there any bugs?" |
        | planning | Create a plan | "How do I implement X?", "Plan the migration" |
        | debugging | Find root cause | "Why does X fail?", "What causes the error?" |
        | action | Execute something | "Fix the bug", "Implement feature X" |

        ## Assessment

        Also determine:
        1. **is_atomic**: Can this be resolved with a single capability (file read, search, etc.)?
        2. **suggested_phases**: Which phases should run for this query type?
        3. **confidence**: How confident are you in this classification? (0.0-1.0)

      response_schema:
        type: object
        properties:
          category:
            type: string
            enum: [existence, understanding, discovery, quality, planning, debugging, action]
            description: "The primary category for this query"
          is_atomic:
            type: boolean
            description: "Whether this can be resolved with a single atomic capability"
          suggested_phases:
            type: array
            items:
              type: string
              enum: [understand, formulate, gather, analyze, synthesize, act]
            description: "Recommended phases to execute"
          confidence:
            type: number
            minimum: 0
            maximum: 1
            description: "Confidence in classification (0.0-1.0)"
          reasoning:
            type: string
            description: "Brief explanation of categorization decision"
          atomic_capability:
            type: string
            description: "If is_atomic=true, which capability would resolve this (e.g., gather-files, gather-search)"
        required: [category, is_atomic, confidence, reasoning]

  - id: store_result
    type: Workflow
    description: Store categorization result in memory.
    depends_on: [categorize]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        op: memory
        memory_op: set
        memory_key: "categorization"
        memory_value: |
          {
            "category": "{{ blocks.categorize.outputs.response.category }}",
            "is_atomic": {{ blocks.categorize.outputs.response.is_atomic | tojson }},
            "confidence": {{ blocks.categorize.outputs.response.confidence }},
            "reasoning": {{ blocks.categorize.outputs.response.reasoning | tojson }}
          }
        caller: "cortex-phase-categorize"

  - id: track_done
    type: Workflow
    description: Mark phase complete.
    depends_on: [categorize, store_result]
    inputs:
      workflow: agent-state-management
      inputs:
        state: "{{ inputs.state }}"
        task_id: "{{ blocks.register_task.outputs.task.task_id }}"
        status: "done"
        caller: "cortex-phase-categorize"
        data:
          category: "{{ blocks.categorize.outputs.response.category }}"
          confidence: "{{ blocks.categorize.outputs.response.confidence }}"

outputs:
  category:
    value: "{{ blocks.categorize.outputs.response.category }}"
    type: str
    description: The query category.

  is_atomic:
    value: "{{ blocks.categorize.outputs.response.is_atomic }}"
    type: bool
    description: Whether query can be resolved atomically.

  suggested_phases:
    value: "{{ blocks.categorize.outputs.response.suggested_phases | default(['gather', 'analyze', 'synthesize']) }}"
    type: list
    description: Recommended phases to execute.

  confidence:
    value: "{{ blocks.categorize.outputs.response.confidence }}"
    type: num
    description: Classification confidence (0.0-1.0).

  reasoning:
    value: "{{ blocks.categorize.outputs.response.reasoning }}"
    type: str
    description: Explanation of categorization.

  atomic_capability:
    value: "{{ blocks.categorize.outputs.response.atomic_capability | default('') }}"
    type: str
    description: Capability to use if atomic.
