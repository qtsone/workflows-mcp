name: workflow-creator
description: Interactive workflow creator using LLM-guided design and validation
version: "2.3"
tags: [agents, interactive, llm, workflow-generation]

inputs:
  name:
    type: str
    description: "Name for the new workflow (optional - will prompt if not provided)"
    default: ""
    required: false

  description:
    type: str
    description: "Brief description of what the workflow should do (optional - will prompt if not provided)"
    default: ""
    required: false

  workspace:
    type: str
    description: "Path where the workflow file should be saved"
    default: "/tmp/workflow-creator"
    required: false

  max_validation_attempts:
    type: num
    description: "Maximum number of validation fix attempts"
    default: 10
  
  questions:
    type: dict
    description: "Questions to ask user. Key matches input name - if input provided, question is skipped"
    default:
      name: "What should this workflow be named? (lowercase, hyphens, e.g., 'data-pipeline')"
      description: "What does this workflow do? (brief description)"
      inputs: "What inputs does the workflow need? (describe parameters and their purposes)"
      outputs: "What should the workflow return? (describe expected outputs)"
      steps: "What are the main steps or phases? (describe the logical flow)"

blocks:
  - id: bootstrap_context
    type: Workflow
    inputs:
      workflow: workflow-creator-bootstrap
      inputs:
        repo: "https://github.com/qtsone/workflows-mcp.git"
        ref: "feat/workflow-companion"
        workspace: "{{inputs.workspace}}/bootstrap"

  - id: filter_questions
    type: WriteJSONState
    depends_on: [bootstrap_context]
    inputs:
      path: "{{inputs.workspace}}/questions.json"
      data:
        questions: >-
          {%- set result = {} -%}
          {%- for key, question in inputs.questions.items() -%}
            {%- set skip = inputs.get(key, '') | trim != '' -%}
            {%- if not skip -%}
              {%- set _ = result.update({key: question}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ result | tojson }}

  - id: gather_requirements
    depends_on: [filter_questions]
    type: Prompt
    for_each: "{{blocks.filter_questions.inputs.data.questions | fromjson}}"
    for_each_mode: sequential
    inputs:
      prompt: |
        # WORKFLOW CREATOR - REQUIREMENTS GATHERING

        [{{each.key}}] {{each.value}}

        Your answer:

  - id: structure_requirements
    depends_on: [gather_requirements]
    type: LLMCall
    inputs:
      profile: default
      timeout: 600
      system_instructions: |
        You are an expert workflow requirements analyst.
        Your goal is to extract clear, structured requirements from user conversations.
        
        # Output Rules
        - workflow_name: lowercase, hyphenated (e.g., "data-pipeline")
        - defaults: MUST be strings (e.g., "10", "true", "None")
        - inputs/outputs: explicit types and descriptions
      prompt: |
        # Task: Structure Workflow Requirements

        Extract and structure workflow requirements from user responses.

        ## User Provided Inputs
        {% if inputs.name | trim != '' %}
        Workflow Name: {{inputs.name}}
        {% endif %}

        {% if inputs.description | trim != '' %}
        Workflow Description: {{inputs.description}}
        {% endif %}

        ## User Responses to Questions

        {% for key, question in (blocks.filter_questions.inputs.data.questions | fromjson).items() %}
        [{{ key }}] {{ question }}
        Answer: {{blocks.gather_requirements[key].outputs.response}}
        {% endfor %}

        ## Instructions

        Create a structured requirements document with:

        1. **workflow_name**: Clean, lowercase, hyphenated name
        2. **description**: Clear, concise description
        3. **inputs**: List of {name, type, description, required, default}
           - IMPORTANT: 'default' must be a STRING. If the default is a number (e.g. 10), use "10".
           - If no default exists, use the string "None".
        4. **steps**: Ordered list of workflow phases/steps
        5. **outputs**: List of {name, type, description}
        6. **tags**: Relevant tags for categorization

        Be specific and detailed. Infer reasonable defaults where appropriate.

        Generate structured requirements now.
      response_schema:
        type: object
        properties:
          workflow_name:
            type: string
            description: "Clean workflow name"
          description:
            type: string
            description: "Workflow description"
          inputs:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                type:
                  type: string
                  enum: ["str", "string", "num", "number", "int", "integer", "bool", "boolean", "list", "array", "dict", "object"]
                description:
                  type: string
                required:
                  type: boolean
                default:
                  type: string
                  description: "Default value as a string (e.g. '10', 'true')"
              required:
                - name
                - type
                - description
                - required
                - default
              additionalProperties: false
            description: "Workflow input parameters"
          steps:
            type: array
            items:
              type: string
            description: "Main workflow steps/phases"
          outputs:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                type:
                  type: string
                  enum: ["str", "string", "num", "number", "int", "integer", "bool", "boolean", "list", "array", "dict", "object"]
                description:
                  type: string
              required:
                - name
                - type
                - description
              additionalProperties: false
            description: "Workflow outputs"
          tags:
            type: array
            items:
              type: string
            description: "Workflow tags"
        required:
          - workflow_name
          - description
          - inputs
          - steps
          - outputs
          - tags
        additionalProperties: false

  - id: store_requirements
    depends_on: [structure_requirements]
    type: WriteJSONState
    inputs:
      path: "{{inputs.workspace}}/requirements.json"
      data: "{{blocks.structure_requirements.outputs.response}}"

  - id: design_approval
    depends_on: [store_requirements]
    type: Workflow
    inputs:
      workflow: design-approval-loop
      inputs:
        requirements: "{{inputs.workspace}}/requirements.json"
        executor_docs: "{{blocks.bootstrap_context.outputs.executor_docs}}"
        examples: "{{blocks.bootstrap_context.outputs.examples}}"
  
  - id: check_design_approval
    depends_on: [design_approval]
    type: Shell
    inputs:
      command: |
        # Convert to lowercase and strip whitespace (Jinja2 templates may include newlines)
        APPROVED=$(echo "{{blocks.design_approval.outputs.approved}}" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')
        if [ "$APPROVED" = "true" ]; then
          echo "✓ Design approved, proceeding with generation"
          exit 0
        else
          echo "✗ Design was cancelled by user (approved=$APPROVED)"
          exit 1
        fi

  - id: generate_workflow
    depends_on: [check_design_approval]
    type: LLMCall
    inputs:
      profile: default
      timeout: 600
      system_instructions: |
        You are an expert workflow generator for the workflows-mcp system.
        You generate valid YAML workflow definitions following strict schemas.

        # Design Principles
        1. **Precision**: Use EXACT block types and field names from the Block Reference.
        2. **Structure**: Follow the standard workflow YAML structure (name, description, inputs, blocks, outputs).
        3. **Logic**: Ensure dependencies (depends_on) create a valid DAG matching the design.
        4. **Variables**: Use double braces {{...}} for variable substitution.

        # Critical Rules
        - LLMCall blocks: Use 'prompt' (NOT 'command' or 'message')
        - Prompt blocks: Use 'prompt' (NOT 'message')
        - Shell blocks: Use 'command'
        - IDs: Use lowercase-hyphenated identifiers
      prompt: |
        # Task: Generate Complete Workflow YAML

        Create a production-ready workflow based on the approved design.

        ## Approved Design

        ### Diagram
        {{blocks.design_approval.outputs.final_diagram}}

        ### Design Explanation
        {{blocks.design_approval.outputs.final_explanation}}

        ### Block Summary
        {{blocks.design_approval.outputs.final_block_summary}}

        ## Structured Requirements
        {{blocks.structure_requirements.outputs.response | tojson}}

        ## Block Executor Reference (Authoritative)
        {{read_file(blocks.bootstrap_context.outputs.executor_docs)}}

        ## Instructions

        Generate a complete, valid workflow structure following the approved design.

        For EACH block in the design:
        1. Use the EXACT block type from the design
        2. Use the CORRECT required input fields (refer to Block Executor Reference)
        3. Set proper depends_on relationships
        4. Add conditions where the design specifies conditional paths

        Generate the workflow structure now.
      response_schema: "{{read_file(blocks.bootstrap_context.outputs.schema_path) | fromjson}}"

  - id: save_draft_workflow
    depends_on: [generate_workflow]
    type: CreateFile
    inputs:
      path: "{{tmp}}/draft-workflow.yaml"
      content: "{{blocks.generate_workflow.outputs.response | toyaml}}"
      overwrite: true
      create_parents: true

  - id: recursive_validation
    depends_on: [save_draft_workflow]
    type: Workflow
    inputs:
      workflow: recursive-validation
      inputs:
        workflow_path: "{{blocks.save_draft_workflow.outputs.path}}"
        schema_path: "{{blocks.bootstrap_context.outputs.schema_path}}"
        executor_docs: "{{blocks.bootstrap_context.outputs.executor_docs}}"
        workflows_mcp_path: "{{blocks.bootstrap_context.outputs.workspace}}"
        max_iterations: "{{inputs.max_validation_attempts}}"

  - id: finalize_and_save
    depends_on: [recursive_validation]
    type: Workflow
    inputs:
      workflow: finalize-and-save
      inputs:
        workflow_name: "{{blocks.structure_requirements.outputs.response.workflow_name}}"
        yaml_content: "{{read_file(blocks.recursive_validation.outputs.final_workflow_path)}}"
        path: "{{inputs.workspace}}/{{blocks.structure_requirements.outputs.response.workflow_name}}.yaml"
        tmp_dir: "{{blocks.bootstrap_context.outputs.workspace}}"
        workflows_mcp_path: "{{blocks.bootstrap_context.outputs.workspace}}"
        validation_attempts: "{{blocks.recursive_validation.outputs.iterations_used}}"

outputs:
  workflow_name:
    value: "{{blocks.finalize_and_save.outputs.workflow_name}}"
    type: str
    description: "Name of the created workflow"

  workflow_path:
    value: "{{blocks.finalize_and_save.outputs.workflow_path}}"
    type: str
    description: "Path to the saved workflow file"

  validation_passed:
    value: "{{blocks.finalize_and_save.outputs.validation_passed}}"
    type: bool
    description: "Whether final validation passed"

  summary:
    value: "{{blocks.finalize_and_save.outputs.summary}}"
    type: str
    description: "Complete creation summary with next steps"

  requirements:
    value: "{{blocks.structure_requirements.outputs.response}}"
    type: dict
    description: "Structured workflow requirements"

  success:
    value: "{{blocks.finalize_and_save.succeeded}}"
    type: bool
    description: "Whether workflow creation completed successfully"
