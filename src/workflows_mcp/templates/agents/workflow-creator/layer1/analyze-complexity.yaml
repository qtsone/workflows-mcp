name: workflow-creator-analyze-complexity
description: Analyze workflow requirements to determine complexity and decomposition strategy
version: "1.0"
tags: [agents, internal, analysis]

inputs:
  requirements:
    type: dict
    description: "Structured workflow requirements from requirements phase"
    required: true

  executor_docs_path:
    type: str
    description: "Path to executor documentation for context"
    required: true

  workspace:
    type: str
    description: "Workspace path for temporary files"
    default: "{{tmp}}"

blocks:
  - id: analyze
    description: "Analyze requirements for complexity indicators"
    type: LLMCall
    inputs:
      profile: default
      timeout: 120
      system_instructions: |
        You are an expert workflow architect. Analyze workflow requirements to determine:
        1. Complexity level (simple, composed, orchestrated)
        2. Whether sub-workflows should be created
        3. Decomposition strategy if needed

        # Complexity Indicators
        - **simple**: < 10 blocks, linear flow, no nested loops
        - **composed**: 10-20 blocks OR needs reusable sub-workflows OR has parallel branches
        - **orchestrated**: > 20 blocks OR multiple distinct phases OR complex iteration patterns

        # Decomposition Triggers
        Create sub-workflows when:
        - Same block pattern repeats 2+ times (extract as reusable workflow)
        - Distinct logical phases exist (e.g., setup → process → cleanup)
        - Nested iteration needed (outer for_each calling inner for_each)
        - Recursive patterns mentioned (retry, approval loops, iterative refinement)
      prompt: |
        Analyze these workflow requirements:

        ```json
        {{inputs.requirements | prettyjson}}
        ```

        Determine:
        1. Complexity level
        2. Estimated block count
        3. Whether decomposition is needed
        4. If decomposing, list sub-workflows to create
      response_schema:
        type: object
        properties:
          complexity_level:
            type: string
            enum: ["simple", "composed", "orchestrated"]
            description: "Overall complexity classification"
          estimated_blocks:
            type: integer
            description: "Estimated number of blocks needed"
          needs_decomposition:
            type: boolean
            description: "Whether to split into sub-workflows"
          reasoning:
            type: string
            description: "Brief explanation of the analysis"
          sub_workflows:
            type: array
            description: "Sub-workflows to create (empty if not decomposing)"
            items:
              type: object
              properties:
                name:
                  type: string
                  description: "Sub-workflow name (lowercase-hyphenated)"
                purpose:
                  type: string
                  description: "What this sub-workflow does"
                is_recursive:
                  type: boolean
                  description: "Whether this workflow calls itself"
                inputs:
                  type: array
                  items:
                    type: string
                  description: "Input parameter names needed"
                outputs:
                  type: array
                  items:
                    type: string
                  description: "Output names produced"
              required:
                - name
                - purpose
        required:
          - complexity_level
          - estimated_blocks
          - needs_decomposition
          - reasoning
        additionalProperties: false

  - id: store_analysis
    description: "Save analysis results"
    type: CreateFile
    depends_on: [analyze]
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/complexity-analysis.json"
      content: |
        {{blocks.analyze.outputs.response | prettyjson}}

outputs:
  complexity_level:
    value: "{{blocks.analyze.outputs.response.complexity_level}}"
    type: str
    description: "Complexity classification"

  needs_decomposition:
    value: "{{blocks.analyze.outputs.response.needs_decomposition}}"
    type: bool
    description: "Whether decomposition is recommended"

  sub_workflows:
    value: "{{blocks.analyze.outputs.response.sub_workflows}}"
    type: list
    description: "List of sub-workflows to create"

  analysis_path:
    value: "{{blocks.store_analysis.outputs.path}}"
    type: str
    description: "Path to stored analysis"

  reasoning:
    value: "{{blocks.analyze.outputs.response.reasoning}}"
    type: str
    description: "Explanation of the analysis"
