name: workflow-creator-analyze-complexity
description: Analyze workflow requirements to determine complexity and decomposition strategy
version: "1.0"
tags: [agents, internal, analysis]

inputs:
  requirements:
    type: dict
    description: "Structured workflow requirements from requirements phase"
    required: true

  executor_docs_path:
    type: str
    description: "Path to executor documentation for context"
    required: true

  workspace:
    type: str
    description: "Workspace path for temporary files"
    default: "{{tmp}}"

blocks:
  - id: analyze
    description: "Analyze requirements for complexity indicators"
    type: LLMCall
    inputs:
      profile: default
      timeout: 120
      system_instructions: |
        You are an expert workflow architect. Analyze workflow requirements to determine:
        1. Complexity level (simple, composed, orchestrated)
        2. Whether sub-workflows should be created
        3. Decomposition strategy if needed

        # Complexity Indicators
        - **simple**: < 10 blocks, linear flow, no nested loops
        - **composed**: 10-20 blocks OR needs reusable sub-workflows OR has parallel branches
        - **orchestrated**: > 20 blocks OR multiple distinct phases OR complex iteration patterns

        # Decomposition Triggers
        Create sub-workflows when:
        - Same block pattern repeats 2+ times (extract as reusable workflow)
        - Distinct logical phases exist (e.g., setup → process → cleanup)
        - Nested iteration needed (outer for_each calling inner for_each)
        - Recursive patterns mentioned (retry, approval loops, iterative refinement)

        # CRITICAL: Sub-Workflow Step Generation
        When decomposing, you MUST provide detailed implementation steps for each sub-workflow.
        Each step should be actionable and describe a specific block or operation:
        - BAD: "Process the data" (too vague)
        - GOOD: "Read input file using ReadFiles block", "Transform data using LLMCall", "Write results to output"

        For recursive sub-workflows, include:
        - Termination condition check step
        - Main processing step(s)
        - Recursive call step with updated parameters
        - Result aggregation step
      prompt: |
        Analyze these workflow requirements:

        ```json
        {{inputs.requirements | prettyjson}}
        ```

        Determine:
        1. Complexity level
        2. Estimated block count
        3. Whether decomposition is needed
        4. If decomposing, list sub-workflows with DETAILED implementation steps for each

        IMPORTANT: For each sub-workflow, provide 3-7 specific implementation steps that describe
        the blocks and operations needed. These steps will be used directly to generate the sub-workflow.
      response_schema:
        type: object
        properties:
          complexity_level:
            type: string
            enum: ["simple", "composed", "orchestrated"]
            description: "Overall complexity classification"
          estimated_blocks:
            type: integer
            description: "Estimated number of blocks needed"
          needs_decomposition:
            type: boolean
            description: "Whether to split into sub-workflows"
          reasoning:
            type: string
            description: "Brief explanation of the analysis"
          sub_workflows:
            type: array
            description: "Sub-workflows to create (empty if not decomposing)"
            items:
              type: object
              properties:
                name:
                  type: string
                  description: "Sub-workflow name (lowercase-hyphenated)"
                purpose:
                  type: string
                  description: "What this sub-workflow does"
                is_recursive:
                  type: boolean
                  description: "Whether this workflow calls itself"
                inputs:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        description: "Parameter name"
                      type:
                        type: string
                        description: "Parameter type (str, num, bool, list, dict)"
                      description:
                        type: string
                        description: "What this parameter is for"
                    required: [name, type, description]
                  description: "Input parameters with types and descriptions"
                outputs:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        description: "Output name"
                      type:
                        type: string
                        description: "Output type (str, num, bool, list, dict)"
                      description:
                        type: string
                        description: "What this output contains"
                    required: [name, type, description]
                  description: "Outputs with types and descriptions"
                steps:
                  type: array
                  items:
                    type: string
                  description: "Detailed implementation steps (3-7 steps describing blocks/operations)"
              required:
                - name
                - purpose
                - steps
        required:
          - complexity_level
          - estimated_blocks
          - needs_decomposition
          - reasoning
        additionalProperties: false

  - id: store_analysis
    description: "Save analysis results"
    type: CreateFile
    depends_on: [analyze]
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/complexity-analysis.json"
      content: |
        {{blocks.analyze.outputs.response | prettyjson}}

outputs:
  complexity_level:
    value: "{{blocks.analyze.outputs.response.complexity_level}}"
    type: str
    description: "Complexity classification"

  needs_decomposition:
    value: "{{blocks.analyze.outputs.response.needs_decomposition}}"
    type: bool
    description: "Whether decomposition is recommended"

  sub_workflows:
    value: "{{blocks.analyze.outputs.response.sub_workflows}}"
    type: list
    description: "List of sub-workflows to create"

  analysis_path:
    value: "{{blocks.store_analysis.outputs.path}}"
    type: str
    description: "Path to stored analysis"

  reasoning:
    value: "{{blocks.analyze.outputs.response.reasoning}}"
    type: str
    description: "Explanation of the analysis"
