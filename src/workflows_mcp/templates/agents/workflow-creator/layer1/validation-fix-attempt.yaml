name: validation-fix-attempt
description: Single validation attempt with automatic error fixing via LLM
version: "1.0"
tags: [agents, validation, internal]

inputs:
  workflow_path:
    type: str
    description: "Path to workflow YAML file to validate"
    required: true
  
  schema_path:
    type: str
    description: "Path to LLM-compatible schema JSON file for structured outputs"
    required: true
  
  executor_docs:
    type: str
    description: "Executor documentation for fix context"
    required: true

  iteration:
    type: num
    description: "Current attempt number (for logging)"
    default: 1

  workflows_mcp_path:
    type: str
    description: "Directory path where validation is located"
    required: true

blocks:
  - id: validate_workflow
    description: "Validate the YAML file"
    type: Shell
    inputs:
      working_dir: "{{inputs.workflows_mcp_path}}"
      command: |
        python validate.py "{{inputs.workflow_path}}"

  - id: read_yaml_content
    description: "Read YAML file content"
    type: Shell
    condition: "{{blocks.validate_workflow.failed}}"
    inputs:
      command: |
        cat "{{inputs.workflow_path}}"
    depends_on:
      - block: validate_workflow
        required: false

  - id: read_schema
    type: Shell
    condition: "{{blocks.validate_workflow.failed}}"
    inputs:
      command: |
        cat "{{inputs.schema_path}}"
    depends_on:
      - block: validate_workflow
        required: false

  - id: fix_validation_errors
    description: "Fix validation errors"
    type: LLMCall
    condition: "{{blocks.validate_workflow.failed}}"
    inputs:
      profile: default
      system_instructions: |
        You are fixing workflow validation errors. Use EXACT field names.

        # CRITICAL: Required Input Field Names

        | Block Type     | Required Field(s)                    |
        |----------------|--------------------------------------|
        | Shell          | command                              |
        | LLMCall        | prompt (NOT 'command' or 'message')  |
        | Prompt         | prompt (NOT 'command' or 'message')  |
        | ImageGen       | prompt, profile OR provider          |
        | CreateFile     | path, content                        |
        | EditFile       | path, operations                     |
        | ReadFiles      | patterns                             |
        | HttpCall       | url                                  |
        | Workflow       | workflow                             |
        | ReadJSONState  | path                                 |
        | WriteJSONState | path, data                           |
        | MergeJSONState | path, updates                        |

        # Common Field Name Mistakes to Fix

        ❌ WRONG: LLMCall with 'command' → ✅ CORRECT: LLMCall with 'prompt'
        ❌ WRONG: Prompt with 'message' → ✅ CORRECT: Prompt with 'prompt'
        ❌ WRONG: Prompt with 'command' → ✅ CORRECT: Prompt with 'prompt'
        ❌ WRONG: CreateFile with 'command' → ✅ CORRECT: CreateFile with 'path' and 'content'

        # Valid Workflow Structure

        - name: required string
        - description: required string
        - tags: optional array
        - inputs: optional object
        - blocks: required array of {id, type, inputs, ...}
        - outputs: optional object
      prompt: |
        # Task: Fix Workflow Validation Errors

        A workflow YAML file failed validation. Analyze errors and fix them.

        ## Original YAML
        ```yaml
        {{blocks.read_yaml_content.outputs.stdout}}
        ```

        ## Validation Errors
        ```
        STDERR:
        {{blocks.validate_workflow.outputs.stderr}}

        STDOUT:
        {{blocks.validate_workflow.outputs.stdout}}
        ```

        ## Executor Documentation
        {{read_file(inputs.executor_docs)}}

        ## Instructions

        1. **Analyze the errors**: Look for "Field required" or "Extra inputs not permitted" messages
        2. **Check field names**: If a block uses 'command' but should use 'prompt', fix it
        3. **Fix the issues**: Correct field names, syntax, structure errors
        4. **Preserve intent**: Keep the workflow's purpose and logic intact

        ## Common Fixes

        - "prompt: Field required" + "command: Extra inputs not permitted" → rename 'command' to 'prompt'
        - "path: Field required" + "command: Extra inputs not permitted" → use 'path' and 'content'

        Return the complete corrected workflow structure.
      response_schema: "{{blocks.read_schema.outputs.stdout | fromjson}}"
    depends_on:
      - block: read_yaml_content
        required: true
      - block: read_schema
        required: true

  - id: save_fixed_yaml
    description: "Save fixed YAML to file"
    type: CreateFile
    condition: "{{blocks.validate_workflow.failed}}"
    inputs:
      path: "{{tmp}}/fixed-workflow-attempt-{{inputs.iteration}}.yaml"
      content: |
        {{blocks.fix_validation_errors.outputs.response | toyaml}}
      overwrite: true
      create_parents: true
    depends_on:
      - block: fix_validation_errors
        required: false

outputs:
  workflow_path:
    value: |
      {% if blocks.validate_workflow.succeeded %}
      {{inputs.workflow_path}}
      {% else %}
      {{blocks.save_fixed_yaml.outputs.path}}
      {% endif %}
    type: str
    description: "Path to final YAML file (original or fixed)"

  is_valid:
    value: "{{blocks.validate_workflow.succeeded}}"
    type: bool
    description: "Whether validation passed"

  was_fixed:
    value: "{{blocks.validate_workflow.failed}}"
    type: bool
    description: "Whether LLM fix was applied"
