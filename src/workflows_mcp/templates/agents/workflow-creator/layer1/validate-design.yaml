name: validate-design
description: Validate the structure of a generated workflow JSON definition
version: "1.1"
tags: [agents, internal, validation]

inputs:
  json_path:
    type: str
    description: "Path to the workflow JSON file to validate"
    required: true

blocks:
  - id: validate
    type: Shell
    inputs:
      command: |
        python3 - <<'EOF'
        import json
        import sys

        def validate_workflow(json_path):
            """Validate workflow JSON structure (name, description, inputs, blocks, outputs)."""
            try:
                with open(json_path, 'r') as f:
                    workflow = json.load(f)
            except Exception as e:
                print(f"Error loading JSON: {e}")
                return False

            # Workflow structure validation
            required_fields = ["name", "description", "inputs", "blocks", "outputs"]
            for field in required_fields:
                if field not in workflow:
                    print(f"Missing workflow field: {field}")
                    return False

            # Validate inputs is a list (can be empty for some workflows)
            inputs = workflow.get("inputs", [])
            if not isinstance(inputs, list):
                print("inputs must be a list")
                return False

            # Validate outputs is a list
            outputs = workflow.get("outputs", [])
            if not isinstance(outputs, list):
                print("outputs must be a list")
                return False

            blocks = workflow["blocks"]
            if not isinstance(blocks, list):
                print("blocks must be a list")
                return False

            if not blocks:
                print("blocks cannot be empty - workflow must have at least one block")
                return False

            block_ids = set()
            for block in blocks:
                if "id" not in block:
                    print("Block missing id")
                    return False
                if block["id"] in block_ids:
                    print(f"Duplicate block id: {block['id']}")
                    return False
                block_ids.add(block["id"])

                # Validate block has required fields
                if "type" not in block:
                    print(f"Block '{block['id']}' missing type")
                    return False

            # Dependency validation - check references exist
            for block in blocks:
                if "depends_on" in block:
                    deps = block["depends_on"]
                    if isinstance(deps, str):
                        deps = [deps]

                    for dep in deps:
                        # Handle object style depends_on (e.g. {block: "id", required: false})
                        dep_id = dep
                        if isinstance(dep, dict):
                            dep_id = dep.get("block")

                        if dep_id not in block_ids:
                            print(f"Block '{block['id']}' depends on unknown block: {dep_id}")
                            return False

            # DAG cycle detection using DFS
            def get_deps(block):
                deps = block.get("depends_on", [])
                if isinstance(deps, str):
                    deps = [deps]
                result = []
                for dep in deps:
                    if isinstance(dep, dict):
                        result.append(dep.get("block"))
                    else:
                        result.append(dep)
                return result

            # Build adjacency list
            graph = {block["id"]: get_deps(block) for block in blocks}

            # DFS cycle detection
            WHITE, GRAY, BLACK = 0, 1, 2
            color = {bid: WHITE for bid in block_ids}
            cycle_path = []

            def dfs(node, path):
                if color[node] == GRAY:
                    cycle_start = path.index(node)
                    cycle_path.extend(path[cycle_start:] + [node])
                    return True
                if color[node] == BLACK:
                    return False
                color[node] = GRAY
                path.append(node)
                for neighbor in graph.get(node, []):
                    if neighbor and dfs(neighbor, path):
                        return True
                path.pop()
                color[node] = BLACK
                return False

            for bid in block_ids:
                if color[bid] == WHITE:
                    if dfs(bid, []):
                        cycle_str = " -> ".join(cycle_path)
                        print(f"DAG cycle detected: {cycle_str}")
                        print("Workflows must be acyclic. Remove the back-edge to fix.")
                        return False

            print("Workflow JSON structure is valid.")
            return True

        if __name__ == "__main__":
            json_path = "{{inputs.json_path}}"
            success = validate_workflow(json_path)
            sys.exit(0 if success else 1)
        EOF

outputs:
  success:
    value: "{{blocks.validate.succeeded}}"
    type: bool
    description: "Whether validation passed"

  message:
    value: "{{blocks.validate.outputs.stdout}}"
    type: str
    description: "Validation output message"
