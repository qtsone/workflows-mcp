name: finalize-and-save
description: Finalize workflow creation - save, validate, report, and cleanup
version: "1.1"
tags: [agents, finalization, internal]

inputs:
  workflow_name:
    type: str
    description: "(Required) Name of the workflow (for file naming)"
    required: true

  yaml_content:
    type: str
    description: "(Required) Final validated workflow YAML content"
    required: true

  path:
    type: str
    description: "(Required) Desired output path for the workflow file"
    required: true

  tmp_dir:
    type: str
    description: "(Required)Temporary directory to cleanup (from bootstrap)"
    required: true

  workflows_mcp_path:
    type: str
    description: "(Required) Directory path where validation script is located"
    required: true

  validation_attempts:
    type: num
    description: "(Optional) Number of validation attempts made"
    default: 1

blocks:
  - id: save_final_workflow
    type: CreateFile
    description: "Save final workflow to desired location"
    inputs:
      path: "{{inputs.path}}"
      create_parents: true
      overwrite: true
      content: "{{inputs.yaml_content}}"

  - id: final_validation
    type: Shell
    description: "Final validation check"
    inputs:
      working_dir: "{{inputs.workflows_mcp_path}}"
      command: |
        python validate.py "{{blocks.save_final_workflow.outputs.path}}"

        if [ $? -eq 0 ]; then
          echo "âœ“ Final validation PASSED"
        else
          echo "âœ— Final validation FAILED"
          echo "Warning: The workflow was saved but may have validation issues"
        fi
    continue_on_error: true
    depends_on: [save_final_workflow]

  - id: generate_summary
    type: Shell
    description: "Generate summary report"
    inputs:
      command: |
        cat <<'EOF'

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        WORKFLOW CREATION SUMMARY
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        Workflow Name:       {{inputs.workflow_name}}
        Output Path:         {{blocks.save_final_workflow.outputs.path}}
        File Size:           {{blocks.save_final_workflow.outputs.size_bytes}} bytes

        Validation Attempts: {{inputs.validation_attempts}}
        Final Validation:    {% if blocks.final_validation.outputs.exit_code == 0 %}âœ“ PASSED{% else %}âœ— FAILED{% endif %}

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        IMPORTANT: TESTING LIMITATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        âš ï¸  The workflow has been saved but CANNOT be tested now.
        âš ï¸  The MCP server MUST be restarted to load new workflows.

        This is a known limitation of the MCP server architecture.
        Workflows are loaded at server startup, not dynamically.

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        NEXT STEPS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        1. RESTART MCP Server
           â€¢ Stop the current MCP server process
           â€¢ Start it again to reload workflow templates

        2. Test Your Workflow
           Use the execute_workflow tool:

           execute_workflow(
             workflow="{{inputs.workflow_name}}",
             inputs={
               # Add your workflow inputs here
             }
           )

        3. Iterate and Improve
           â€¢ Review the generated workflow YAML
           â€¢ Make manual adjustments if needed
           â€¢ Test with different inputs
           â€¢ Add error handling and edge cases

        4. Share and Document
           â€¢ Add workflow documentation (description, usage examples)
           â€¢ Consider adding the workflow to the templates library
           â€¢ Share with your team if applicable

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        Workflow creation completed successfully! ðŸŽ‰

        EOF
    depends_on: [final_validation]

  - id: cleanup_temp_files
    type: Shell
    description: "Cleanup temporary files"
    inputs:
      command: |
        echo "Cleaning up temporary files..."

        # Remove cloned repository
        if [ -d "{{inputs.tmp_dir}}" ]; then
          rm -rf "{{inputs.tmp_dir}}"
          echo "âœ“ Removed temporary repository: {{inputs.tmp_dir}}"
        fi

        # Remove draft workflow files
        DRAFT_PATTERN="{{tmp}}/draft-workflow-attempt-*.yaml"
        if ls $DRAFT_PATTERN 1> /dev/null 2>&1; then
          rm -f $DRAFT_PATTERN
          echo "âœ“ Removed draft workflow files"
        fi

        echo "Cleanup completed"
    continue_on_error: true
    depends_on: [generate_summary]

outputs:
  workflow_path:
    value: "{{blocks.save_final_workflow.outputs.path}}"
    type: str
    description: "Path to the saved workflow file"

  workflow_name:
    value: "{{inputs.workflow_name}}"
    type: str
    description: "Name of the created workflow"

  file_size:
    value: "{{blocks.save_final_workflow.outputs.size_bytes}}"
    type: num
    description: "Size of the workflow file in bytes"

  validation_passed:
    value: "{{blocks.final_validation.outputs.exit_code == 0}}"
    type: bool
    description: "Whether final validation passed"

  summary:
    value: "{{blocks.generate_summary.outputs.stdout}}"
    type: str
    description: "Complete summary report"

  cleanup_completed:
    value: "{{blocks.cleanup_temp_files.succeeded}}"
    type: bool
    description: "Whether cleanup completed successfully"

  next_steps:
    value: |
      1. Restart the MCP server to load the new workflow
      2. Test with: execute_workflow(workflow="{{inputs.workflow_name}}", inputs={...})
      3. Review and refine the generated YAML as needed
    type: str
    description: "Next steps for the user"
