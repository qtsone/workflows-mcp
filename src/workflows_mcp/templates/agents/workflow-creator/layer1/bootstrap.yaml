name: workflow-creator-bootstrap
description: Bootstrap workflow creator context by fetching static reference docs from workflows-mcp repository
version: "2.0"
tags: [agents, bootstrap, internal]

inputs:
  repo:
    type: str
    description: "(Optional) URL of workflows-mcp repository"
    default: "https://github.com/qtsone/workflows-mcp.git"
    required: false

  ref:
    type: str
    description: "(Optional) Git ref to checkout (branch, tag, commit)"
    default: "main"
    required: false

  workspace:
    type: str
    description: "(Optional) Workspace directory"
    default: "/tmp/workflow-creator-bootstrap"

  sparse_checkout:
    type: str
    description: "(Optional) Sparse checkout patterns (comma-separated)"
    default: "llm_schema.json,validate.py,docs/llm/block-reference.md,docs/llm/block-schemas.json,tests/workflows,src/workflows_mcp/templates"
    required: false

blocks:
  # Check if workspace already has required files (cache hit)
  # Validates each sparse_checkout pattern exists
  - id: check_cache
    description: "Check if required files already exist"
    type: Shell
    inputs:
      working_dir: "{{inputs.workspace}}"
      command: |
        {% for pattern in inputs.sparse_checkout.split(',') -%}
        test -e "{{ pattern | trim }}" || { echo "Missing: {{ pattern | trim }}"; exit 1; }
        {% endfor -%}
        echo "Cache valid: all patterns exist"

  # Clone repository with sparse checkout (only if cache miss)
  - id: checkout
    description: "Clone workflows-mcp repository"
    type: Workflow
    depends_on:
      - block: check_cache
        required: false
    condition: "{{ not blocks.check_cache.succeeded }}"
    inputs:
      workflow: git-checkout
      inputs:
        repo: "{{inputs.repo}}"
        ref: "{{inputs.ref}}"
        workspace: "{{inputs.workspace}}"
        sparse_checkout: "{{inputs.sparse_checkout}}"

  # Read the static block reference (authoritative, CI-verified)
  - id: read_block_reference
    description: "Read static block executor reference"
    type: ReadFiles
    inputs:
      base_path: "{{inputs.workspace}}/docs/llm"
      patterns:
        - "block-reference.md"
      mode: "full"
    depends_on:
      - block: check_cache
        required: false
      - block: checkout
        required: false

  # Read the JSON schemas for structured output
  - id: read_block_schemas
    description: "Read block schemas JSON"
    type: ReadFiles
    inputs:
      base_path: "{{inputs.workspace}}/docs/llm"
      patterns:
        - "block-schemas.json"
      mode: "full"
    depends_on:
      - block: check_cache
        required: false
      - block: checkout
        required: false

  # Read example workflows for reference
  - id: read_examples
    description: "Read example workflows"
    type: ReadFiles
    inputs:
      base_path: "{{inputs.workspace}}/tests/workflows"
      patterns:
        - "**/*.yaml"
      mode: "outline"
    depends_on:
      - block: check_cache
        required: false
      - block: checkout
        required: false

  # Read built-in templates for reference
  - id: read_templates
    description: "Read built-in workflow templates"
    type: ReadFiles
    inputs:
      base_path: "{{inputs.workspace}}/src/workflows_mcp/templates"
      patterns:
        - "**/*.yaml"
      mode: "outline"
    depends_on:
      - block: check_cache
        required: false
      - block: checkout
        required: false

outputs:
  workspace:
    value: "{{inputs.workspace}}"
    type: str
    description: "Workspace directory containing the repo"

  schema_path:
    value: "{{inputs.workspace}}/llm_schema.json"
    type: str
    description: "Path to LLM-compatible workflow schema (for structured outputs)"

  executor_docs:
    value: "{{inputs.workspace}}/docs/llm/block-reference.md"
    type: str
    description: "Path to static block executor reference (CI-verified)"

  executor_schemas_json:
    value: "{{inputs.workspace}}/docs/llm/block-schemas.json"
    type: str
    description: "Path to block schemas JSON"

  examples:
    value: "{{blocks.read_examples.outputs.content}}"
    type: str
    description: "Example workflows for reference"

  templates:
    value: "{{blocks.read_templates.outputs.content}}"
    type: str
    description: "Production workflow templates"

  bootstrap_success:
    value: "{{blocks.read_block_reference.succeeded}}"
    type: bool
    description: "Bootstrap completed successfully"
