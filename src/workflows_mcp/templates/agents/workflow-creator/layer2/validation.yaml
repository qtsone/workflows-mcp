name: workflow-creator-validation
description: Recursively validate and fix a workflow until it passes or max attempts reached
version: "1.0"
tags: [agents, recursive, validation, internal]

inputs:
  workflow_path:
    type: str
    description: "Path to workflow YAML file to validate"
    required: true

  schema_path:
    type: str
    description: "Path to LLM-compatible schema JSON file"
    required: true

  executor_docs_path:
    type: str
    description: "Executor documentation for fix context"
    required: true

  workflows_mcp_path:
    type: str
    description: "Directory path where validation is located"
    required: true

  index:
    type: num
    description: "Current attempt number"
    default: 1

  limit:
    type: num
    description: "Maximum number of validation attempts"
    default: 5

  workspace:
    type: str
    description: "(Optional) Workspace path for temporary files"
    default: "{{tmp}}"

blocks:
  - id: validate_workflow
    description: "Validate the YAML file"
    type: Shell
    inputs:
      working_dir: "{{inputs.workflows_mcp_path}}"
      command: |
        python validate.py "{{inputs.workflow_path}}"

  - id: request_approval
    description: "Notify user that we hit limit and ask for approval"
    type: Prompt
    depends_on:
      - block: validate_workflow
        required: false
    condition: "{{blocks.validate_workflow.failed and (inputs.index >= inputs.limit)}}"
    inputs:
      prompt: |
        # WORKFLOW Validation - ITERATION {{inputs.index}}
        ⚠️ You've made {{inputs.index}}/{{inputs.limit}} validation attempts. This is getting expensive. Max depth is 50.
        Continue?
        Respond only with "yes" or "no".

  - id: system_prompt
    description: "System prompt for validation"
    depends_on:
      - block: validate_workflow
        required: false
      - block: request_approval
        required: false
    condition: >-
      {{(blocks.validate_workflow.failed and blocks.request_approval.skipped) or
      (blocks.validate_workflow.failed and blocks.request_approval.succeeded and blocks.request_approval.outputs.response | lower | trim == 'yes')}}
    type: CreateFile
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/system_prompt-{{inputs.index}}.md"
      content: |
        You are an expert workflow debugger.
        Your task is to fix validation errors in workflow YAML files.

        # Principles
        1. **Strict Adherence**: Follow the Block Executor Reference exactly.
        2. **Minimal Changes**: Fix only what is broken. Preserve intent.
        3. **Valid YAML**: Ensure the output is valid YAML.
        4. **Field Names**: Use 'prompt' for LLMCall/Prompt, 'command' for Shell.
        5. **DAG Rules**: depends_on must be ACYCLIC. No circular references.
           - If error mentions "cycle" or "circular": remove the back-edge
           - Block A cannot depend on B if B already depends on A
           - depends_on should only reference blocks defined BEFORE current block

  - id: user_prompt
    description: "User prompt for validation"
    depends_on: [system_prompt]
    type: CreateFile
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/user_prompt-{{inputs.index}}.md"
      content: |
        # Reference Material
        <executor_docs>
        {{ read_file(inputs.executor_docs_path) | replace('# ', '## ') }}
        </executor_docs>

        # Task: Fix Workflow Validation Errors

        The workflow YAML file failed validation. Analyze errors and fix them.

        ## Original YAML workflow
        ```yaml
        {{ read_file(inputs.workflow_path) }}
        ```

        ## Validation Errors
        ```sh
        {{blocks.validate_workflow.outputs.stdout}}
        ```
        ## Instructions
        1. **Analyze the errors**: Read the error messages and understand what is wrong with the current workflow.
        2. **Check field names**: Refer to the Executor Documentation for correct field names
        3. **Fix the issues**: Correct field names, syntax, structure errors
        4. **Preserve intent**: Critical to keep the workflow's purpose and logic intact
        5. **Make minimal changes**: Only fix what is broken. Preserve intent.

        Return the complete corrected workflow structure.

  - id: fix_validation_errors
    description: "Fix validation errors"
    depends_on: [system_prompt, user_prompt]
    type: LLMCall
    inputs:
      profile: default
      timeout: 600
      response_schema: "{{ read_file(inputs.schema_path) | fromjson}}"
      system_instructions: |
        {{ blocks.system_prompt.outputs.content }}
      prompt: |
        {{ blocks.user_prompt.outputs.content }}

  - id: store_workflow
    description: "Save fixed YAML to file"
    depends_on: [fix_validation_errors]
    type: CreateFile
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/workflow-v{{inputs.index}}.yaml"
      content: |
        {{blocks.fix_validation_errors.outputs.response | toyaml}}

  - id: recurse
    description: "Recurse if a new workflow was created"
    type: Workflow
    depends_on: [store_workflow]
    inputs:
      workflow: workflow-creator-validation
      inputs:
        workflow_path: "{{blocks.store_workflow.outputs.path}}"
        schema_path: "{{inputs.schema_path}}"
        executor_docs_path: "{{inputs.executor_docs_path}}"
        workflows_mcp_path: "{{inputs.workflows_mcp_path}}"
        index: "{{inputs.index + 1}}"
        limit: "{{inputs.limit}}"
        workspace: "{{inputs.workspace}}"

outputs:
  workflow_path:
    value: >-
      {{blocks.recurse.outputs.workflow_path
      if blocks.recurse.succeeded
      else inputs.workflow_path}}
    type: str
    description: "Path to the final (potentially fixed) workflow file"

  approved:
    value: >-
      {{blocks.recurse.outputs.approved
      if blocks.recurse.succeeded
      else blocks.validate_workflow.succeeded}}
    type: bool
    description: "Whether the final workflow is valid"

  iterations:
    description: "Total iterations used"
    type: num
    value: >-
      {{blocks.recurse.outputs.iterations
      if blocks.recurse.succeeded
      else inputs.index}}
