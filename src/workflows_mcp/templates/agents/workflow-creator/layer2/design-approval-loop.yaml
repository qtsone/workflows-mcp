name: design-approval-loop
description: Recursive workflow for iterative design approval with user feedback
version: "1.0"
tags: [agents, recursive, interactive, internal]

inputs:
  requirements:
    type: dict
    description: "Structured workflow requirements from requirements gathering"
    required: true

  executor_docs:
    type: str
    description: "Compressed executor reference documentation"
    required: true

  examples:
    type: str
    description: "Example workflows for reference"
    required: true

  iteration:
    type: num
    description: "Current iteration number (for recursion)"
    default: 1

  max_iterations:
    type: num
    description: "Maximum number of refinement iterations"
    default: 5

  previous_diagram:
    type: str
    description: "Previous diagram (for refinement iterations)"
    default: ""

  feedback:
    type: str
    description: "User feedback from previous iteration"
    default: ""

blocks:
  # Phase 1: Generate or refine workflow diagram
  - id: generate_diagram
    type: LLMCall
    inputs:
      profile: default
      timeout: 600
      system_instructions: |
        You are an expert workflow architect specializing in DAG-based automation workflows.

        # CRITICAL: Block Type Required Fields

        When designing workflows, each block type has specific REQUIRED input fields:

        | Block Type     | Required Field(s)                    |
        |----------------|--------------------------------------|
        | Shell          | command                              |
        | LLMCall        | prompt (NOT 'command' or 'message')  |
        | Prompt         | prompt (NOT 'command' or 'message')  |
        | ImageGen       | prompt, profile OR provider          |
        | CreateFile     | path, content                        |
        | EditFile       | path, operations                     |
        | ReadFiles      | patterns                             |
        | HttpCall       | url                                  |
        | Workflow       | workflow                             |
        | ReadJSONState  | path                                 |
        | WriteJSONState | path, data                           |
        | MergeJSONState | path, updates                        |

        âš ï¸ IMPORTANT FIELD NAMING:
        - LLMCall uses 'prompt' (NOT 'command')
        - Prompt uses 'prompt' (NOT 'message' or 'command')
        - Only Shell uses 'command'

        # Design Principles

        - **Single responsibility**: Each block has one clear purpose
        - **Appropriate block types**: Shell for commands, LLMCall for AI, Prompt for user input, CreateFile for output
        - **Parallelism**: Run independent operations concurrently using depends_on
        - **User involvement**: Use Prompt blocks for approvals and feedback loops
        - **Error handling**: Use conditions and continue_on_error where appropriate

        # Available Block Types

        {{inputs.executor_docs}}

        # Example Workflows

        Study these patterns for reference:

        {{inputs.examples}}

        # Mermaid Diagram Syntax

        ```
        flowchart TD
          subgraph inputs[Workflow Inputs]
            I1[param_name: type]
            I2[another_param: type]
          end

          subgraph blocks[Workflow Blocks]
            B1[Shell: setup-step]
            B2[LLMCall: process-data]
            B3[Prompt: user-confirmation]
            B4[CreateFile: save-output]
          end

          subgraph outputs[Workflow Outputs]
            O1[result: type]
          end

          I1 & I2 --> B1
          B1 --> B2
          B2 --> B3
          B3 -->|approved| B4
          B3 -->|rejected| END[Cancel]
          B4 --> O1
        ```

        Key syntax:
        - `A & B --> C` = parallel inputs
        - `A -->|condition| B` = conditional edge
        - `subgraph name[Label]` = grouping

        # Required Output Format

        Return a JSON object with these fields:

        1. **mermaid_diagram**: Raw Mermaid flowchart syntax
           - Start directly with "flowchart TD" (NO markdown code fences)
           - Use newlines (\n) to separate lines

        2. **block_summary**: Array of block objects:
           - "id": block ID (lowercase, hyphenated)
           - "type": block type (Shell, LLMCall, Prompt, etc.)
           - "purpose": one-sentence description
           - "depends_on": array of block IDs this depends on

        3. **explanation**: Design rationale string

        4. **clarifications**: Array of questions/assumptions to validate

        Example:
        ```json
        {
          "mermaid_diagram": "flowchart TD\n  subgraph inputs[Workflow Inputs]\n    I1[code_path: str]\n  end\n  subgraph blocks[Workflow Blocks]\n    B1[Shell: run-linter]\n    B2[LLMCall: analyze]\n  end\n  I1 --> B1\n  B1 --> B2",
          "block_summary": [
            {"id": "run-linter", "type": "Shell", "purpose": "Run linting checks", "depends_on": []},
            {"id": "analyze", "type": "LLMCall", "purpose": "AI code analysis", "depends_on": ["run-linter"]}
          ],
          "explanation": "Sequential flow: lint first, then AI analysis",
          "clarifications": ["Should linting failures stop the workflow?"]
        }
        ```
      prompt: |
        {% if inputs.iteration == 1 %}
        # Design New Workflow

        Create a Mermaid flowchart diagram for this workflow:

        ## Requirements

        {{inputs.requirements | tojson}}

        ## Instructions

        Design the architecture with:
        1. **Inputs subgraph**: All workflow input parameters
        2. **Blocks**: Processing steps as `[BlockType: block-id]` nodes
        3. **Dependencies**: Arrows showing execution flow
        4. **Parallel paths**: Use `&` syntax for concurrent operations
        5. **Conditions**: Use `-->|condition|` for conditional flows
        6. **Outputs subgraph**: Workflow outputs

        Generate the initial design now.
        {% else %}
        # Refine Workflow Design (Iteration {{inputs.iteration}})

        ## Requirements (unchanged)

        {{inputs.requirements | tojson}}

        ## Current Design

        {{inputs.previous_diagram}}

        ## User Feedback

        {{inputs.feedback}}

        ## Instructions

        Refine the diagram based on the feedback above.
        - Address all user concerns
        - Maintain valid Mermaid syntax
        - Explain what you changed and why

        Generate the refined design now.
        {% endif %}
      response_schema:
        type: object
        properties:
          mermaid_diagram:
            type: string
            description: "Raw Mermaid flowchart syntax starting with 'flowchart TD' - NO markdown code fences or backticks"
          block_summary:
            type: array
            items:
              type: object
              properties:
                id:
                  type: string
                  description: "Block ID (lowercase, hyphenated)"
                type:
                  type: string
                  description: "Block type (Shell, LLMCall, Prompt, etc.)"
                purpose:
                  type: string
                  description: "What this block does (one sentence)"
                depends_on:
                  type: array
                  items:
                    type: string
                  description: "Block IDs this depends on"
              required:
                - id
                - type
                - purpose
                - depends_on
            description: "Summary of each block in the workflow"
          explanation:
            type: string
            description: "Design choices and rationale"
          clarifications:
            type: array
            items:
              type: string
            description: "Questions or assumptions to validate"
        required:
          - mermaid_diagram
          - block_summary
          - explanation
          - clarifications
        additionalProperties: false

  # Phase 1b: Create HTML viewer for the diagram
  - id: create_diagram_viewer
    type: CreateFile
    inputs:
      path: "{{tmp}}/workflow-diagram-{{inputs.iteration}}.html"
      content: |
        <!DOCTYPE html>
        <html>
        <head>
          <title>Workflow Design - Iteration {{inputs.iteration}}</title>
          <script type="module">
            import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
            mermaid.initialize({ startOnLoad: true, theme: 'default' });
          </script>
          <style>
            body { font-family: system-ui, -apple-system, sans-serif; padding: 2rem; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
            h1 { color: #333; margin-bottom: 0.5rem; }
            .subtitle { color: #666; margin-bottom: 2rem; }
            .mermaid { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
          </style>
        </head>
        <body>
          <h1>Workflow Design</h1>
          <p class="subtitle">Iteration {{inputs.iteration}} of {{inputs.max_iterations}}</p>
          <div class="mermaid">
        {{blocks.generate_diagram.outputs.response.mermaid_diagram}}
          </div>
        </body>
        </html>
      overwrite: true
      create_parents: true
    depends_on: [generate_diagram]

  # Phase 2: Present diagram to user for approval
  - id: request_approval
    type: Prompt
    inputs:
      prompt: |
        # WORKFLOW DESIGN - ITERATION {{inputs.iteration}}/{{inputs.max_iterations}}

        ## ðŸ“Š View Diagram

        Open this file in your browser to see the visual workflow diagram:
        **{{blocks.create_diagram_viewer.outputs.path}}**

        ## Block Summary

        | Block ID | Type | Purpose |
        |----------|------|---------|
        {% for item in blocks.generate_diagram.outputs.response.block_summary %}
        | `{{ item.id }}` | {{ item.type }} | {{ item.purpose }} |
        {% endfor %}

        ## Design Explanation

        {{blocks.generate_diagram.outputs.response.explanation}}

        {% if blocks.generate_diagram.outputs.response.clarifications %}
        ## Clarifications Needed

        {% for clarification in blocks.generate_diagram.outputs.response.clarifications %}
        â€¢ {{ clarification }}
        {% endfor %}
        {% endif %}

        ---

        Please review the workflow design above.

        Your options:
        â€¢ Type "approve" - Proceed with workflow generation
        â€¢ Type "refine" - Provide feedback for improvements
        â€¢ Type "cancel" - Stop workflow creation

        IMPORTANT: Respond with ONLY one word: "approve", "refine", or "cancel"

        Your response:
    depends_on: [generate_diagram, create_diagram_viewer]

  # Phase 3: Handle user decision
  - id: check_response
    type: Shell
    inputs:
      command: |
        RESPONSE="{{blocks.request_approval.outputs.response | lower | trim}}"
        echo "User response: $RESPONSE"

        if [ "$RESPONSE" = "approve" ]; then
          echo "STATUS=approved"
        elif [ "$RESPONSE" = "refine" ]; then
          echo "STATUS=refine"
        elif [ "$RESPONSE" = "cancel" ]; then
          echo "STATUS=cancelled"
        else
          echo "STATUS=invalid"
          echo "ERROR: Invalid response. Must be exactly 'approve', 'refine', or 'cancel'"
          echo "Received: $RESPONSE"
          exit 1
        fi
    depends_on: [request_approval]

  # Phase 4: Gather refinement feedback (only if user chose "refine")
  - id: gather_refinement_feedback
    type: Prompt
    condition: >-
      {{blocks.request_approval.outputs.response | lower | trim == 'refine' and
       inputs.iteration < inputs.max_iterations}}
    inputs:
      prompt: |
        Please describe what you'd like to change or improve in the workflow design:

        (Be specific about which blocks, flow, or logic needs adjustment)
    depends_on: [check_response]

  # Phase 5: Check if max iterations reached
  - id: check_max_iterations
    type: Shell
    condition: >-
      {{blocks.request_approval.outputs.response | lower | trim == 'refine' and
       inputs.iteration >= inputs.max_iterations}}
    inputs:
      command: |
        echo "âš ï¸  Maximum iterations ({{inputs.max_iterations}}) reached."
        echo "The current design will be used for workflow generation."
        echo "You can cancel now and restart if major changes are needed."
    depends_on: [check_response]

  # Phase 6: Recursive call for refinement (only if under max iterations)
  - id: recurse_refinement
    type: Workflow
    condition: >-
      {{blocks.request_approval.outputs.response | lower | trim == 'refine' and
       inputs.iteration < inputs.max_iterations}}
    inputs:
      workflow: design-approval-loop
      inputs:
        requirements: "{{inputs.requirements}}"
        executor_docs: "{{inputs.executor_docs}}"
        examples: "{{inputs.examples}}"
        iteration: "{{inputs.iteration + 1}}"
        max_iterations: "{{inputs.max_iterations}}"
        previous_diagram: "{{blocks.generate_diagram.outputs.response.mermaid_diagram}}"
        feedback: "{{blocks.gather_refinement_feedback.outputs.response}}"
    depends_on: [gather_refinement_feedback]

outputs:
  final_diagram:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.final_diagram}}
      {% else %}
      {{blocks.generate_diagram.outputs.response.mermaid_diagram}}
      {% endif %}
    type: str
    description: "Final approved Mermaid workflow diagram"

  final_block_summary:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.final_block_summary}}
      {% else %}
      {{blocks.generate_diagram.outputs.response.block_summary | tojson}}
      {% endif %}
    type: str
    description: "Final block summary as JSON"

  final_explanation:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.final_explanation}}
      {% else %}
      {{blocks.generate_diagram.outputs.response.explanation}}
      {% endif %}
    type: str
    description: "Final design explanation"

  diagram_viewer_path:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.diagram_viewer_path}}
      {% else %}
      {{blocks.create_diagram_viewer.outputs.path}}
      {% endif %}
    type: str
    description: "Path to HTML file for viewing the diagram"

  user_decision:
    value: "{{blocks.request_approval.outputs.response | lower | trim}}"
    type: str
    description: "User's final decision (approve/refine/cancel)"

  iterations_used:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.iterations_used}}
      {% else %}
      {{inputs.iteration}}
      {% endif %}
    type: num
    description: "Total number of iterations used"

  approved:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.approved}}
      {% else %}
      {{blocks.request_approval.outputs.response | lower | trim == 'approve' or
        (blocks.request_approval.outputs.response | lower | trim == 'refine' and
         inputs.iteration >= inputs.max_iterations)}}
      {% endif %}
    type: bool
    description: "Whether design was approved (explicitly or by reaching max iterations)"
