name: design-approval-loop
description: Recursive workflow for iterative design approval with user feedback
version: "1.1"
tags: [agents, recursive, interactive, internal]

inputs:
  requirements:
    type: str
    description: "(Required) Path to structured workflow requirements JSON file"
    required: true

  executor_docs:
    type: str
    description: "(Required) Path to compressed executor reference documentation"
    required: true

  examples:
    type: str
    description: "(Required) Example workflows for reference"
    required: true

  previous_diagram:
    type: str
    description: "(Optional) Previous diagram (for refinement iterations)"
    default: ""

  feedback:
    type: str
    description: "(Optional) User feedback from previous iteration"
    default: ""

  workspace:
    type: str
    description: "(Optional) Workspace path for temporary files"
    default: "{{tmp}}"

blocks:
  - id: read_requirements
    type: ReadJSONState
    inputs:
      path: "{{inputs.requirements}}"

  - id: generate_diagram
    description: "Generate or refine workflow diagram"
    type: LLMCall
    depends_on: [read_requirements]
    inputs:
      profile: default
      timeout: 600
      system_instructions: |
        You are an expert workflow architect specializing in DAG-based automation workflows.

        # Design Principles
        - **Single responsibility**: Each block has one clear purpose
        - **Appropriate block types**: Shell for commands, LLMCall for AI, Prompt for user input, CreateFile for output
        - **Parallelism**: Run independent operations concurrently using depends_on
        - **User involvement**: Use Prompt blocks for approvals and feedback loops
        - **Error handling**: Use conditions and continue_on_error where appropriate

        # Mermaid Diagram Syntax Rules
        1. **Nodes**: `B1[BlockType: block-id]` (e.g., `[Shell: run-script]`)
        2. **Edges**: `-->` for flow, `-->|label|` for conditions
        3. **Parallel edges**: Use separate lines for each edge (NOT `&` syntax)
        4. **Subgraphs**: Use `subgraph inputs` and `subgraph blocks` and `subgraph outputs`
        5. **IDs**: Lowercase, hyphenated (e.g., `process-data`)

        # Required Output Format
        Return a JSON object with:
        1. **mermaid_diagram**: Raw Mermaid flowchart syntax (start with "flowchart TD")
        2. **block_summary**: Array of {id, type, purpose, depends_on}
        3. **explanation**: Design rationale
        4. **clarifications**: Questions/assumptions
      prompt: |
        # Reference Material

        ## Block Executor Reference
        <executor_docs>
        {{ read_file(inputs.executor_docs) }}
        </executor_docs>

        ## Example Workflows
        <examples>
        {{inputs.examples}}
        </examples>

        {% if depth == 1 %}
        # Design New Workflow

        Create a Mermaid flowchart diagram for this workflow:

        ## Requirements
        <requirements>
        {{ read_file(inputs.requirements) | tojson }}
        </requirements>

        ## Instructions
        Design the architecture with:
        1. **Inputs subgraph**: All workflow input parameters
        2. **Blocks**: Processing steps as `[BlockType: block-id]` nodes
        3. **Dependencies**: Arrows showing execution flow
        4. **Parallel paths**: Use separate edge lines for concurrent operations
        5. **Conditions**: Use `-->|condition|` for conditional flows
        6. **Outputs subgraph**: Workflow outputs

        Generate the initial design now.
        {% else %}
        # Refine Workflow Design (Iteration {{depth}})

        ## Current Design
        <previous_diagram>
        {{inputs.previous_diagram}}
        </previous_diagram>

        ## User Feedback
        <feedback>
        {{inputs.feedback}}
        </feedback>

        ## Instructions
        Refine the diagram based on the feedback above.
        - Address all user concerns
        - Maintain valid Mermaid syntax
        - Explain what you changed and why

        Generate the refined design now.
        {% endif %}
      response_schema:
        type: object
        properties:
          mermaid_diagram:
            type: string
            description: "Raw Mermaid flowchart syntax starting with 'flowchart TD' - NO markdown code fences or backticks"
          block_summary:
            type: array
            items:
              type: object
              properties:
                id:
                  type: string
                  description: "Block ID (lowercase, hyphenated)"
                type:
                  type: string
                  description: "Block type (Shell, LLMCall, Prompt, etc.)"
                purpose:
                  type: string
                  description: "What this block does (one sentence)"
                depends_on:
                  type: array
                  items:
                    type: string
                  description: "Block IDs this depends on"
              required:
                - id
                - type
                - purpose
                - depends_on
            description: "Summary of each block in the workflow"
          explanation:
            type: string
            description: "Design choices and rationale"
          clarifications:
            type: array
            items:
              type: string
            description: "Questions or assumptions to validate"
        required:
          - mermaid_diagram
          - block_summary
          - explanation
          - clarifications
        additionalProperties: false

  - id: create_diagram_viewer
    description: "Create HTML viewer for the diagram"
    type: CreateFile
    depends_on: [generate_diagram]
    inputs:
      path: "{{inputs.workspace}}/diagram-{{depth}}.html"
      create_parents: true
      overwrite: true
      content: |
        <!DOCTYPE html>
        <html>
        <head>
          <title>Workflow Design - Iteration {{depth}}</title>
          <script type="module">
            import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
            mermaid.initialize({ startOnLoad: true, theme: 'default' });
          </script>
          <style>
            body { font-family: system-ui, -apple-system, sans-serif; padding: 2rem; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
            h1 { color: #333; margin-bottom: 0.5rem; }
            .subtitle { color: #666; margin-bottom: 2rem; }
            .mermaid { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
          </style>
        </head>
        <body>
          <h1>Workflow Design</h1>
          <p class="subtitle">Iteration {{depth}}</p>
          <div class="mermaid">
        {{blocks.generate_diagram.outputs.response.mermaid_diagram}}
          </div>
        </body>
        </html>

  - id: request_approval
    description: "Present diagram to user for approval"
    type: Prompt
    depends_on: [create_diagram_viewer]
    inputs:
      prompt: |
        # WORKFLOW DESIGN - ITERATION {{depth}}
        {% if depth > 10 %}

        ⚠️ You've made {{depth}} refinements. This is getting expensive. Max depth is 50.
        {% endif %}

        ## Diagram

        Open this [diagram]({{blocks.create_diagram_viewer.outputs.path}}) in your browser to see the visual workflow diagram.

        ## Block Summary

        | Block ID | Type | Purpose |
        |----------|------|---------|
        {% for item in blocks.generate_diagram.outputs.response.block_summary %}
        | `{{ item.id }}` | {{ item.type }} | {{ item.purpose }} |
        {% endfor %}

        ## Design Explanation

        {{blocks.generate_diagram.outputs.response.explanation}}

        {% if blocks.generate_diagram.outputs.response.clarifications %}
        ## Clarifications Needed

        {% for clarification in blocks.generate_diagram.outputs.response.clarifications %}
        • {{ clarification }}
        {% endfor %}
        {% endif %}

        ---

        Please review the workflow design above.

        To approve: Respond with "approve"
        To refine: Respond with your feedback directly below describing what needs to change.

        Your response:

  - id: recurse_refinement
    description: "Recursive call for refinement"
    depends_on: [request_approval]
    condition: "{{blocks.request_approval.outputs.response | lower | trim != 'approve'}}"
    type: Workflow
    inputs:
      workflow: design-approval-loop
      inputs:
        requirements: "{{inputs.requirements}}"
        executor_docs: "{{inputs.executor_docs}}"
        examples: "{{inputs.examples}}"
        previous_diagram: "{{blocks.generate_diagram.outputs.response.mermaid_diagram}}"
        feedback: "{{blocks.request_approval.outputs.response}}"

outputs:
  final_diagram:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.final_diagram}}
      {% else %}
      {{blocks.generate_diagram.outputs.response.mermaid_diagram}}
      {% endif %}
    type: str
    description: "Final approved Mermaid workflow diagram"

  final_block_summary:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.final_block_summary}}
      {% else %}
      {{blocks.generate_diagram.outputs.response.block_summary | tojson}}
      {% endif %}
    type: str
    description: "Final block summary as JSON"

  final_explanation:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.final_explanation}}
      {% else %}
      {{blocks.generate_diagram.outputs.response.explanation}}
      {% endif %}
    type: str
    description: "Final design explanation"

  diagram_viewer_path:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.diagram_viewer_path}}
      {% else %}
      {{blocks.create_diagram_viewer.outputs.path}}
      {% endif %}
    type: str
    description: "Path to HTML file for viewing the diagram"

  user_decision:
    value: "{{ 'approve' if blocks.request_approval.outputs.response | lower | trim == 'approve' else 'refine' }}"
    type: str
    description: "User's final decision (approve/refine)"

  approved:
    value: |
      {% if blocks.recurse_refinement.succeeded %}
      {{blocks.recurse_refinement.outputs.approved}}
      {% else %}
      {{blocks.request_approval.outputs.response | lower | trim == 'approve'}}
      {% endif %}
    type: bool
    description: "Whether design was approved"
