name: workflow-creator-design
description: Recursive workflow for iterative design approval with user feedback
version: "1.2"
tags: [agents, recursive, interactive, internal]

inputs:
  requirements_path:
    type: str
    description: "(Required) Path to structured workflow requirements JSON file"
    required: true

  executor_docs_path:
    type: str
    description: "(Required) Path to compressed executor reference documentation"
    required: true

  diagram_path:
    type: str
    description: "(Optional) Previous diagram (for refinement iterations)"
    default: ""

  feedback:
    type: str
    description: "(Optional) User feedback from previous iteration"
    default: ""

  workspace:
    type: str
    description: "(Optional) Workspace path for temporary files"
    default: "{{tmp}}"

  index:
    type: num
    description: "(Optional) Index of the current iteration"
    default: 1
    required: false

blocks:
  - id: system_prompt
    description: "Log the current iteration"
    type: CreateFile
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/system-prompt-{{inputs.index}}.md"
      content: |
        You are an expert workflow architect for DAG-based automation workflows.

        # Design Principles
        - Single responsibility per block
        - Block types: Shell (commands), LLMCall (AI), Prompt (user input), CreateFile (files)
        - Parallelism via depends_on for concurrent operations

        # IMPORTANT: DAG Flow (No Cycles)
        - Workflows are DAGs (Directed Acyclic Graphs) - arrows ONLY point forward
        - NO circular/back edges - if A --> B exists, B --> A is INVALID
        - User approval: Use SEQUENTIAL flow with conditions, not cycles
          Example: generate --> prompt_approval --> next_step (condition: approved)

        # Mermaid Syntax (CRITICAL - follow exactly)

        ## Edge Syntax
        ✅ CORRECT: `A --> B`           — unlabeled edge
        ✅ CORRECT: `A -->|label| B`    — labeled edge (pipes wrap label AFTER arrow)
        ❌ WRONG:   `A --|label|--> B`  — INVALID syntax, never use
        ❌ WRONG:   `A -- label --> B`  — INVALID syntax, never use

        ## Edge Label Rules (CRITICAL - prevents parsing errors)
        Edge labels MUST only use simple characters:
        ✅ ALLOWED: letters, numbers, spaces, hyphens, underscores
        ❌ FORBIDDEN in labels:
          - `<` `>` `<=` `>=` (comparison operators break parsing)
          - `(` `)` parentheses (confuse the parser)
          - `{` `}` braces
          - `[` `]` brackets
          - `&` `|` `"` `'` special chars

        Examples:
        ✅ `-->|approved|`
        ✅ `-->|revise - max N loops|`
        ✅ `-->|more chapters|`
        ❌ `-->|revise (<= max)|` — parentheses and <= break parsing
        ❌ `-->|text(s)|` — parentheses break parsing

        ## Node ID Rules (CRITICAL - prevents parsing errors)
        Node IDs MUST use underscores, NOT hyphens:
        ✅ CORRECT: `my_node[Type: my-label]`    — underscore in ID, hyphen in label OK
        ✅ CORRECT: `overview_llm[LLMCall: overview-gen]`
        ❌ WRONG: `my-node[Type: my-label]`      — hyphens in IDs break Mermaid parsing
        ❌ WRONG: `input-name[Input: name]`      — will cause syntax error

        Labels inside brackets [...] can contain hyphens, but the ID before the bracket MUST use underscores.

        ## Node Label Rules (CRITICAL - prevents parsing errors)
        Two syntaxes depending on content:

        **Simple labels (no special chars):** No outer quotes needed
        ✅ `my_node[Shell: validate inputs]`
        ✅ `ask_user[Prompt: What is your name]`

        **Labels with special chars ({ } ( ) [ ] ' " # & < >):** MUST wrap entire label in double quotes
        ✅ `shell_echo["Shell: echo 'Hello, {name}!'"]` — outer double quotes, single quotes inside
        ✅ `my_node["LLMCall: Generate user's response"]` — apostrophe is fine inside double quotes
        ✅ `calc["Shell: expr (1 + 2)"]` — parentheses safe inside double quotes
        ❌ `shell_echo[Shell: echo "Hello"]` — unquoted label with double quotes breaks parsing
        ❌ `my_node[Shell: {var}]` — unquoted label with braces breaks parsing

        **Rule:** If your label text includes ANY special character, wrap the ENTIRE label in double quotes and use single quotes for any internal quoting.

        ## Parallel Execution (CRITICAL - no special syntax exists)
        Mermaid has NO `parallel`, `fork`, `join`, or `&` keywords. Parallelism is IMPLICIT.
        Just write multiple edges - if two nodes have no dependency, they run in parallel.
        ✅ CORRECT:
        ```
        A --> B
        A --> C
        B --> D
        C --> D
        ```
        (B and C run in parallel after A, both feed into D)

        ❌ WRONG - these keywords DO NOT EXIST:
        ```
        parallel
          A --> B
          A --> C
        end
        ```

        ## Structure
        - Node format: `node_id[Type: label]` with lowercase_underscored IDs
        - Start diagram with `flowchart TD`
        - Use subgraphs ONLY for: `inputs`, `blocks`, `outputs`
        - One edge per line

        # Output Format
        JSON: {mermaid_diagram, explanation, clarifications}
        Note: inputs, blocks, and outputs are arrays (lists), not objects.

  - id: user_prompt
    description: "Log the LLM prompt"
    type: CreateFile
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/user-prompt-{{inputs.index}}.md"
      content: |
        # Reference Material

        <executor_docs>
        {{ read_file(inputs.executor_docs_path) | replace('# ', '## ') }}
        </executor_docs>

        {%- if inputs.index == 1 %}
        # Design New Workflow
        Create a Mermaid flowchart diagram for this workflow:

        ## Instructions
        Design the architecture with:
        1. **Inputs subgraph**: All workflow input parameters
        2. **Blocks**: Processing steps as `[BlockType: short-descriptive-id]` nodes
           - Use SHORT descriptive IDs like `echo-greeting`, `validate-input`, `call-api`
           - Do NOT put actual commands/content in labels (wrong: `echo "Hello"`, right: `echo-greeting`)
        3. **Dependencies**: Arrows showing execution flow
        4. **Parallel paths**: Just write separate edges (NO `parallel` keyword exists!)
        5. **Conditions**: Use `-->|condition|` for conditional flows
        6. **Outputs subgraph**: Workflow outputs

        Generate the initial design now.
        {% else %}
        # Refine Workflow Design (Iteration {{ inputs.index }})

        ## Current Design
        ```mermaid
        {{read_file(inputs.diagram_path)}}
        ```

        ## User Feedback
        ```
        {{inputs.feedback}}
        ```

        ## Instructions
        Refine the diagram based on the feedback above.
        - Address all user concerns
        - Maintain valid Mermaid syntax
        - Explain what you changed and why

        Generate the refined design now.
        {% endif %}
        ## Requirements
        Follow the requirements below closely. Beware of overengineering. Do not add extra features, or complexity beyond what is specified.
        ```json
        {{ read_file(inputs.requirements_path) | fromjson | prettyjson }}
        ```

  - id: generate_design
    description: "Generate or refine workflow diagram"
    depends_on: [system_prompt, user_prompt]
    type: LLMCall
    inputs:
      profile: default
      timeout: 600
      response_schema:
        type: object
        properties:
          mermaid_diagram:
            type: string
            description: "Raw Mermaid flowchart syntax starting with 'flowchart TD' - NO markdown code fences or backticks"
          explanation:
            type: string
            description: "Design choices and rationale"
          clarifications:
            type: array
            items:
              type: string
            description: "Questions or assumptions to validate"
        required:
          - mermaid_diagram
        additionalProperties: false
      system_instructions: |
        {{ blocks.system_prompt.outputs.content }}
      prompt: |
        {{ blocks.user_prompt.outputs.content }}

  - id: store_response
    description: "Save design to temp file for validation"
    type: CreateFile
    depends_on: [generate_design]
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/response-v{{inputs.index}}.json"
      content: |
        {{blocks.generate_design.outputs.response | prettyjson}}

  - id: store_diagram
    description: "Store the design diagram"
    depends_on: [generate_design]
    type: CreateFile
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/diagram-v{{inputs.index}}.mermaid"
      content: |
        {{blocks.generate_design.outputs.response.mermaid_diagram | replace('\\n', '\n') | replace('\\t', '\t') | replace('\\r', '\r')}}

  - id: store_html_page
    description: "Create HTML viewer for the diagram"
    type: CreateFile
    depends_on: [store_diagram]
    inputs:
      create_parents: true
      overwrite: true
      path: "{{inputs.workspace}}/render-v{{inputs.index}}.html"
      content: |
        <!DOCTYPE html>
        <html>
        <head>
          <title>Workflow Design - Iteration {{inputs.index}}</title>
          <script type="module">
            import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
            mermaid.initialize({ startOnLoad: true, theme: 'default' });
          </script>
          <style>
            body { font-family: system-ui, -apple-system, sans-serif; padding: 2rem; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
            h1 { color: #333; margin-bottom: 0.5rem; }
            .subtitle { color: #666; margin-bottom: 2rem; }
            .mermaid { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
          </style>
        </head>
        <body>
          <h1>Workflow Design</h1>
          <p class="subtitle">Iteration {{inputs.index}}</p>
          <div class="mermaid">
        {{blocks.store_diagram.outputs.content}}
          </div>
        </body>
        </html>

  - id: request_feedback
    description: "Present diagram to user for approval"
    type: Prompt
    depends_on: [store_html_page]
    inputs:
      prompt: |
        # WORKFLOW DESIGN - ITERATION {{inputs.index}}
        {%- if inputs.index > 10 %}
        ⚠️ You've made {{inputs.index}} refinements. This is getting expensive. Max depth is 50.
        {%- endif %}

        ## Diagram
        Prompt the user to open this HTML page: {{blocks.store_html_page.outputs.path}} in the browser to see the visual workflow diagram.

        {%- if blocks.generate_design.outputs.response.explanation %}
        ## Design Explanation
        {{blocks.generate_design.outputs.response.explanation}}
        {%- endif %}

        {%- if blocks.generate_design.outputs.response.clarifications %}
        ## Clarifications Needed
        {%- for clarification in blocks.generate_design.outputs.response.clarifications %}
        - {{ clarification }}
        {%- endfor %}
        {%- endif %}
        ---
        Please review the workflow design and diagram
        To approve - respond with "approve"
        To refine - respond with your feedback directly, describing what needs to change.
        Your response:

  - id: recurse_refinement
    description: "Recursive call for refinement"
    depends_on: [request_feedback]
    condition: >-
      {{blocks.request_feedback.outputs.response | trim != '' and
        blocks.request_feedback.outputs.response | lower | trim != 'approve'}}
    type: Workflow
    inputs:
      workflow: workflow-creator-design
      inputs:
        workspace: "{{inputs.workspace}}"
        index: "{{inputs.index + 1}}"
        requirements_path: "{{inputs.requirements_path}}"
        executor_docs_path: "{{inputs.executor_docs_path}}"
        diagram_path: "{{blocks.store_diagram.outputs.path}}"
        feedback: "{{blocks.request_feedback.outputs.response}}"

outputs:
  diagram_path:
    value: >-
      {{blocks.recurse_refinement.outputs.diagram_path
      if blocks.recurse_refinement.succeeded
      else blocks.store_diagram.outputs.path}}
    type: str
    description: "Path to the final approved Mermaid workflow diagram"

  explanation:
    value: >-
      {{blocks.recurse_refinement.outputs.explanation
      if blocks.recurse_refinement.succeeded
      else blocks.generate_design.outputs.response.explanation}}
    type: str
    description: "Final design explanation"

  html_diagram:
    value: >-
      {{blocks.recurse_refinement.outputs.html_diagram
      if blocks.recurse_refinement.succeeded
      else blocks.store_html_page.outputs.path}}
    type: str
    description: "Path to HTML file for viewing the diagram"

  approved:
    value: >-
      {{blocks.recurse_refinement.outputs.approved
      if blocks.recurse_refinement.succeeded
      else (blocks.request_feedback.outputs.response | lower | trim == 'approve')}}
    type: bool
    description: "Whether design was approved"
