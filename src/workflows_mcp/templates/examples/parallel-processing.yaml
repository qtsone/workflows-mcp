name: parallel-processing
description: Demonstrates parallel workflow execution with DAG convergence and dependency management
version: "1.0"
author: Workflows MCP Team
tags: [example, examples, parallel, dag, performance, advanced]
inputs:
  project_path:
    type: str
    description: Project directory for processing
    default: "."

  enable_linting:
    type: bool
    description: Enable linting in parallel
    default: true

  enable_testing:
    type: bool
    description: Enable testing in parallel
    default: true

  enable_docs:
    type: bool
    description: Enable documentation generation in parallel
    default: true

  convergence_timeout:
    type: int
    description: Timeout for parallel operations (seconds)
    default: 600

blocks:
  # Build initialization message
  - id: build_init_message
    type: Shell
    inputs:
      command: |
        MSG="Initializing parallel processing demo with"
        if [ "${inputs.enable_linting}" = "true" ]; then
          MSG="$MSG linting"
        fi
        if [ "${inputs.enable_testing}" = "true" ]; then
          MSG="$MSG testing"
        fi
        if [ "${inputs.enable_docs}" = "true" ]; then
          MSG="$MSG docs"
        fi
        echo "$MSG"
      timeout: 5

  # Initialization (Wave 1)
  - id: init_parallel_demo
    type: EchoBlock
    inputs:
      message: "${blocks.build_init_message.outputs.stdout}"
    depends_on:
      - build_init_message

  # Parallel Branch 1: Linting (Wave 2)
  - id: parallel_linting
    type: Workflow
    inputs:
      workflow: "lint-python"
      inputs:
        working_dir: "${inputs.project_path}"
        src_path: "src/"
        strict_mode: false
        fix_issues: false
    depends_on:
      - init_parallel_demo
    condition: "${inputs.enable_linting}"

  # Parallel Branch 2: Testing (Wave 2)
  - id: parallel_testing
    type: Workflow
    inputs:
      workflow: "run-pytest"
      inputs:
        working_dir: "${inputs.project_path}"
        test_path: "tests/"
        coverage_threshold: 75
        verbose: false
    depends_on:
      - init_parallel_demo
    condition: "${inputs.enable_testing}"

  # Parallel Branch 3: Documentation Generation (Wave 2)
  - id: parallel_docs
    type: Workflow
    inputs:
      workflow: "generate-readme"
      inputs:
        project_name: "Parallel Processing Demo"
        description: "Demonstrates parallel workflow execution"
        output_path: "${inputs.project_path}/PARALLEL_DEMO.md"
        create_template_if_missing: true
    depends_on:
      - init_parallel_demo
    condition: "${inputs.enable_docs}"

  # Parallel Branch 4: Configuration Processing (Wave 2)
  - id: parallel_config
    type: Shell
    inputs:
      command: 'echo ''{"parallel_execution": true, "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"}'' > ${inputs.project_path}/parallel_config.json'
      timeout: 30
    depends_on:
      - init_parallel_demo

  # Get branch statuses
  - id: get_linting_status
    type: Shell
    inputs:
      command: |
        if [ "${inputs.enable_linting}" = "true" ]; then
          if [ "${blocks.parallel_linting.all_passed}" = "true" ]; then
            echo '✓ PASSED'
          else
            echo '✗ FAILED'
          fi
        else
          echo '⊘ DISABLED'
        fi
      timeout: 5

    depends_on:
      - parallel_linting

  - id: get_testing_status
    type: Shell
    inputs:
      command: "echo '✓ PASSED'"
      timeout: 5

    condition: "${inputs.enable_testing} and ${blocks.parallel_testing.succeeded}"
    depends_on:
      - parallel_testing

  - id: get_testing_status_failed
    type: Shell
    inputs:
      command: "echo '✗ FAILED'"
      timeout: 5

    condition: "${inputs.enable_testing} and not ${blocks.parallel_testing.succeeded}"
    depends_on:
      - parallel_testing

  - id: get_testing_status_disabled
    type: Shell
    inputs:
      command: "echo '⊘ DISABLED'"
      timeout: 5

    condition: "not ${inputs.enable_testing}"
    depends_on:
      - parallel_testing

  - id: get_docs_status
    type: Shell
    inputs:
      command: "echo '✓ GENERATED'"
      timeout: 5

    condition: "${inputs.enable_docs} and ${blocks.parallel_docs.succeeded}"
    depends_on:
      - parallel_docs

  - id: get_docs_status_failed
    type: Shell
    inputs:
      command: "echo '✗ FAILED'"
      timeout: 5

    condition: "${inputs.enable_docs} and not ${blocks.parallel_docs.succeeded}"
    depends_on:
      - parallel_docs

  - id: get_docs_status_disabled
    type: Shell
    inputs:
      command: "echo '⊘ DISABLED'"
      timeout: 5

    condition: "not ${inputs.enable_docs}"
    depends_on:
      - parallel_docs

  - id: get_config_status
    type: Shell
    inputs:
      command: "test ${blocks.parallel_config.outputs.exit_code} -eq 0 && echo '✓ PROCESSED' || echo '✗ FAILED'"
      timeout: 5

    depends_on:
      - parallel_config

  # Consolidate status outputs
  - id: consolidate_testing_status
    type: Shell
    inputs:
      command: |
        STATUS_PASSED="${blocks.get_testing_status.outputs.stdout}"
        STATUS_FAILED="${blocks.get_testing_status_failed.outputs.stdout}"
        STATUS_DISABLED="${blocks.get_testing_status_disabled.outputs.stdout}"
        if [ -n "$STATUS_PASSED" ]; then
          echo "$STATUS_PASSED"
        elif [ -n "$STATUS_FAILED" ]; then
          echo "$STATUS_FAILED"
        else
          echo "$STATUS_DISABLED"
        fi
      timeout: 5

    depends_on:
      - get_testing_status
      - get_testing_status_failed
      - get_testing_status_disabled

  - id: consolidate_docs_status
    type: Shell
    inputs:
      command: |
        STATUS_PASSED="${blocks.get_docs_status.outputs.stdout}"
        STATUS_FAILED="${blocks.get_docs_status_failed.outputs.stdout}"
        STATUS_DISABLED="${blocks.get_docs_status_disabled.outputs.stdout}"
        if [ -n "$STATUS_PASSED" ]; then
          echo "$STATUS_PASSED"
        elif [ -n "$STATUS_FAILED" ]; then
          echo "$STATUS_FAILED"
        else
          echo "$STATUS_DISABLED"
        fi
      timeout: 5

    depends_on:
      - get_docs_status
      - get_docs_status_failed
      - get_docs_status_disabled

  # Convergence Point: Collect parallel results (Wave 3)
  - id: collect_results
    type: EchoBlock
    inputs:
      message: |
        Parallel Execution Results:
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        Branch 1 (Linting):   ${blocks.get_linting_status.outputs.stdout}
        Branch 2 (Testing):   ${blocks.consolidate_testing_status.outputs.stdout}
        Branch 3 (Docs):      ${blocks.consolidate_docs_status.outputs.stdout}
        Branch 4 (Config):    ${blocks.get_config_status.outputs.stdout}
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    depends_on:
      - get_linting_status
      - consolidate_testing_status
      - consolidate_docs_status
      - get_config_status

  # Get performance displays
  - id: get_linting_time
    type: Shell
    inputs:
      command: "test '${inputs.enable_linting}' = 'true' && echo '${blocks.parallel_linting.total_execution_time_ms}ms' || echo 'N/A'"
      timeout: 5

    depends_on:
      - collect_results

  - id: get_testing_time
    type: Shell
    inputs:
      command: "test '${inputs.enable_testing}' = 'true' && echo '${blocks.parallel_testing.metadata.execution_time_ms}ms' || echo 'N/A'"
      timeout: 5

    depends_on:
      - collect_results

  - id: get_docs_time
    type: Shell
    inputs:
      command: "test '${inputs.enable_docs}' = 'true' && echo 'Complete' || echo 'N/A'"
      timeout: 5

    depends_on:
      - collect_results

  # Post-convergence analysis (Wave 4)
  - id: analyze_performance
    type: EchoBlock
    inputs:
      message: |
        Performance Analysis:
        - Linting time: ${blocks.get_linting_time.outputs.stdout}
        - Testing time: ${blocks.get_testing_time.outputs.stdout}
        - Docs time: ${blocks.get_docs_time.outputs.stdout}
        - Config time: ${blocks.parallel_config.metadata.execution_time_ms}ms
    depends_on:
      - get_linting_time
      - get_testing_time
      - get_docs_time

  # Conditional post-processing based on parallel results (Wave 5)
  - id: post_process_if_all_pass
    type: EchoBlock
    inputs:
      message: "All parallel branches passed! Proceeding with post-processing."
    depends_on:
      - analyze_performance
    condition: "(not ${inputs.enable_linting} or ${blocks.parallel_linting.all_passed}) and (not ${inputs.enable_testing} or ${blocks.parallel_testing.succeeded}) and (not ${inputs.enable_docs} or ${blocks.parallel_docs.succeeded}) and ${blocks.parallel_config.outputs.exit_code} == 0"

  # Get post-processing display
  - id: get_post_processing_display
    type: Shell
    inputs:
      command: "test -n '${blocks.post_process_if_all_pass.outputs.echoed}' && echo '✓ Executed' || echo '⊘ Skipped (failures detected)'"
      timeout: 5

    depends_on:
      - post_process_if_all_pass

  # Get overall status display (success)
  - id: get_overall_status_display_success
    type: Shell
    inputs:
      command: "echo '✓ SUCCESS'"
      timeout: 5

    condition: "(not ${inputs.enable_linting} or ${blocks.parallel_linting.all_passed}) and (not ${inputs.enable_testing} or ${blocks.parallel_testing.succeeded}) and (not ${inputs.enable_docs} or ${blocks.parallel_docs.succeeded}) and ${blocks.parallel_config.outputs.exit_code} == 0"
    depends_on:
      - post_process_if_all_pass
      - analyze_performance

  # Get overall status display (partial success)
  - id: get_overall_status_display_partial
    type: Shell
    inputs:
      command: "echo '⚠ PARTIAL SUCCESS'"
      timeout: 5

    condition: "not ((not ${inputs.enable_linting} or ${blocks.parallel_linting.all_passed}) and (not ${inputs.enable_testing} or ${blocks.parallel_testing.succeeded}) and (not ${inputs.enable_docs} or ${blocks.parallel_docs.succeeded}) and ${blocks.parallel_config.outputs.exit_code} == 0)"
    depends_on:
      - post_process_if_all_pass
      - analyze_performance

  # Consolidate overall status
  - id: get_overall_status_display
    type: Shell
    inputs:
      command: |
        STATUS_SUCCESS="${blocks.get_overall_status_display_success.outputs.stdout}"
        STATUS_PARTIAL="${blocks.get_overall_status_display_partial.outputs.stdout}"
        if [ -n "$STATUS_SUCCESS" ]; then
          echo "$STATUS_SUCCESS"
        else
          echo "$STATUS_PARTIAL"
        fi
      timeout: 5

    depends_on:
      - get_overall_status_display_success
      - get_overall_status_display_partial

  # Final summary with DAG statistics (Wave 6)
  - id: final_summary
    type: EchoBlock
    inputs:
      message: |
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        Parallel Processing Demo Complete
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        DAG Structure:
          - Initialization: 1 block (Wave 1)
          - Parallel Execution: 4 branches (Wave 2)
          - Convergence: 1 block (Wave 3)
          - Analysis: 1 block (Wave 4)
          - Post-processing: 1 block (Wave 5)
          - Summary: 1 block (Wave 6)

        Total Waves: 6
        Parallel Branches: 4
        Maximum Parallelism: 4 blocks/wave

        Results:
          ${blocks.collect_results.outputs.echoed}

        Performance:
          ${blocks.analyze_performance.outputs.echoed}

        Post-Processing: ${blocks.get_post_processing_display.outputs.stdout}

        Overall Status: ${blocks.get_overall_status_display.outputs.stdout}
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    depends_on:
      - get_post_processing_display
      - get_overall_status_display

outputs:
  success: "(not ${inputs.enable_linting} or ${blocks.parallel_linting.all_passed}) and (not ${inputs.enable_testing} or ${blocks.parallel_testing.succeeded}) and (not ${inputs.enable_docs} or ${blocks.parallel_docs.succeeded}) and ${blocks.parallel_config.outputs.exit_code} == 0"

  # Parallel branch results
  linting_enabled: "${inputs.enable_linting}"
  linting_passed: "${blocks.parallel_linting.all_passed}"

  testing_enabled: "${inputs.enable_testing}"
  testing_passed: "${blocks.parallel_testing.succeeded}"

  docs_enabled: "${inputs.enable_docs}"
  docs_generated: "${blocks.parallel_docs.succeeded}"

  config_processed: "${blocks.parallel_config.outputs.exit_code} == 0"

  # DAG statistics
  total_waves: "6"
  parallel_branches: "4"
  max_parallelism: "4"

  # Summary
  summary: "${blocks.final_summary.outputs.echoed}"
  convergence_point_message: "${blocks.collect_results.outputs.echoed}"
