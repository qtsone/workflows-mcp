name: uv-install
description: Install Python package using uv (fast Python package installer) with venv support
version: "1.0"
author: Workflows MCP Team
tags: [tools, provider, uv, python, installation, fast]
inputs:
  package_name:
    type: str
    description: Package name to install (e.g., "pytest", "ruff")
    required: true
  version:
    type: str
    description: Version constraint (e.g., ">=7.0.0", "==7.4.3", "~=7.4")
    default: ""
  venv_path:
    type: str
    description: Virtual environment path (e.g., ".venv", "venv")
    default: ""
  extras:
    type: str
    description: Package extras to install (e.g., "testing,dev")
    default: ""
blocks:
  # Check if uv is available
  - id: check_uv_available
    type: Shell
    inputs:
      command: "command -v uv >/dev/null 2>&1"
      timeout: 5
  # Build uv installation command
  - id: build_install_command
    type: Shell
    inputs:
      command: |
        # Build package specification
        PACKAGE="{{inputs.package_name}}"

        # Add extras if provided
        if [ -n "{{inputs.extras}}" ]; then
          PACKAGE="${PACKAGE}[{{inputs.extras}}]"
        fi

        # Add version constraint if provided
        if [ -n "{{inputs.version}}" ]; then
          PACKAGE="${PACKAGE}{{inputs.version}}"
        fi

        # Build uv pip install command
        # uv pip install works with venv activation or --python flag
        if [ -n "{{inputs.venv_path}}" ]; then
          CMD="uv pip install --python {{inputs.venv_path}}/bin/python \"$PACKAGE\""
        else
          CMD="uv pip install \"$PACKAGE\""
        fi

        echo "$CMD"
      timeout: 5
    condition: "{{blocks.check_uv_available.succeeded}}"
    depends_on:
      - check_uv_available
  # Execute uv install
  - id: install_package
    type: Shell
    inputs:
      command: "{{blocks.build_install_command.outputs.stdout}}"
      timeout: 300
    depends_on:
      - build_install_command
  # Verify installation succeeded
  - id: verify_installation
    type: Shell
    inputs:
      command: |
        # Determine python executable (prefer venv if available)
        if [ -n "{{inputs.venv_path}}" ] && [ -f "{{inputs.venv_path}}/bin/python" ]; then
          PYTHON="{{inputs.venv_path}}/bin/python"
        else
          PYTHON="python3"
        fi

        # Try to import the package
        if $PYTHON -c "import {{inputs.package_name}}" 2>/dev/null; then
          # Get installed version
          VERSION=$($PYTHON -c "import {{inputs.package_name}}; print(getattr({{inputs.package_name}}, '__version__', 'unknown'))" 2>/dev/null || echo "unknown")
          echo "$VERSION"
        else
          echo "not_installed"
        fi
      timeout: 10
    depends_on:
      - install_package
  # Determine installation location
  - id: get_install_location
    type: Shell
    inputs:
      command: |
        # Determine python executable (prefer venv if available)
        if [ -n "{{inputs.venv_path}}" ] && [ -f "{{inputs.venv_path}}/bin/python" ]; then
          PYTHON="{{inputs.venv_path}}/bin/python"
        else
          PYTHON="python3"
        fi

        # Get package location
        LOCATION=$($PYTHON -c "import {{inputs.package_name}}; import os; print(os.path.dirname({{inputs.package_name}}.__file__))" 2>/dev/null || echo "unknown")
        echo "$LOCATION"
      timeout: 10
    depends_on:
      - verify_installation
  # Generate installation summary
  - id: installation_summary
    type: Shell
    inputs:
      command: |
        printf "uv Installation Summary:\n"
        printf "- Package: {{inputs.package_name}}\n"
        printf "- Version Constraint: {{inputs.version}}\n"
        printf "- Extras: {{inputs.extras}}\n"
        printf "- uv Available: {{blocks.check_uv_available.succeeded}}\n"
        printf "- Exit Code: {{blocks.install_package.outputs.exit_code}}\n"
        printf "- Installed Version: {{blocks.verify_installation.outputs.stdout}}\n"
        printf "- Install Location: {{blocks.get_install_location.outputs.stdout}}\n"
        printf "- Command: {{blocks.build_install_command.outputs.stdout}}"
    depends_on:
      - check_uv_available
      - install_package
      - verify_installation
      - get_install_location
outputs:
  success:
    value: "{{blocks.install_package.outputs.exit_code}} == 0"
  installed_version:
    value: "{{blocks.verify_installation.outputs.stdout}}"
  install_location:
    value: "{{blocks.get_install_location.outputs.stdout}}"
  exit_code:
    value: "{{blocks.install_package.outputs.exit_code}}"
  stdout:
    value: "{{blocks.install_package.outputs.stdout}}"
  stderr:
    value: "{{blocks.install_package.outputs.stderr}}"
  command_executed:
    value: "{{blocks.build_install_command.outputs.stdout}}"
  uv_available:
    value: "{{blocks.check_uv_available.succeeded}}"
  summary:
    value: "{{blocks.installation_summary.outputs.stdout}}"
