name: conditional-deploy
description: Conditional deployment workflow with environment-specific logic and validation
version: "1.0"
author: Workflows MCP Team
tags: [ci, deployment, conditional, multi-environment, validation]
inputs:
  environment:
    type: str
    description: Target environment (dev, staging, production)
    default: "dev"

  deploy_path:
    type: str
    description: Deployment directory or path
    default: "./deploy"

  run_tests_first:
    type: bool
    description: Run tests before deployment
    default: true

  require_approval:
    type: bool
    description: Require manual approval (production only)
    default: false

  build_artifacts:
    type: bool
    description: Build artifacts before deployment
    default: true

  venv_path:
    type: str
    description: Virtual environment path for test execution
    default: ""

  auto_install:
    type: bool
    description: Automatically install testing tools if not found
    default: false

blocks:
  # Validate environment
  - id: validate_env
    type: Shell
    inputs:
      command: 'printf "Validating deployment to ${inputs.environment} environment"'

  # Run pre-deployment tests
  - id: run_tests
    type: Workflow
    inputs:
      workflow: "run-pytest"
      inputs:
        working_dir: "."
        test_path: "tests/"
        coverage_threshold: 80
        verbose: false
        venv_path: "${inputs.venv_path}"
        auto_install: "${inputs.auto_install}"
    depends_on:
      - validate_env
    condition: "${inputs.run_tests_first}"

  # Build artifacts
  - id: build_artifacts
    type: Shell
    inputs:
      command: "python -m build"
      working_dir: "."
      timeout: 300

    depends_on:
      - run_tests
    condition: "${inputs.build_artifacts} and (not ${inputs.run_tests_first} or ${blocks.run_tests.succeeded})"

  # Development deployment
  - id: deploy_dev
    type: Shell
    inputs:
      command: "echo 'Deploying to DEV environment at ${inputs.deploy_path}' && mkdir -p ${inputs.deploy_path}/dev"
      working_dir: "."
      timeout: 120
    depends_on:
      - build_artifacts
    condition: "${inputs.environment} == 'dev' and (not ${inputs.build_artifacts} or ${blocks.build_artifacts.outputs.exit_code} == 0)"

  # Staging deployment
  - id: deploy_staging
    type: Shell
    inputs:
      command: "echo 'Deploying to STAGING environment at ${inputs.deploy_path}' && mkdir -p ${inputs.deploy_path}/staging"
      working_dir: "."
      timeout: 300
    depends_on:
      - build_artifacts
    condition: "${inputs.environment} == 'staging' and (not ${inputs.build_artifacts} or ${blocks.build_artifacts.outputs.exit_code} == 0)"

  # Production deployment (requires approval)
  - id: production_check
    type: Shell
    inputs:
      command: 'printf "Production deployment requires approval: ${inputs.require_approval}"'
    depends_on:
      - build_artifacts
    condition: "${inputs.environment} == 'production'"

  - id: deploy_production
    type: Shell
    inputs:
      command: "echo 'Deploying to PRODUCTION environment at ${inputs.deploy_path}' && mkdir -p ${inputs.deploy_path}/production"
      working_dir: "."
      timeout: 600
    depends_on:
      - production_check
    condition: "${inputs.environment} == 'production' and not ${inputs.require_approval} and (not ${inputs.build_artifacts} or ${blocks.build_artifacts.outputs.exit_code} == 0)"

  # Post-deployment verification
  - id: verify_deployment
    type: Shell
    inputs:
      command: "ls -la ${inputs.deploy_path}/${inputs.environment} 2>/dev/null || echo 'Deployment directory not found'"
      working_dir: "."
      timeout: 30

    depends_on:
      - deploy_dev
      - deploy_staging
      - deploy_production

  # Generate status displays
  - id: get_test_display_passed
    type: Shell
    inputs:
      command: "echo '✓ PASSED'"
      timeout: 5

    condition: "${inputs.run_tests_first} and ${blocks.run_tests.succeeded}"
    depends_on:
      - run_tests

  - id: get_test_display_failed
    type: Shell
    inputs:
      command: "echo '✗ FAILED'"
      timeout: 5

    condition: "${inputs.run_tests_first} and not ${blocks.run_tests.succeeded}"
    depends_on:
      - run_tests

  - id: get_test_display_skipped
    type: Shell
    inputs:
      command: "echo '⊘ SKIPPED'"
      timeout: 5

    condition: "not ${inputs.run_tests_first}"
    depends_on:
      - run_tests

  - id: get_test_display
    type: Shell
    inputs:
      command: |
        STATUS_PASSED="${blocks.get_test_display_passed.outputs.stdout}"
        STATUS_FAILED="${blocks.get_test_display_failed.outputs.stdout}"
        STATUS_SKIPPED="${blocks.get_test_display_skipped.outputs.stdout}"
        if [ -n "$STATUS_PASSED" ]; then
          echo "$STATUS_PASSED"
        elif [ -n "$STATUS_FAILED" ]; then
          echo "$STATUS_FAILED"
        else
          echo "$STATUS_SKIPPED"
        fi
      timeout: 5

    depends_on:
      - get_test_display_passed
      - get_test_display_failed
      - get_test_display_skipped

  - id: get_artifacts_display
    type: Shell
    inputs:
      command: |
        if [ "${inputs.build_artifacts}" = "true" ]; then
          if [ ${blocks.build_artifacts.outputs.exit_code} -eq 0 ]; then
            echo '✓ SUCCESS'
          else
            echo '✗ FAILED'
          fi
        else
          echo '⊘ SKIPPED'
        fi
      timeout: 5

    depends_on:
      - build_artifacts

  - id: get_dev_display
    type: Shell
    inputs:
      command: |
        if [ "${inputs.environment}" = "dev" ]; then
          if [ ${blocks.deploy_dev.outputs.exit_code} -eq 0 ]; then
            echo '✓ DEPLOYED'
          else
            echo '✗ FAILED'
          fi
        else
          echo '⊘ N/A'
        fi
      timeout: 5

    depends_on:
      - deploy_dev

  - id: get_staging_display
    type: Shell
    inputs:
      command: |
        if [ "${inputs.environment}" = "staging" ]; then
          if [ ${blocks.deploy_staging.outputs.exit_code} -eq 0 ]; then
            echo '✓ DEPLOYED'
          else
            echo '✗ FAILED'
          fi
        else
          echo '⊘ N/A'
        fi
      timeout: 5

    depends_on:
      - deploy_staging

  - id: get_production_display
    type: Shell
    inputs:
      command: |
        if [ "${inputs.environment}" = "production" ]; then
          if [ "${inputs.require_approval}" = "true" ]; then
            echo '⊘ APPROVAL REQUIRED'
          else
            if [ ${blocks.deploy_production.outputs.exit_code} -eq 0 ]; then
              echo '✓ DEPLOYED'
            else
              echo '✗ FAILED'
            fi
          fi
        else
          echo '⊘ N/A'
        fi
      timeout: 5

    depends_on:
      - deploy_production

  # Generate deployment report
  - id: deployment_report
    type: Shell
    inputs:
      command: |
        printf "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"
        printf "Deployment Report\n"
        printf "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"
        printf "Environment: ${inputs.environment}\n"
        printf "Tests Run: ${blocks.get_test_display.outputs.stdout}\n"
        printf "Artifacts Built: ${blocks.get_artifacts_display.outputs.stdout}\n"
        printf "Deployment Status:\n"
        printf "  - Dev: ${blocks.get_dev_display.outputs.stdout}\n"
        printf "  - Staging: ${blocks.get_staging_display.outputs.stdout}\n"
        printf "  - Production: ${blocks.get_production_display.outputs.stdout}\n"
        printf "Verification: ${blocks.verify_deployment.outputs.stdout}\n"
        printf "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    depends_on:
      - get_test_display
      - get_artifacts_display
      - get_dev_display
      - get_staging_display
      - get_production_display
      - verify_deployment

outputs:
  # Deployment status
  deployed: "${(${inputs.environment} == 'dev' and ${blocks.deploy_dev.outputs.exit_code} == 0) or (${inputs.environment} == 'staging' and ${blocks.deploy_staging.outputs.exit_code} == 0) or (${inputs.environment} == 'production' and not ${inputs.require_approval} and ${blocks.deploy_production.outputs.exit_code} == 0)}"
  environment: "${inputs.environment}"

  # Test results
  tests_passed: "not ${inputs.run_tests_first} or ${blocks.run_tests.succeeded}"

  # Build results
  artifacts_built: "not ${inputs.build_artifacts} or ${blocks.build_artifacts.outputs.exit_code} == 0"

  # Environment-specific status
  dev_deployed: "${inputs.environment} == 'dev' and ${blocks.deploy_dev.outputs.exit_code} == 0"
  staging_deployed: "${inputs.environment} == 'staging' and ${blocks.deploy_staging.outputs.exit_code} == 0"
  production_deployed: "${inputs.environment} == 'production' and not ${inputs.require_approval} and ${blocks.deploy_production.outputs.exit_code} == 0"
  production_approval_required: "${inputs.environment} == 'production' and ${inputs.require_approval}"

  # Report
  report: "${blocks.deployment_report.outputs.stdout}"
  verification_output: "${blocks.verify_deployment.outputs.stdout}"
