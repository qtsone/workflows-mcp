name: git-analyze-changes
description: Analyze git repository for uncommitted changes and extract diff information
version: 1.0.0
tags: [git, diff, analysis]

inputs:
  working_dir:
    type: str
    description: (Optional) Working directory for git operations
    default: "."
    required: false

  staged_only:
    type: bool
    description: If true, only analyze staged changes (default). Set false to include unstaged/untracked.
    default: true
    required: false

blocks:
  - id: get_staged_summary
    type: Shell
    description: "Get diff statistics for staged changes"
    inputs:
      command: git diff --cached --stat --compact-summary > $SCRATCH/summary.txt
      working_dir: "{{inputs.working_dir}}"
    condition: "{{inputs.staged_only}}"

  - id: get_staged_diff
    type: Shell
    description: "Generate compact diff of staged changes"
    inputs:
      command: git diff --cached -U0 --inter-hunk-context=0 --no-color --no-prefix > $SCRATCH/raw_diff.txt
      working_dir: "{{inputs.working_dir}}"
    condition: "{{inputs.staged_only}}"

  - id: get_all_summary
    type: Shell
    description: "Get diff statistics for all changes (staged + unstaged)"
    inputs:
      command: git diff HEAD --stat --compact-summary > $SCRATCH/summary.txt
      working_dir: "{{inputs.working_dir}}"
    condition: "not {{inputs.staged_only}}"

  - id: get_all_diff
    type: Shell
    description: "Generate compact diff of all changes (staged + unstaged)"
    inputs:
      command: |
        git diff HEAD -U0 --inter-hunk-context=0 --no-color --no-prefix > $SCRATCH/raw_diff.txt
      working_dir: "{{inputs.working_dir}}"
    condition: "not {{inputs.staged_only}}"

  - id: processing
    type: Shell
    description: "Process and consolidate analysis results"
    inputs:
      command: |
        MAX_LINES=40

        # Process raw diff with line limiting
        if [ -f "$SCRATCH/raw_diff.txt" ]; then
          awk -v max="$MAX_LINES" '
          BEGIN { lines = 0; truncated = 0 }
          /^diff --git/ {
            if (truncated) {
              print "    ... (truncated " truncated " lines)\n"
            }
            lines = 0
            truncated = 0
            print
            next
          }
          {
            if (lines < max) {
              print
              lines++
            } else {
              truncated++
            }
          }
          END {
            if (truncated) {
              print "    ... (truncated " truncated " lines)"
            }
          }
          ' "$SCRATCH/raw_diff.txt" > "$SCRATCH/processed_diff.txt"
        else
          touch "$SCRATCH/processed_diff.txt"
        fi
      working_dir: "{{inputs.working_dir}}"
    depends_on:
      - block: get_staged_summary
        required: false
      - block: get_staged_diff
        required: false
      - block: get_all_summary
        required: false
      - block: get_all_diff
        required: false
    outputs:
      summary:
        type: str
        path: "$SCRATCH/summary.txt"
      diff:
        type: str
        path: "$SCRATCH/processed_diff.txt"

outputs:
  has_changes: "{{blocks.get_staged_diff.succeeded}} or {{blocks.get_all_diff.succeeded}}"
  summary: "{{blocks.processing.outputs.summary}}"
  diff: "{{blocks.processing.outputs.diff}}"