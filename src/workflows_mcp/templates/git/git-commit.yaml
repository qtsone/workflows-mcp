name: git-commit
version: "6.0.0"
author: "workflows-mcp"
tags:
  - git
  - commit
  - semantic
  - interactive
  - breaking-changes
description: |
  Create semantic commits using LLM analysis of staged changes.

  Generates Conventional Commits by analyzing diffs for breaking changes (API, behavior, config).
  Ensures proper structure: type (feat, fix, etc.), scope, concise summary, and detailed body.

  Workflow:
  1. Options to stage files.
  2. Analyze changes & detect breaking changes.
  3. Generate message (with manual override).
  4. Review and confirm commit.

inputs:
  stage_all:
    type: bool
    default: false
    description: "(Optional) Stage all modified files before analyzing (default: use already staged files)"
    required: false

  workspace:
    type: str
    default: "."
    description: "(Optional) Path to the git repository"
    required: false

  auto:
    type: bool
    default: false
    description: "(Optional) Skip interactive confirmation and commit immediately with generated message"
    required: false

  message:
    type: str
    default: ""
    description: "(Optional) Manually provide commit message (bypasses LLM generation)"
    required: false

blocks:
  - id: stage_files
    type: Shell
    description: "Stage all modified files in git repository"
    inputs:
      working_dir: "{{inputs.workspace}}"
      command: git add -A
    condition: "{{inputs.stage_all}}"

  - id: analyze_changes
    type: Workflow
    description: "Analyze staged changes in git repository"
    depends_on:
      - block: stage_files
        required: false
    inputs:
      workflow: "git-analyze-changes"
      inputs:
        working_dir: "{{inputs.workspace}}"

  - id: no_changes_message
    type: Shell
    description: "No changes to commit"
    inputs:
      command: printf "No changes to commit"
    condition: "{{not blocks.analyze_changes.outputs.has_changes}}"
    depends_on: [analyze_changes]

  - id: system_prompt
    description: "Create system prompt for commit message generation"
    type: CreateFile
    depends_on: [analyze_changes]
    inputs:
      create_parents: true
      overwrite: true
      path: "{{tmp}}/system-prompt.md"
      content: |
        You are an expert at writing clear, semantic git commit messages following Conventional Commits.

        Your task: Analyze git diffs and generate structured commit messages that communicate intent clearly.

        Key principles:
        - Focus on WHAT changed and WHY, not HOW (code shows that)
        - Use imperative mood ("add feature" not "added feature")
        - Detect breaking changes by analyzing API, behavior, and config changes
        - Keep summaries under 70 characters

  - id: user_prompt
    description: "Create user prompt with git changes"
    type: CreateFile
    depends_on: [analyze_changes]
    inputs:
      create_parents: true
      overwrite: true
      path: "{{tmp}}/user-prompt.md"
      content: |
        # Task: Generate a Conventional Commit Message

        Analyze the git changes below and generate a structured commit message.

        ## Changes Summary
        {{blocks.analyze_changes.outputs.summary}}

        ## Diff
        ```diff
        {{blocks.analyze_changes.outputs.diff}}
        ```

        ---

        ## Response Fields

        ### type (REQUIRED)
        Choose exactly ONE:
        - `feat` = new feature or capability
        - `fix` = bug fix
        - `refactor` = code restructuring (no behavior change)
        - `perf` = performance improvement
        - `docs` = documentation only
        - `test` = adding or modifying tests
        - `chore` = tooling, dependencies, config
        - `ci` = CI/CD pipeline changes
        - `build` = build system changes
        - `revert` = reverting a previous commit

        ### summary (REQUIRED)
        Write a short description (max 70 characters):
        - Use imperative mood: "add" not "added", "fix" not "fixed"
        - All lowercase, no period at end
        - Describe WHAT changed
        - Example: "add user authentication endpoint"

        ### scope (OPTIONAL)
        The component or module affected. Examples: `api`, `auth`, `cli`, `parser`
        Leave empty ("") if the change spans multiple areas.

        ### body (OPTIONAL)
        Explain WHY this change was made (not HOW - the code shows that).
        Include when:
        - The reason for the change is not obvious from the summary
        - Multiple components were modified
        - There are important design decisions to document

        ### is_breaking (OPTIONAL, default: false)
        Set to `true` if this change breaks backward compatibility:
        - Function/method signatures changed (parameters added, removed, reordered)
        - Public functions, classes, or endpoints removed
        - Default values or validation rules changed
        - Required config fields added or renamed
        - Database schema changes requiring migration

        ### breaking_description (OPTIONAL)
        If is_breaking is true, explain:
        1. What specifically breaks
        2. How users should migrate their code

  - id: generate_message
    description: "Generate semantic commit message using LLM"
    condition: "{{blocks.analyze_changes.outputs.has_changes and inputs.message == ''}}"
    depends_on:
      - analyze_changes
      - system_prompt
      - user_prompt
    type: LLMCall
    inputs:
      profile: default
      timeout: 600
      response_schema:
        type: object
        required:
          - type
          - scope
          - summary
          - body
        properties:
          type:
            description: "(Required) Commit type following Conventional Commits"
            type: string
            enum:
              - feat
              - fix
              - docs
              - style
              - refactor
              - perf
              - test
              - chore
              - ci
              - build
              - revert
          scope:
            description: "(Optional) Component/module affected (optional, e.g., 'api', 'auth', 'config')"
            type: string
            default: ""
          summary:
            description: "(Required) Brief summary in imperative mood, lowercase, no period"
            type: string
            maxLength: 70
          body:
            description: "(Optional) Concise explanation of what changed and why"
            type: string
            default: ""
          is_breaking:
            description: "(Optional) Does this commit introduce breaking changes?(true/false)"
            type: boolean
            default: false
          breaking_description:
            description: "(Optional) In case of breaking changes write the details here"
            type: string
            default: ""
      system_instructions: |
        {{ blocks.system_prompt.outputs.content }}
      prompt: |
        {{ blocks.user_prompt.outputs.content }}

  - id: select_message
    type: CreateFile
    description: "Format conventional commit message with breaking change support"
    inputs:
      path: "{{tmp}}/message.txt"
      overwrite: true
      content: |
        {%- if inputs.message -%}
        {{ inputs.message }}
        {%- else -%}
        {%- set resp = blocks.generate_message.response -%}
        {%- set type = resp.type -%}
        {%- set scope = resp.scope | default('') -%}
        {%- set summary = resp.summary -%}
        {%- set is_breaking = resp.is_breaking | default(false) -%}
        {%- set body = resp.body | default('') -%}
        {%- set breaking_desc = resp.breaking_description | default('') -%}
        {%- if scope -%}
        {{ type }}({{ scope }}){% if is_breaking %}!{% endif %}: {{ summary }}
        {%- else -%}
        {{ type }}{% if is_breaking %}!{% endif %}: {{ summary }}
        {%- endif %}
        {%- if is_breaking and breaking_desc %}

        BREAKING CHANGE: {{ breaking_desc }}
        {%- endif %}
        {%- if body %}

        {{ body }}
        {%- endif %}
        {%- endif %}
    condition: "{{blocks.analyze_changes.outputs.has_changes}}"
    depends_on:
      - block: generate_message
        required: false

  - id: confirm_commit
    type: Prompt
    description: "Prompt user for commit confirmation or custom message"
    inputs:
      prompt: |
        About to create commit with message:

        {{blocks.select_message.outputs.content}}

        Options:
        - 'yes' to proceed with this message
        - 'no' to cancel
        - Or type your own commit message
    condition: "{{blocks.analyze_changes.outputs.has_changes and not inputs.auto}}"
    depends_on:
      - select_message

  - id: use_custom_message
    type: CreateFile
    description: "Override message file with user-provided commit message"
    inputs:
      path: "{{tmp}}/message.txt"
      overwrite: true
      content: "{{blocks.confirm_commit.outputs.response}}"
    condition: "{{blocks.confirm_commit.outputs.response | trim | lower not in ['yes', 'no']}}"
    depends_on:
      - confirm_commit

  - id: create_commit
    type: Shell
    description: "Create git commit with semantic message"
    inputs:
      working_dir: "{{inputs.workspace}}"
      command: |
        set -e  # Exit immediately if any command fails
        # Create commit from message file and get hash
        git commit -F "{{tmp}}/message.txt"
        git rev-parse HEAD
    condition: "{{blocks.analyze_changes.outputs.has_changes and (inputs.auto or blocks.confirm_commit.outputs.response | trim | lower != 'no')}}"
    depends_on:
      - block: select_message
        required: true
      - block: confirm_commit
        required: false
      - block: use_custom_message
        required: false
outputs:
  has_changes:
    value: "{{blocks.analyze_changes.outputs.has_changes}}"
    type: bool
  commit_succeeded:
    value: "{{blocks.create_commit.succeeded}}"
    type: bool
  commit_hash:
    value: "{{blocks.create_commit.outputs.stdout}}"
    type: str
