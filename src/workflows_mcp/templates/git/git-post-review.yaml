name: git-post-review
description: |
  Post review comments to the PR/MR (GitHub or GitLab) if conditions are met.

  Receives platform info directly from context-gathering to avoid redundant
  URL parsing. Only parses URL for API-specific details when posting comments.

  Required Permissions:
  - GitHub: 'pull_requests: write' for the GITHUB_TOKEN.
  - GitLab: API access (Reporter role or higher) for GITLAB_TOKEN.
tags: [pr, mr, comment, approval, github, gitlab]
inputs:
  url:
    type: str
    description: |
      Full PR/MR URL for remote review (GitHub or GitLab).
      Empty string for local-only reviews.
    required: false
    default: ""

  github_token:
    type: str
    description: "GitHub Access Token (PAT or App Token)."
    required: false
    default: ""

  platform:
    type: str
    description: "Platform for the PR/MR: 'github', 'gitlab'."
    required: true

  review:
    type: str
    description: "Review to post to the PR/MR."
    required: true

  approve:
    type: bool
    description: Approval decision.
    required: true

blocks:
  - id: parse_url_for_api
    type: Shell
    description: |
      Parse URL to extract API-specific details (owner/repo/number).
      Only runs when we need to post comments to a remote platform.
    condition: "{{ inputs.platform in ['github', 'gitlab'] and inputs.url and inputs.url != '' }}"
    inputs:
      command: |
        python3 << 'PYEOF'
        import re
        import json

        url = '''{{ inputs.url }}'''
        platform = '{{ inputs.platform }}'

        result = {'platform': platform, 'valid': False}

        if platform == 'github':
            # GitHub: https://github.com/owner/repo/pull/123
            match = re.search(r'github\.com/([^/]+)/([^/]+)/pull/(\d+)', url)
            if match:
                result.update({
                    'valid': True,
                    'owner_repo': f'{match.group(1)}/{match.group(2)}',
                    'number': match.group(3)
                })

        elif platform == 'gitlab':
            # GitLab: https://gitlab.com/group/project/-/merge_requests/123
            match = re.search(r'(https?://[^/]+)/(.+?)/-/merge_requests/(\d+)', url)
            if match:
                project_path = match.group(2).replace('/', '%2F')
                result.update({
                    'valid': True,
                    'base_url': match.group(1),
                    'project_path': project_path,
                    'number': match.group(3)
                })

        print(json.dumps(result))
        PYEOF

  - id: post_github_review
    type: HttpCall
    description: Post review comments to GitHub PR via Reviews API.
    depends_on:
      - parse_url_for_api
    condition: >-
      {{ inputs.platform == 'github'
         and (blocks.parse_url_for_api.outputs.stdout | fromjson).valid }}
    inputs:
      url: "https://api.github.com/repos/{{ get(blocks.parse_url_for_api.outputs.stdout, 'owner_repo', '') }}/pulls/{{ get(blocks.parse_url_for_api.outputs.stdout, 'number', '') }}/reviews"
      method: POST
      headers:
        Authorization: "Bearer {{ inputs.github_token | default(secrets.GITHUB_TOKEN) }}"
        Accept: "application/vnd.github+json"
        X-GitHub-Api-Version: "2022-11-28"
      json:
        body: "{{ inputs.review }}"
        event: "{{ 'APPROVE' if inputs.approve else 'REQUEST_CHANGES' }}"

  - id: post_gitlab_review
    type: HttpCall
    description: Post review comments to GitLab MR via Notes API.
    depends_on:
      - parse_url_for_api
    condition: >-
      {{ inputs.platform == 'gitlab'
         and (blocks.parse_url_for_api.outputs.stdout | fromjson).valid }}
    inputs:
      url: "{{ get(blocks.parse_url_for_api.outputs.stdout, 'base_url', '') }}/api/v4/projects/{{ get(blocks.parse_url_for_api.outputs.stdout, 'project_path', '') }}/merge_requests/{{ get(blocks.parse_url_for_api.outputs.stdout, 'number', '') }}/notes"
      method: POST
      headers:
        PRIVATE-TOKEN: "{{ secrets.GITLAB_TOKEN }}"
        Content-Type: "application/json"
      json:
        body: "{{ inputs.review }}"

outputs:
  review:
    value: "{{ inputs.review }}"
    type: str
    description: Review to be returned as output.

  approve:
    value: "{{ inputs.approve }}"
    type: bool
    description: Final approval decision to be returned as output.

  platform:
    value: "{{ inputs.platform }}"
    type: str
    description: "Platform from input: 'github', 'gitlab', or 'local'."

  posted:
    value: >-
      {{ (blocks.post_github_review.succeeded and blocks.post_github_review.outputs.success) or (blocks.post_gitlab_review.succeeded and blocks.post_gitlab_review.outputs.success) }}
    type: bool
    description: "Whether a review was successfully posted."
