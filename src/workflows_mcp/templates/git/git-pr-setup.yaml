name: git-pr-setup
description: |
  Parse a GitHub PR or GitLab MR URL, extract metadata (platform, repo, pr_number),
  compute the correct refspec, and checkout the repository.

  Supports:
  - GitHub PR (Full): https://github.com/owner/repo/pull/123
  - GitHub PR (Short): owner/repo/pull/123
  - GitLab MR: https://gitlab.com/owner/repo/-/merge_requests/123
  - Plain repo URLs: https://github.com/owner/repo
author: Workflows MCP Team
version: "1.0.0"
tags: [git, pr, mr, checkout, github, gitlab]

inputs:
  url:
    type: str
    description: |
      Full PR/MR URL, short form, or repository URL.
      Supported formats:
        - GitHub PR (Full): https://github.com/owner/repo/pull/123
        - GitHub PR (Short): owner/repo/pull/123
        - GitLab MR (Full): https://gitlab.com/owner/repo/-/merge_requests/123
        - Plain repo: https://github.com/owner/repo
    required: true

  token:
    type: str
    description: "Access Token (GitHub PAT/App Token or GitLab Token)."
    required: false
    default: ""

  workspace:
    type: str
    description: Local path where the repository should be cloned.
    required: false
    default: "{{tmp}}/repo"

  dry_run:
    type: bool
    description: "If true, skips the actual git checkout/clone operations. Useful for dry-run/validation."
    required: false
    default: false

blocks:
  - id: parse_url
    type: Shell
    description: Parse the PR/MR/repo URL to extract repository info and PR/MR number.
    inputs:
      command: |
        python3 << 'PYEOF'
        import re
        import json
        import sys

        url = '{{ inputs.url }}'
        result = {
            'platform': 'unknown',
            'repo': '',
            'pr_number': '',
            'base_url': ''
        }

        # Clean validation
        url_clean = url.strip()

        # 1. GitHub Short format: owner/repo/pull/123
        gh_short = re.match(r'^([a-zA-Z0-9_\-\.]+/[a-zA-Z0-9_\-\.]+)/pull/(\d+)$', url_clean)

        # 2. GitHub Full format: https://github.com/owner/repo/pull/123
        gh_full = re.match(r'https://github\.com/([^/]+/[^/]+)/pull/(\d+)', url_clean)

        # 3. GitLab Full format: https://gitlab.com/owner/repo/-/merge_requests/123
        gl_full = re.match(r'https://(?:www\.)?gitlab\.com/([^/]+/[^/]+)/-/merge_requests/(\d+)', url_clean)

        if gh_short:
            result['platform'] = 'github'
            result['repo'] = gh_short.group(1)
            result['pr_number'] = gh_short.group(2)
            result['base_url'] = 'https://github.com'
        elif gh_full:
            result['platform'] = 'github'
            result['repo'] = gh_full.group(1)
            result['pr_number'] = gh_full.group(2)
            result['base_url'] = 'https://github.com'
        elif gl_full:
            result['platform'] = 'gitlab'
            result['repo'] = gl_full.group(1)
            result['pr_number'] = gl_full.group(2)
            result['base_url'] = 'https://gitlab.com'

        # Plain GitHub URL: https://github.com/owner/repo
        elif 'github.com' in url_clean and result['platform'] == 'unknown':
            result['platform'] = 'github'
            result['base_url'] = 'https://github.com'
            clean = url_clean.rstrip('/').replace('.git', '')
            parts = clean.split('github.com/')[-1].split('/')
            if len(parts) >= 2:
                result['repo'] = f'{parts[0]}/{parts[1]}'

        # Output JSON result
        print(json.dumps(result))

        # Also write individual files for outputs
        with open('{{ tmp }}/platform', 'w') as f:
            f.write(result['platform'])
        with open('{{ tmp }}/repo', 'w') as f:
            f.write(result['repo'])
        with open('{{ tmp }}/pr_number', 'w') as f:
            f.write(result['pr_number'])
        with open('{{ tmp }}/base_url', 'w') as f:
            f.write(result['base_url'])

        PYEOF
    outputs:
      platform:
        type: str
        path: "{{tmp}}/platform"
      repo:
        type: str
        path: "{{tmp}}/repo"
      pr_number:
        type: str
        path: "{{tmp}}/pr_number"
      base_url:
        type: str
        path: "{{tmp}}/base_url"

  - id: calculate_refspec
    type: Shell
    description: Determine the ref and fetch_refspec based on platform and PR number.
    depends_on: [parse_url]
    inputs:
      command: |
        PLATFORM="{{ blocks.parse_url.outputs.platform }}"
        PR_NUMBER="{{ blocks.parse_url.outputs.pr_number }}"

        REF=""
        REFSPEC=""

        if [ "$PLATFORM" = "github" ] && [ -n "$PR_NUMBER" ]; then
          REF="pr-$PR_NUMBER"
          REFSPEC="pull/$PR_NUMBER/head:pr-$PR_NUMBER"
        elif [ "$PLATFORM" = "gitlab" ] && [ -n "$PR_NUMBER" ]; then
          REF="mr-$PR_NUMBER"
          REFSPEC="refs/merge-requests/$PR_NUMBER/head:mr-$PR_NUMBER"
        fi

        printf "%s" "$REF" > {{tmp}}/ref
        printf "%s" "$REFSPEC" > {{tmp}}/refspec

        echo "Calculated ref: $REF"
        echo "Calculated refspec: $REFSPEC"
    outputs:
      ref:
        type: str
        path: "{{tmp}}/ref"
      fetch_refspec:
        type: str
        path: "{{tmp}}/refspec"

  - id: setup_repository
    type: Workflow
    description: Clone or fetch the repository using the standard git-checkout workflow.
    depends_on: [calculate_refspec]
    condition: "{{ not (inputs.dry_run | default(false)) }}"
    inputs:
      workflow: git-checkout
      inputs:
        repo: "{{ blocks.parse_url.outputs.repo }}"
        ref: "{{ blocks.calculate_refspec.outputs.ref }}"
        workspace: "{{ inputs.workspace }}"
        clean_mode: skip
        fetch_refspec: "{{ blocks.calculate_refspec.outputs.fetch_refspec }}"
        token: "{{ inputs.token }}"

  - id: get_repo_info
    type: Shell
    description: Get repository information.
    depends_on: [setup_repository]
    condition: "{{ not (inputs.dry_run | default(false)) }}"
    inputs:
      working_dir: "{{ inputs.workspace }}"
      command: |
        BRANCH=$(git branch --show-current || echo "detached")
        COMMIT=$(git rev-parse --short HEAD)

        cat << EOF > {{ tmp }}/repo_info.json
        {
          "branch": "$BRANCH",
          "commit": "$COMMIT",
          "path": "{{ inputs.workspace }}",
          "platform": "{{ blocks.parse_url.outputs.platform }}",
          "repo": "{{ blocks.parse_url.outputs.repo }}"
        }
        EOF

        echo "âœ“ Repository ready: $BRANCH @ $COMMIT"
    outputs:
      info:
        type: dict
        path: "{{tmp}}/repo_info.json"

outputs:
  repo:
    value: "{{ blocks.parse_url.outputs.repo }}"
    type: str
    description: "Repository (owner/repo)."

  repo_info:
    value: "{{ blocks.get_repo_info.outputs.info | default({}) }}"
    type: dict
    description: "Repository information including branch, commit, path, platform, and repo."

  pr_number:
    value: "{{ blocks.parse_url.outputs.pr_number }}"
    type: str
    description: "PR number (empty if not a PR URL)."

  ref:
    value: "{{ blocks.calculate_refspec.outputs.ref }}"
    type: str
    description: "Calculated git ref (e.g., pr-123)."

  fetch_refspec:
    value: "{{ blocks.calculate_refspec.outputs.fetch_refspec }}"
    type: str
    description: "Calculated fetch refspec (e.g., pull/123/head:pr-123)."

  platform:
    value: "{{ blocks.parse_url.outputs.platform }}"
    type: str
    description: "Detected platform: 'github' or 'unknown'."

  workspace:
    value: "{{ inputs.workspace }}"
    type: str
    description: "Path to the repository workspace."
