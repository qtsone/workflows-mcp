name: Test Suite

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run all tests
        run: |
          uv run pytest tests/ -v \
            --cov=workflows_mcp \
            --cov-report=xml \
            --cov-report=term-missing \
            --tb=short

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: tests
          fail_ci_if_error: false

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ruff
        run: |
          uv run ruff check src/workflows_mcp/ tests/
          uv run ruff format --check src/workflows_mcp/ tests/

      - name: Run mypy
        run: uv run mypy src/workflows_mcp/
        continue-on-error: true

  generated-files:
    name: Verify Generated Files
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Regenerate block reference
        run: uv run python scripts/generate_block_reference.py

      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain docs/llm/)" ]; then
            echo "âŒ docs/llm/ files are out of date!"
            echo ""
            echo "Run: uv run python scripts/generate_block_reference.py"
            echo "Then commit the changes."
            echo ""
            echo "Changed files:"
            git diff --stat docs/llm/
            exit 1
          else
            echo "âœ… docs/llm/ files are up to date"
          fi

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [tests, quality, generated-files]
    if: always()

    steps:
      - name: Report results
        run: |
          echo "## ðŸ“Š Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Generated Files | ${{ needs.generated-files.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all jobs passed
          if [ "${{ needs.tests.result }}" == "success" ] && \
             [ "${{ needs.quality.result }}" == "success" ] && \
             [ "${{ needs.generated-files.result }}" == "success" ]; then
            echo "âœ… **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
